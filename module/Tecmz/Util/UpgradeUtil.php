<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Tecmz\Util; use App\Constant\AppConstant; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Artisan; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\ModStart; class UpgradeUtil { const REMOTE_BASE = 'https://www.tecmz.com'; private static function baseRequest($ZFzMa, $XWlC_ = array(), $qtbsi = null) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $ZFzMa, $XWlC_, array('header' => array('api-token' => $qtbsi, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function latest() { goto MVRdj; AfgB0: BizException::throwsIfResponseError($FZUh3); goto sZw8N; sZw8N: return $FZUh3['data']; goto bL5SC; MVRdj: $FZUh3 = self::baseRequest('/api/app/latest', array('app' => AppConstant::APP, 'version' => AppConstant::VERSION)); goto AfgB0; bL5SC: } public static function downloadPackage($qtbsi, $ePJyE, $bJlos, $n0I6W) { goto dX1U9; Vtzhl: $Vm_EI = $FZUh3['data']['packageMd5']; goto omT9p; dTHqF: $xJIso = FileUtil::generateLocalTempPath('zip'); goto WJuxW; g0iSn: BizException::throwsIfResponseError($FZUh3); goto zbyCn; jRyES: $svc7f = FileUtil::generateLocalTempPath('json'); goto FcQcw; FcQcw: file_put_contents($svc7f, $Ou4Th); goto hWjgJ; dX1U9: $FZUh3 = self::baseRequest('/api/app/download_package', array('app' => $ePJyE, 'fromVersion' => $bJlos, 'toVersion' => $n0I6W), $qtbsi); goto g0iSn; omT9p: $Ou4Th = $FZUh3['data']['diffContent']; goto DwCeT; eFV25: BizException::throwsIfEmpty('安装包获取失败', $XWlC_); goto dTHqF; hWjgJ: return Response::generateSuccessData(array('diffContentFile' => $svc7f, 'package' => $xJIso, 'packageSize' => filesize($xJIso))); goto NGP0H; zbyCn: $WJlDi = $FZUh3['data']['package']; goto Vtzhl; AJCD0: BizException::throwsIf('文件MD5校验失败', md5_file($xJIso) != $Vm_EI); goto jRyES; WJuxW: file_put_contents($xJIso, $XWlC_); goto AJCD0; DwCeT: $XWlC_ = CurlUtil::getRaw($WJlDi); goto eFV25; NGP0H: } public static function upgradePackage($WJlDi, $svc7f) { goto iSFnd; KZaqD: BizException::throwsIf('调用 php artisan migrate 失败', 0 != $sZrkl); goto SQf2Z; EWsx1: if (!empty($Ou4Th['update'])) { $x60Fi = array_merge($x60Fi, $Ou4Th['update']); } goto XHO_3; NJcmX: $c8yQj->close(); goto erqz5; AxDiE: if (!empty($Ou4Th['delete'])) { goto lrEMm; lrEMm: $KB0mn[] = '删除文件：'; goto aMb55; qcbSe: $KB0mn[] = ''; goto lnmiH; aMb55: foreach ($Ou4Th['delete'] as $n8fWJ) { if (file_exists($DHPQB = base_path($n8fWJ))) { @unlink($DHPQB); $KB0mn[] = "> {$n8fWJ}"; } } goto qcbSe; lnmiH: } goto NJcmX; XHO_3: $FZUh3 = FileUtil::filePathWritableCheck($x60Fi); goto pqnyB; evB26: return Response::generateSuccessData(array('logs' => $KB0mn)); goto v9r_b; M0mjT: $Ou4Th = @json_decode(file_get_contents($svc7f), true); goto uVm4O; y489A: $c8yQj = new Zipper(); goto fF5z9; y0v2I: $x60Fi = array(); goto OHJfG; muUEn: FileUtil::safeCleanLocalTemp($svc7f); goto evB26; SQf2Z: try { $sZrkl = Artisan::call('modstart:module-install-all'); } catch (\Exception $VPhVw) { $sZrkl = -1; } goto Tktxh; C3gGG: BizException::throwsIf('diffContentFile不存在', !file_exists($svc7f)); goto M0mjT; pqnyB: BizException::throwsIfResponseError($FZUh3); goto y489A; tlb2q: if (!empty($Ou4Th['add'])) { goto vWlym; XEMkb: $KB0mn[] = ''; goto zlXyv; S0z3b: foreach ($Ou4Th['add'] as $n8fWJ) { goto Y53jx; QB8XA: FileUtil::write(base_path($n8fWJ), $n3GvS); goto eRTJW; eRTJW: $KB0mn[] = "> {$n8fWJ}"; goto b8U3Y; Y53jx: $n3GvS = $c8yQj->getFileContent($n8fWJ); goto QB8XA; b8U3Y: } goto XEMkb; vWlym: $KB0mn[] = '新增文件：'; goto S0z3b; zlXyv: } goto JEPX1; fF5z9: $c8yQj->make($WJlDi); goto pJk7p; n2Jn_: try { $sZrkl = Artisan::call('migrate'); } catch (\Exception $VPhVw) { $sZrkl = -1; } goto KZaqD; Tktxh: BizException::throwsIf('调用 php artisan modstart:module-install-all 失败', 0 != $sZrkl); goto OWc9C; JEPX1: if (!empty($Ou4Th['update'])) { goto xBIV1; QdtRK: foreach ($Ou4Th['update'] as $n8fWJ) { goto mLYK_; BdG2d: FileUtil::write(base_path($n8fWJ), $n3GvS); goto vVyEq; vVyEq: $KB0mn[] = "> {$n8fWJ}"; goto vf2ES; mLYK_: $n3GvS = $c8yQj->getFileContent($n8fWJ); goto BdG2d; vf2ES: } goto DzvXo; DzvXo: $KB0mn[] = ''; goto l8zqU; xBIV1: $KB0mn[] = '修改文件：'; goto QdtRK; l8zqU: } goto AxDiE; OHJfG: if (!empty($Ou4Th['add'])) { $x60Fi = array_merge($x60Fi, $Ou4Th['add']); } goto EWsx1; OWc9C: FileUtil::safeCleanLocalTemp($WJlDi); goto muUEn; uVm4O: BizException::throwsIf('diffContent为空', empty($Ou4Th)); goto y0v2I; iSFnd: BizException::throwsIf('package不存在', !file_exists($WJlDi)); goto C3gGG; pJk7p: $KB0mn = array(); goto tlb2q; erqz5: ModStart::clearCache(); goto n2Jn_; v9r_b: } }