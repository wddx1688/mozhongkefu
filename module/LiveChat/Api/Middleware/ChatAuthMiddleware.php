<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\LiveChat\Api\Middleware; use Illuminate\Support\Facades\Session; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use Module\LiveChat\Api\Support\ChatLoginCheck; use Module\LiveChat\Util\ChannelUtil; use Module\LiveChat\Util\UserUtil; class ChatAuthMiddleware { public function handle($Sh3_E, \Closure $JNgx0) { goto HSxaP; JmWmZ: $qzstR = intval(Session::get('liveChatUserId', 0)); goto QywCG; HSxaP: list($HB1O4, $yA25I) = Request::getControllerAction(); goto JmWmZ; JXEKm: UserUtil::processDefault($t9mtn); goto FW6rp; A0zSx: return $JNgx0($Sh3_E); goto ZQJDP; CcGpe: if ($qzstR && !$t9mtn) { $qzstR = 0; Session::forget('liveChatUserId'); } goto xgtAB; KN6XC: if ($qzstR) { $t9mtn = ModelUtil::get('live_chat_user', $qzstR); } goto CcGpe; QywCG: $t9mtn = null; goto KN6XC; oUUnu: Session::flash('_liveChatUser', $t9mtn); goto A0zSx; FW6rp: Session::put('liveChatUserId', $qzstR); goto oUUnu; xgtAB: if (is_subclass_of($HB1O4, ChatLoginCheck::class)) { if (property_exists($HB1O4, 'loginCheckIgnores') && is_array($HB1O4::$loginCheckIgnores) && in_array($yA25I, $HB1O4::$loginCheckIgnores)) { } else { if (empty($t9mtn)) { goto EgbuR; ahou0: $e2zRn = $ErQts->getTrimString('uid'); goto jqJ_O; cFsox: $t9mtn = ModelUtil::get('live_chat_user', array('uid' => $e2zRn)); goto bLUbD; EgbuR: $ErQts = InputPackage::buildFromInput(); goto ahou0; bLUbD: if (empty($t9mtn)) { goto H6MMC; H6MMC: $ybVCD = ChannelUtil::getByAlias($ErQts->getTrimString('channel')); goto p36sB; Y9w0O: $CRCLA = Session::get('_memberUser', null); goto L1wz0; p36sB: $t9mtn = array('uid' => $e2zRn, 'memberUserId' => 0, 'ip' => Request::ip(), 'nickname' => '游客' . date('Ymd_His'), 'channelId' => $ybVCD ? $ybVCD['id'] : 0, 'param' => $ErQts->getTrimString('param')); goto Y9w0O; Rq8VG: $t9mtn = ModelUtil::insert('live_chat_user', $t9mtn); goto CsO1U; L1wz0: if (!empty($CRCLA)) { goto jbQ_D; jbQ_D: $t9mtn['memberUserId'] = $CRCLA['id']; goto juaUi; juaUi: $t9mtn['nickname'] = empty($CRCLA['nickname']) ? $CRCLA['username'] : $CRCLA['nickname']; goto xp862; xp862: $t9mtn['avatar'] = $CRCLA['avatar']; goto Dbr2Z; Dbr2Z: } goto Rq8VG; CsO1U: $qzstR = $t9mtn['id']; goto WfR41; WfR41: } else { $qzstR = $t9mtn['id']; } goto qnfmK; jqJ_O: if (empty($e2zRn) || strlen($e2zRn) < 20) { BizException::throws('uid too short'); } goto cFsox; qnfmK: } } } goto JXEKm; ZQJDP: } }