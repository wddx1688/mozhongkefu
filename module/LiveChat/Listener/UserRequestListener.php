<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\LiveChat\Listener; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use Module\ImServer\Core\Listener\AbstractRequestListener; use Module\ImServer\Core\Message\ChatMsg; use Module\ImServer\Core\Model\ServiceModel; use Module\ImServer\Core\Repository\ServiceRepository; use Module\ImServer\Type\ImRequestType; use Module\ImServer\Type\ImServiceRequestStatus; use Module\ImServer\Type\ImServiceStatus; use Module\LiveChat\Constant\LiveChatConstant; use Module\LiveChat\Util\AccountUtil; class UserRequestListener extends AbstractRequestListener { public function requests() { return array(ImRequestType::ServiceRequest); } public function permit($U1CFU, ChatMsg $miOiF) { return $miOiF->isContextUserBiz(LiveChatConstant::IM_USER_USER); } public function onServiceRequest($U1CFU, ChatMsg $miOiF, InputPackage $dvCKi) { goto Abgo8; WlPpv: $FhRrv = ServiceModel::getMine($FWfay, $t9mtn['id']); goto zgTls; Abgo8: $t9mtn = $miOiF->getContextValue('user'); goto IPn5G; D_UIG: return Response::generateSuccessData($XWlC_); goto HDFsX; IPn5G: $FWfay = $dvCKi->getInteger('serviceId'); goto WlPpv; DRIRy: $XWlC_ = array('status' => ImServiceRequestStatus::OFFLINE); goto agB8U; agB8U: switch ($FhRrv['status']) { case ImServiceStatus::CREATED: goto LuHV3; wq3md: break; goto BMtWp; rNe_g: if ($bWr4T > 0) { goto uwHDR; Z5i10: ServiceRepository::pushQueueToBizUsers(LiveChatConstant::IM_SERVICE_NAME, LiveChatConstant::IM_USER_STAFF, AccountUtil::listOnlineIds()); goto qj4C2; Qzrvo: ServiceModel::updateStatus($FWfay, ImServiceStatus::QUEUE); goto Z5i10; uwHDR: $XWlC_['status'] = ImServiceRequestStatus::QUEUE; goto Qzrvo; qj4C2: } goto wq3md; LuHV3: $bWr4T = AccountUtil::getOnlineCount(); goto rNe_g; BMtWp: case ImServiceStatus::QUEUE: $XWlC_['status'] = ImServiceRequestStatus::QUEUE; break; case ImServiceStatus::PROCESSING: $XWlC_['status'] = ImServiceRequestStatus::PROCESSING; break; case ImServiceStatus::PROCESSED: $XWlC_['status'] = ImServiceRequestStatus::PROCESSED; break; } goto D_UIG; zgTls: if (empty($FhRrv)) { return Response::generateError('Service Is Not Yours'); } goto DRIRy; HDFsX: } }