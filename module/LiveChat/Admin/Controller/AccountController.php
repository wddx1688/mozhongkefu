<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\LiveChat\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Form\Form; use ModStart\Form\Type\FormMode; use ModStart\Grid\Displayer\ItemOperate; use ModStart\Grid\GridFilter; use ModStart\Support\Concern\HasFields; use ModStart\Widget\ButtonLink; use ModStart\Widget\TextDialogRequest; use Module\LiveChat\Type\AccountChatStatus; use Module\LiveChat\Type\AccountStatus; use Module\LiveChat\Util\AccountUtil; class AccountController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $U2qv4) { $U2qv4->init('live_chat_account')->field(function ($U2qv4) { $U2qv4->id('id', 'ID'); $U2qv4->text('username', '用户名')->required()->ruleUnique('live_chat_account'); $U2qv4->text('password', '初始密码')->editable(false)->addable(true)->listable(false)->showable(false)->required()->defaultValue(RandomUtil::lowerString(8)); $U2qv4->text('nickname', '昵称')->help('用于显示在客户界面'); $U2qv4->image('avatar', '头像'); $U2qv4->type('status', '状态')->type(AccountStatus::class); $U2qv4->display('created_at', L('Created At'))->listable(false); $U2qv4->display('updated_at', L('Updated At'))->listable(false); })->gridFilter(function (GridFilter $RryBq) { $RryBq->eq('id', L('ID')); $RryBq->like('username', '用户名'); })->hookItemOperateRendering(function (ItemOperate $nq5BI) { $AVLNU = $nq5BI->item(); $nq5BI->push(TextDialogRequest::primary('重置密码', action('\\' . __CLASS__ . '@resetPassword', array('_id' => $AVLNU->id)))); })->gridOperateAppend(ButtonLink::primary('<i class="iconfont icon-users"></i> 客服工作台', modstart_web_url('live_chat/staff'))->blank(true))->hookSaved(function (Form $yAhCR) { $AVLNU = $yAhCR->item(); switch ($yAhCR->mode()) { case FormMode::ADD: goto si7nP; si7nP: AccountUtil::changePassword($AVLNU->id, $AVLNU->password, null, true); goto iOWJ9; HgUfy: break; goto E2Y12; iOWJ9: AccountUtil::update($AVLNU->id, array('chatStatus' => AccountChatStatus::ONLINE)); goto HgUfy; E2Y12: } })->title('客服账号')->canDelete(false); } public function resetPassword(AdminConfigBuilder $U2qv4) { goto nzgaO; nzgaO: $vWdBd = CRUDUtil::id(); goto axXKR; J9qAC: $U2qv4->useDialog(); goto ihnvO; axXKR: $CRCLA = AccountUtil::get($vWdBd); goto YlBdF; ihnvO: $U2qv4->pageTitle('重置密码'); goto wbNoN; hO2Uk: if (Request::isPost()) { return $U2qv4->formRequest(function (Form $yAhCR) use($CRCLA) { AdminPermission::demoCheck(); $XWlC_ = $yAhCR->dataForming(); $FZUh3 = AccountUtil::changePassword($CRCLA['id'], $XWlC_['passwordNew'], null, true); BizException::throwsIfResponseError($FZUh3); return Response::redirect(CRUDUtil::jsDialogClose()); }); } goto nw5pt; wbNoN: $U2qv4->text('passwordNew', '新密码')->required()->defaultValue(RandomUtil::upperString(6)); goto hO2Uk; nw5pt: return $U2qv4; goto rJR0X; YlBdF: BizException::throwsIfEmpty('用户不存在', $CRCLA); goto J9qAC; rJR0X: } }