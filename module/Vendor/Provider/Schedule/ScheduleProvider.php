<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\Provider\Schedule; use Illuminate\Console\Scheduling\Schedule; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Core\Util\StrUtil; use ModStart\Core\Util\TimeUtil; class ScheduleProvider { private static $instances = array(); public static function register($yHanX) { self::$instances[] = $yHanX; } public static function all() { foreach (self::$instances as $U8G_W => $gghxW) { if ($gghxW instanceof \Closure) { self::$instances[$U8G_W] = call_user_func($gghxW); } else { if (is_string($gghxW)) { self::$instances[$U8G_W] = app($gghxW); } } } return self::$instances; } public static function callByName($rfBQu) { foreach (ScheduleBiz::all() as $yHanX) { if ($yHanX->name() == $rfBQu) { call_user_func(array($yHanX, 'run')); } } } public static function call(Schedule $xbnqe) { goto rp6dM; OpRM2: foreach (ScheduleBiz::all() as $yHanX) { $xbnqe->call(function () use($yHanX, &$WYqZK) { $XWlC_ = array(); $XWlC_['name'] = get_class($yHanX); $XWlC_['startTime'] = date('Y-m-d H:i:s'); $XWlC_['status'] = RunStatus::RUNNING; $XWlC_ = ModelUtil::insert('schedule_run', $XWlC_); $vrmPD = $XWlC_['id']; $XWlC_ = array(); try { goto Mli4G; IKjfV: $XWlC_['result'] = StrUtil::mbLimit($FEjaa, 200); goto r50Ws; r50Ws: $XWlC_['status'] = RunStatus::SUCCESS; goto wPPAz; Mli4G: $FEjaa = call_user_func(array($yHanX, 'run')); goto IKjfV; wPPAz: } catch (\Exception $VPhVw) { $XWlC_['result'] = StrUtil::mbLimit($VPhVw->getMessage(), 200); $XWlC_['status'] = RunStatus::FAILED; } $XWlC_['endTime'] = date('Y-m-d H:i:s'); ModelUtil::update('schedule_run', $vrmPD, $XWlC_); if ($WYqZK) { $WYqZK = false; if (RandomUtil::percent(10)) { ModelUtil::model('schedule_run')->where('created_at', '<', date('Y-m-d H:i:s', time() - TimeUtil::PERIOD_DAY * 7))->delete(); } } })->cron($yHanX->cron()); } goto zryxS; rp6dM: if (!isset($_SERVER['argv'][1]) || $_SERVER['argv'][1] != 'schedule:run') { return; } goto i8_AT; i8_AT: $WYqZK = true; goto OpRM2; zryxS: } }