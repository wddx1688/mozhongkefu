<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\Provider\ContentVerify; use Illuminate\Support\Str; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Input\Response; use ModStart\Core\Util\HtmlUtil; use ModStart\Form\Form; use Module\Vendor\Provider\CensorImage\CensorImageProvider; use Module\Vendor\Provider\CensorText\CensorTextProvider; use Module\Vendor\Provider\Notifier\NotifierProvider; abstract class AbstractContentVerifyProvider { public abstract function name(); public abstract function title(); public function verifyAutoProcess($uZEpM) { return false; } public abstract function verifyCount(); public abstract function verifyRule(); public function useFormVerify() { return false; } public function buildForm(Form $yAhCR, $uZEpM) { return null; } public function verifyUrl() { return action($this->verifyRule()); } public function verifyAutoProcessedNotify() { return true; } public function run($uZEpM, $xy3eh = null, $e8PBh = null) { goto ijEzM; QEhRp: $d_iEV = HtmlUtil::text($d_iEV); goto y4NFa; QPij6: if ($this->verifyAutoProcess($uZEpM)) { if ($this->verifyAutoProcessedNotify()) { NotifierProvider::notify($this->name(), '[自动审核]' . $d_iEV, $e8PBh, $uZEpM); } return; } goto B83v6; y4NFa: $d_iEV = $this->title() . ($d_iEV ? '(' . $d_iEV . ')' : ''); goto QPij6; ijEzM: if (null === $e8PBh) { $e8PBh = array('内容' => $xy3eh); $d_iEV = Str::substr(HtmlUtil::text2html($xy3eh), 0, 100); } else { $d_iEV = $xy3eh; } goto QEhRp; B83v6: NotifierProvider::notifyNoneLoginOperateProcessUrl($this->name(), '[审核]' . $d_iEV, $e8PBh, $this->useFormVerify() ? 'content_verify/' . $this->name() : null, $uZEpM); goto nSioD; nSioD: } protected function parseRichHtml($n3GvS) { goto DofdM; aEXz1: $nfPCQ = array(); goto jO_Je; DofdM: $FZUh3 = HtmlUtil::extractTextAndImages($n3GvS); goto aEXz1; jO_Je: $me7IX = $FZUh3['text']; goto oCT0x; WOVhW: return array($me7IX, $nfPCQ); goto Nf_72; oCT0x: foreach ($FZUh3['images'] as $oR9zy) { $nfPCQ[] = AssetsUtil::fixFull($oR9zy); } goto WOVhW; Nf_72: } protected function censorRichHtmlSuccess($z5EdT, $n3GvS) { goto QA3tL; q8_ZM: if (!empty($nfPCQ)) { $yHanX = CensorImageProvider::get(modstart_config($z5EdT . '_Image', 'default')); if ($yHanX) { foreach ($nfPCQ as $oR9zy) { goto Sn9he; APup6: if (!$FZUh3['data']['pass']) { return false; } goto zaUW8; Sn9he: $FZUh3 = $yHanX->verify($oR9zy); goto d7Tlb; d7Tlb: if (Response::isError($FZUh3)) { return false; } goto APup6; zaUW8: } } } goto WeEee; QA3tL: list($me7IX, $nfPCQ) = $this->parseRichHtml($n3GvS); goto F0VTJ; WeEee: return true; goto u9TGu; F0VTJ: if (!empty($me7IX)) { $yHanX = CensorTextProvider::get(modstart_config($z5EdT . '_Text', 'default')); if ($yHanX) { goto KitIy; zncBV: if (!$FZUh3['data']['pass']) { return false; } goto d5wZ9; vXPgr: if (Response::isError($FZUh3)) { return false; } goto zncBV; KitIy: $FZUh3 = $yHanX->verify($me7IX); goto vXPgr; d5wZ9: } } goto q8_ZM; u9TGu: } }