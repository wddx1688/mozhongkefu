<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\Provider\ContentVerify; use Illuminate\Support\Str; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Input\Response; use ModStart\Core\Util\HtmlUtil; use ModStart\Form\Form; use Module\Vendor\Provider\CensorImage\CensorImageProvider; use Module\Vendor\Provider\CensorText\CensorTextProvider; use Module\Vendor\Provider\Notifier\NotifierProvider; abstract class AbstractContentVerifyBiz { public abstract function name(); public abstract function title(); public function verifyAutoProcess($uZEpM) { return false; } public abstract function verifyCount(); public abstract function verifyRule(); public function useFormVerify() { return false; } public function buildForm(Form $yAhCR, $uZEpM) { return null; } public function verifyUrl() { return action($this->verifyRule()); } public function verifyAutoProcessedNotify() { return true; } public function run($uZEpM, $xy3eh = null, $e8PBh = null) { goto l0oap; l0oap: if (null === $e8PBh) { $e8PBh = array('内容' => $xy3eh); $d_iEV = Str::substr(HtmlUtil::text2html($xy3eh), 0, 100); } else { $d_iEV = $xy3eh; } goto rZC17; fEuGw: if ($this->verifyAutoProcess($uZEpM)) { if ($this->verifyAutoProcessedNotify()) { NotifierProvider::notify($this->name(), '[自动审核]' . $d_iEV, $e8PBh, $uZEpM); } return; } goto AcNY_; w9M5b: $d_iEV = $this->title() . ($d_iEV ? '(' . $d_iEV . ')' : ''); goto fEuGw; rZC17: $d_iEV = HtmlUtil::text($d_iEV); goto w9M5b; AcNY_: NotifierProvider::notifyNoneLoginOperateProcessUrl($this->name(), '[审核]' . $d_iEV, $e8PBh, $this->useFormVerify() ? 'content_verify/' . $this->name() : null, $uZEpM); goto u8DZf; u8DZf: } protected function parseRichHtml($n3GvS) { goto EmKFq; EmKFq: $FZUh3 = HtmlUtil::extractTextAndImages($n3GvS); goto yxptu; yxptu: $nfPCQ = array(); goto Fz472; dR_3x: foreach ($FZUh3['images'] as $oR9zy) { $nfPCQ[] = AssetsUtil::fixFull($oR9zy); } goto luAsO; Fz472: $me7IX = $FZUh3['text']; goto dR_3x; luAsO: return array($me7IX, $nfPCQ); goto kzBfo; kzBfo: } protected function censorRichHtmlSuccess($z5EdT, $n3GvS) { goto QK0Be; oRFva: return true; goto TI3HY; omYGs: if (!empty($me7IX)) { $yHanX = CensorTextProvider::get(modstart_config($z5EdT . '_Text', 'default')); if ($yHanX) { goto W8DOf; EUxL3: if (!$FZUh3['data']['pass']) { return false; } goto C4k5t; W8DOf: $FZUh3 = $yHanX->verify($me7IX); goto iil2u; iil2u: if (Response::isError($FZUh3)) { return false; } goto EUxL3; C4k5t: } } goto jmGKC; QK0Be: list($me7IX, $nfPCQ) = $this->parseRichHtml($n3GvS); goto omYGs; jmGKC: if (!empty($nfPCQ)) { $yHanX = CensorImageProvider::get(modstart_config($z5EdT . '_Image', 'default')); if ($yHanX) { foreach ($nfPCQ as $oR9zy) { goto VS0qY; fD7ND: if (!$FZUh3['data']['pass']) { return false; } goto X4w9Z; VS0qY: $FZUh3 = $yHanX->verify($oR9zy); goto j4J34; j4J34: if (Response::isError($FZUh3)) { return false; } goto fD7ND; X4w9Z: } } } goto oRFva; TI3HY: } }