<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\QuickRun\Export; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; class ExportHandle { private $data = array('pageTitle' => '导出数据', 'defaultExportName' => 'Export', 'headTitles' => array(), 'customHeadTitle' => false); private $fetchCallback; public function withPageTitle($pqelM) { $this->data['pageTitle'] = $pqelM; return $this; } public function withDefaultExportName($gQgjL) { $this->data['defaultExportName'] = $gQgjL; return $this; } public function withHeadTitles($tExQ8) { $this->data['headTitles'] = $tExQ8; return $this; } public function withCustomHeadTitle($qbjRx) { $this->data['customHeadTitle'] = $qbjRx; return $this; } public function handleFetch($oZLCv) { $this->fetchCallback = $oZLCv; return $this; } public function performExcel() { return $this->perform('xlsx', 'excel'); } public function performCsv() { return $this->perform('xlsx', 'csv'); } public function performCommon($uZEpM = array()) { return $this->perform(null, 'common', $uZEpM); } private function perform($CYQvS, $tURZC, $uZEpM = array()) { goto yTGi2; HMjNW: $YBEmG = $ErQts->getJsonAsInput('_param')->getArray('search'); goto sjpEl; yTGi2: if (null === $CYQvS) { $CYQvS = 'xlsx'; } goto zFGdr; s1LZA: $pqelM = $this->data['pageTitle']; goto dxCrr; iccBQ: $w_0sB = $ErQts->getTrimString('format', $CYQvS); goto KFxmb; sjpEl: $fcXf7 = $ErQts->getTrimString('exportName', $gQgjL); goto iccBQ; nLL6r: $bPzSn = $this->data['customHeadTitle']; goto gfEQS; dxCrr: $gQgjL = $this->data['defaultExportName']; goto HIMWF; h2cAB: $ZkvUG = $ErQts->getPage(); goto s6tRp; s6tRp: $PP9UF = $ErQts->getPageSize(null, null, null, 100); goto HMjNW; KFxmb: $vmBZQ = $ErQts->getJson('checkedHeadTitles'); goto ZTMwa; ZTMwa: if (Request::isPost()) { goto bgMnQ; Gz3UM: if ($bPzSn) { goto TmcLR; TmcLR: $ZqYpj = array(); goto oyDs0; Pc4Wy: foreach ($this->data['headTitles'] as $k8Rwr => $gghxW) { if (in_array($k8Rwr, $vmBZQ)) { $RYM_k[] = $gghxW; } } goto HoJe3; oyDs0: foreach ($NmpUA['list'] as $gghxW) { goto dO0An; QPVs6: $ZqYpj[] = $Fay2L; goto aJTfi; yUesG: foreach ($gghxW as $AQ5S6 => $rPCA8) { if (in_array($AQ5S6, $vmBZQ)) { $Fay2L[] = $rPCA8; } } goto QPVs6; dO0An: $Fay2L = array(); goto yUesG; aJTfi: } goto Rlyl7; Rlyl7: $RYM_k = array(); goto Pc4Wy; HoJe3: } else { $ZqYpj = $NmpUA['list']; $RYM_k = $this->data['headTitles']; } goto P8W6v; Mj8BR: $XWlC_['exportName'] = $fcXf7 . '.' . $w_0sB; goto jdhuH; jdhuH: $XWlC_['exportHeadTitles'] = $RYM_k; goto f1rw_; g6b6v: $NmpUA = call_user_func_array($this->fetchCallback, array($ZkvUG, $PP9UF, $YBEmG, array())); goto Gz3UM; bgMnQ: BizException::throwsIfEmpty('导出文件名为空', $fcXf7); goto nIsnO; KGMns: $XWlC_['code'] = 0; goto oNSdt; Fm8_m: $XWlC_['finished'] = count($NmpUA['list']) != $PP9UF; goto Mj8BR; nvlBv: $XWlC_['total'] = $NmpUA['total']; goto Fm8_m; f1rw_: return Response::generateSuccessData($XWlC_); goto IWmcw; nIsnO: BizException::throwsIfEmpty('请选择导出列', $vmBZQ); goto g6b6v; oNSdt: $XWlC_['list'] = $ZqYpj; goto nvlBv; P8W6v: $XWlC_ = array(); goto KGMns; IWmcw: } goto GXuIM; GXuIM: $NmpUA = call_user_func_array($this->fetchCallback, array(1, 1, $YBEmG, array())); goto r8ndl; gfEQS: $ErQts = InputPackage::buildFromInput(); goto h2cAB; HIMWF: $tExQ8 = $this->data['headTitles']; goto nLL6r; r8ndl: return view('module::Vendor.View.quickRun.export.' . $tURZC, array('pageTitle' => $pqelM, 'exportName' => $fcXf7, 'total' => $NmpUA['total'], 'formats' => $uZEpM['formats'], 'customHeadTitle' => $bPzSn, 'headTitles' => $tExQ8)); goto yYsCf; zFGdr: if (!isset($uZEpM['formats'])) { $uZEpM['formats'] = array('xlsx', 'csv'); } goto s1LZA; yYsCf: } }