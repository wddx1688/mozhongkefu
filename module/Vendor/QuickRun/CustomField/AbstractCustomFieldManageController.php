<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\QuickRun\CustomField; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Layout\AdminPage; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\SerializeUtil; use ModStart\Form\Form; use ModStart\Grid\Grid; abstract class AbstractCustomFieldManageController extends Controller { protected abstract function config(); public function index(AdminPage $ZkvUG) { goto ln5Ga; qsq0U: $qCqqU->canSort(true)->defaultOrder(array('sort', 'asc')); goto GLe7z; GLe7z: $qCqqU->canAdd(true)->urlAdd(action($ts2Yv['class'] . '@edit')); goto rSUcb; dRfGY: return $ZkvUG->pageTitle($ts2Yv['title'])->body($qCqqU)->handleGrid($qCqqU); goto xGYnv; xRYYR: $qCqqU->text('name', '标识'); goto MY5B9; C5gBb: $qCqqU = Grid::make($ts2Yv['tableField']); goto YI59j; rSUcb: $qCqqU->canEdit(true)->urlEdit(action($ts2Yv['class'] . '@edit')); goto dhiBi; YI59j: $qCqqU->text('title', '名称'); goto xRYYR; dhiBi: $qCqqU->canDelete(true)->urlDelete(action($ts2Yv['class'] . '@delete')); goto bnbKu; ln5Ga: $ts2Yv = $this->config(); goto C5gBb; bnbKu: $qCqqU->canSort(true)->urlSort(action($ts2Yv['class'] . '@sort')); goto dRfGY; MY5B9: $qCqqU->switch('enable', '启用')->optionsYesNo(); goto qsq0U; xGYnv: } public function add() { return $this->edit(); } public function edit() { goto b9dnt; RXCnX: if (Request::isPost()) { goto hP6RA; KHrHK: $ErQts = InputPackage::buildFromInputJson('data'); goto GZdBw; j8meF: switch ($XWlC_['fieldType']) { case CustomFieldType::RADIO: case CustomFieldType::SELECT: case CustomFieldType::CHECKBOX: goto YeRiV; KiUgx: break; goto SzbgJ; GLHu8: $XWlC_['fieldData']['options'] = array_filter(array_map(function ($gghxW) { return trim($gghxW); }, $XWlC_['fieldData']['options'])); goto Kms1k; YeRiV: BizException::throwsIf('选项为空', empty($XWlC_['fieldData']['options'])); goto GLHu8; Kms1k: BizException::throwsIf('选项为空', empty($XWlC_['fieldData']['options'])); goto KiUgx; SzbgJ: } goto rLapr; nWzKb: $XWlC_['title'] = $ErQts->getTrimString('title'); goto Y8AfS; TQvIq: CustomFieldUtil::clearCache($ts2Yv['tableField']); goto Ph6RH; CkDGz: $XWlC_['maxLength'] = $ErQts->getInteger('maxLength'); goto jqy5N; rLapr: switch ($XWlC_['fieldType']) { case CustomFieldType::TEXT: case CustomFieldType::TEXTAREA: case CustomFieldType::RADIO: case CustomFieldType::SELECT: case CustomFieldType::CHECKBOX: BizException::throwsIf('字段长度错误', $XWlC_['maxLength'] < 1 || $XWlC_['maxLength'] > 65535); break; case CustomFieldType::IMAGE: case CustomFieldType::FILE: $XWlC_['maxLength'] = 200; break; case CustomFieldType::IMAGES: $XWlC_['maxLength'] = 1000; break; } goto P3pTi; I7MT2: if ($ts2Yv['tableFieldPrefix']) { $XWlC_['name'] = $ts2Yv['tableFieldPrefix'] . $XWlC_['name']; } goto py93D; w0uqi: $XWlC_['enable'] = $ErQts->getBoolean('enable'); goto eWBsj; NSFIv: BizException::throwsIfEmpty('标识为空', $XWlC_['name']); goto I7MT2; dzLyV: BizException::throwsIf('标识不能为系统关键字段', in_array($XWlC_['name'], array('id', 'created_at', 'updated_at'))); goto m0ocL; CbMuR: if ($vWdBd) { ModelUtil::update($ts2Yv['tableField'], $vWdBd, $XWlC_); CustomFieldUtil::editField($ts2Yv['tableData'], $He0J8, $XWlC_); } else { goto khRoB; hJ6kj: $XWlC_ = ModelUtil::insert($ts2Yv['tableField'], $XWlC_); goto nb_xn; nb_xn: CustomFieldUtil::addField($ts2Yv['tableData'], $XWlC_); goto sWKhi; khRoB: $XWlC_['sort'] = ModelUtil::sortNext($ts2Yv['tableField']); goto hJ6kj; sWKhi: } goto n5C0L; RPtdG: $XWlC_['fieldData'] = $ErQts->getArray('fieldData'); goto RrUtk; Y8AfS: $XWlC_['name'] = $ErQts->getTrimString('name'); goto w0uqi; eWBsj: $XWlC_['fieldType'] = $ErQts->getType('fieldType', CustomFieldType::class); goto RPtdG; i02qV: $XWlC_['isList'] = $ErQts->getBoolean('isList'); goto qHxUK; RrUtk: $XWlC_['isRequired'] = $ErQts->getBoolean('isRequired'); goto wGntt; EBDmk: BizException::throwsIfEmpty('字段类型为空', $XWlC_['fieldType']); goto j8meF; P3pTi: $XWlC_['fieldData'] = SerializeUtil::jsonEncode($XWlC_['fieldData']); goto HndP1; HndP1: ModelUtil::transactionBegin(); goto CbMuR; m0ocL: $rxPWH = ModelUtil::isFieldUniqueForInsertOrUpdate($ts2Yv['tableField'], $vWdBd, 'name', $XWlC_['name']); goto XNcwB; py93D: BizException::throwsIf('标识格式不正确', !preg_match('/^[a-zA-Z][a-zA-Z0-9_]*$/', $XWlC_['name'])); goto dzLyV; Ph6RH: return Response::generateSuccess(); goto ghLbp; qHxUK: $XWlC_['placeholder'] = $ErQts->getTrimString('placeholder'); goto CkDGz; Gd25D: BizException::throwsIf('标识长度范围1-50', strlen($XWlC_['name']) < 1 || strlen($XWlC_['name']) > 50); goto EBDmk; XNcwB: BizException::throwsIf('标识重复', !$rxPWH); goto Gd25D; GZdBw: $XWlC_ = array(); goto nWzKb; jqy5N: BizException::throwsIfEmpty('标题为空', $XWlC_['title']); goto NSFIv; n5C0L: ModelUtil::transactionCommit(); goto TQvIq; hP6RA: AdminPermission::demoCheck(); goto KHrHK; wGntt: $XWlC_['isSearch'] = $ErQts->getBoolean('isSearch'); goto i02qV; ghLbp: } goto n71GM; XAZoA: $He0J8 = array('title' => '', 'name' => '', 'enable' => true, 'fieldType' => 'text', 'fieldData' => new \stdClass(), 'isRequired' => true, 'isSearch' => true, 'isList' => true, 'placeholder' => '', 'maxLength' => 100); goto jUY4b; vrFrP: return view('module::Vendor.View.quickRun.customField.edit', array('fieldNamePrefix' => $ts2Yv['tableFieldPrefix'], 'record' => $He0J8)); goto OraMp; n71GM: if ($He0J8['name'] && $ts2Yv['tableFieldPrefix']) { $He0J8['name'] = substr($He0J8['name'], strlen($ts2Yv['tableFieldPrefix'])); } goto vrFrP; b9dnt: $ts2Yv = $this->config(); goto HeDgz; HeDgz: $vWdBd = CRUDUtil::id(); goto XAZoA; jUY4b: if ($vWdBd) { goto lXOcV; IKqsQ: ModelUtil::decodeRecordBoolean($He0J8, array('enable', 'isRequired', 'isSearch', 'isList')); goto NET00; lXOcV: $He0J8 = ModelUtil::get($ts2Yv['tableField'], $vWdBd); goto oLbRT; DzfcJ: ModelUtil::decodeRecordJson($He0J8, array('fieldData')); goto IKqsQ; oLbRT: BizException::throwsIfEmpty('记录不存在', $He0J8); goto DzfcJ; NET00: } goto RXCnX; OraMp: } public function delete() { goto fMs_y; EQj01: $vWdBd = CRUDUtil::id(); goto GG2aT; IkQzT: AdminPermission::demoCheck(); goto EQj01; WT2UL: CustomFieldUtil::clearCache($ts2Yv['tableField']); goto DKk1h; GG2aT: $He0J8 = ModelUtil::get($ts2Yv['tableField'], $vWdBd); goto Q9mkJ; VEoqy: ModelUtil::transactionCommit(); goto WT2UL; T_BJH: CustomFieldUtil::deleteField($ts2Yv['tableData'], $He0J8); goto xxIn4; DKk1h: return Response::generateSuccess(); goto M93bN; xxIn4: ModelUtil::delete($ts2Yv['tableField'], $vWdBd); goto VEoqy; Q9mkJ: BizException::throwsIfEmpty('记录不存在', $He0J8); goto qFdt0; fMs_y: $ts2Yv = $this->config(); goto IkQzT; qFdt0: ModelUtil::transactionBegin(); goto T_BJH; M93bN: } public function sort() { goto r2SV3; qgo8R: $yAhCR = Form::make($ts2Yv['tableField']); goto RTTa8; RTTa8: $yAhCR->canSort(true); goto yBq9V; wUrct: $ts2Yv = $this->config(); goto qgo8R; yBq9V: return $yAhCR->sortRequest(CRUDUtil::id()); goto G0UB1; r2SV3: AdminPermission::demoCheck(); goto wUrct; G0UB1: } }