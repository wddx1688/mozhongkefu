<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Site\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Admin\Layout\AdminDialogPage; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\SerializeUtil; use ModStart\Form\Form; use ModStart\ModStart; use ModStart\Support\Concern\HasFields; use Module\Vendor\Provider\SiteTemplate\SiteTemplateProvider; class ConfigController extends Controller { public static $PermitMethodMap = array('config' => 'setting'); public function config(AdminDialogPage $ZkvUG) { goto c5Kqj; kuQA4: $yAhCR->fields()->each(function ($E9h4W) use(&$ts2Yv, &$XWlC_) { if ($ts2Yv->has($E9h4W->name())) { $XWlC_[$E9h4W->name()] = $ts2Yv->get($E9h4W->name()); } else { $XWlC_[$E9h4W->name()] = null; } }); goto vCl1s; R5Qyk: $yAhCR->showSubmit(false)->showReset(false); goto QJBUy; YQhkQ: $XWlC_ = array(); goto kuQA4; mZ4oZ: $yAhCR = Form::make(''); goto Nbqrj; QJBUy: return $ZkvUG->pageTitle('主题设置')->body($yAhCR)->handleForm($yAhCR, function (Form $yAhCR) { AdminPermission::demoCheck(); $ts2Yv = modstart_config(); foreach ($yAhCR->dataForming() as $U8G_W => $gghxW) { $ts2Yv->set($U8G_W, $gghxW); } return Response::redirect(CRUDUtil::jsDialogClose()); }); goto muHFG; nnzoM: BizException::throwsIfEmpty('请选择主题', $mPYOc); goto lOR_0; Nbqrj: $yHanX->config($yAhCR); goto s19rM; oe4Zl: BizException::throwsIfEmpty('主题不存在', $yHanX); goto mZ4oZ; lOR_0: $yHanX = SiteTemplateProvider::get($mPYOc); goto oe4Zl; s19rM: $ts2Yv = modstart_config(); goto YQhkQ; c5Kqj: $ErQts = InputPackage::buildFromInput(); goto pw3vh; vCl1s: $yAhCR->item($XWlC_)->fillFields(); goto R5Qyk; pw3vh: $mPYOc = $ErQts->getTrimString('template'); goto nnzoM; muHFG: } public function setting(AdminConfigBuilder $U2qv4) { goto EXj5a; FErgC: $U2qv4->showReset(false)->showSubmit(false); goto IEORQ; ppEMh: $U2qv4->layoutPanel('主题设置', function ($U2qv4) { $U2qv4->color('sitePrimaryColor', '网站主色调'); $U2qv4->select('siteTemplate', '网站主题')->options(SiteTemplateProvider::map())->help('<a href=\'javascript:;\' id=\'siteTemplateConfig\'><i class=\'iconfont icon-cog\'></i> 主题设置</a>'); $njxqq = array(); foreach (SiteTemplateProvider::all() as $yHanX) { $njxqq[$yHanX->name()] = array('hasConfig' => $yHanX->hasConfig()); } $njxqq = SerializeUtil::jsonEncodeObject($njxqq); $COkYB = modstart_admin_url('site/config/config'); $otmnI = "var templates = {$njxqq};\nvar checkTemplate = function () {\n    var template = \$('[name=siteTemplate]').val();\n    \$('#siteTemplateConfig').attr('data-dialog-request', '{$COkYB}?template=' + template);\n    if (templates[template].hasConfig) {\n        \$('#siteTemplateConfig').show();\n    } else {\n        \$('#siteTemplateConfig').hide();\n    }\n};\n\$('[name=siteTemplate]').change(checkTemplate);\ncheckTemplate();"; ModStart::script($otmnI); }); goto QpsPj; Yol6Y: $U2qv4->contentFixedBottomContentSave(); goto r0fSN; r0fSN: $U2qv4->disableBoxWrap(true); goto FErgC; lDBhH: $U2qv4->layoutPanel('其他配置', function ($U2qv4) { $U2qv4->complexFieldsList('Site_PublicInternalUrlMap', '存储节流映射')->fields(array(array('name' => 'public', 'title' => '外网地址', 'type' => 'text', 'defaultValue' => '', 'placeholder' => 'https://public.example.com', 'tip' => ''), array('name' => 'internal', 'title' => '内网地址', 'type' => 'text', 'defaultValue' => '', 'placeholder' => 'https://internal.example.com', 'tip' => '')))->help('在使用第三方存储时，程序拉取外网地址会造成流量浪费，使用此功能可将外网地址映射为内网地址，节省流量'); }); goto Yol6Y; Pd6K_: $U2qv4->layoutPanel('网站信息', function ($U2qv4) { $U2qv4->image('siteLogo', '网站Logo'); $U2qv4->text('siteName', '网站名称'); $U2qv4->text('siteSlogan', '网站副标题'); $U2qv4->text('siteDomain', '网站域名')->help('如 example.com'); $U2qv4->text('siteUrl', '网站地址')->help('如 https://example.com 主要用于后台任务地址转换')->ruleRegex('/^https?:\\/\\/.+/'); $U2qv4->text('siteKeywords', '网站关键词'); $U2qv4->textarea('siteDescription', '网站描述'); $U2qv4->image('siteFavIco', '网站ICO'); }); goto ppEMh; U13u5: $U2qv4->layoutPanel('联系信息', function ($U2qv4) { $U2qv4->text('Site_ContactEmail', '邮箱'); $U2qv4->text('Site_ContactPhone', '电话'); $U2qv4->text('Site_ContactAddress', '地址'); $U2qv4->image('Site_ContactQrcode', '联系二维码')->help('可传带二维码的公众号/微信/QQ等，方便用户扫码联系'); }); goto lDBhH; QpsPj: $U2qv4->layoutPanel('备案信息', function ($U2qv4) { $U2qv4->text('siteBeian', 'ICP备案编号'); $U2qv4->text('siteBeianGonganText', '公安备案文字'); $U2qv4->text('siteBeianGonganLink', '公安备案链接'); $U2qv4->textarea('Site_CopyrightOthers', '其他备案信息')->help('支持HTML'); }); goto U13u5; EXj5a: $U2qv4->pageTitle('基本设置'); goto Pd6K_; IEORQ: return $U2qv4->perform(); goto ASRSF; ASRSF: } }