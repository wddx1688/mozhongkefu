<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ModuleStore\Util; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Cache; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\SerializeUtil; use ModStart\Core\Util\VersionUtil; use ModStart\ModStart; use ModStart\Module\ModuleManager; class ModuleStoreUtil { const REMOTE_BASE = 'https://modstart.com'; public static function remoteModuleData() { goto y5sn1; csfgP: return Cache::remember('ModuleStore_Modules:' . $tJ6XI, 60, function () use($sM_HX) { $ePJyE = 'cms'; if (class_exists('\\App\\Constant\\AppConstant')) { $ePJyE = \App\Constant\AppConstant::APP; } $FZUh3 = CurlUtil::getJSONData(self::REMOTE_BASE . '/api/store/module', array('app' => $ePJyE, 'api_token' => $sM_HX)); return $FZUh3; }); goto M5RbY; FvEE_: $tJ6XI = $ErQts->getInteger('memberUserId'); goto wGQjP; y5sn1: $ErQts = InputPackage::buildFromInput(); goto FvEE_; wGQjP: $sM_HX = $ErQts->getTrimString('apiToken'); goto csfgP; M5RbY: } public static function all() { goto kJSqV; kJSqV: $Rspph = array('disable' => config('env.MS_MODULE_STORE_DISABLE', false)); goto dCHNk; Db9E1: if (!empty($FEjaa['data']['types'])) { $YZXT9 = $FEjaa['data']['types']; } goto hQ3Rw; qanUS: if (!empty($FEjaa['data']['categories'])) { $WcJl3 = $FEjaa['data']['categories']; } goto v3mOs; dbNQ1: if (!empty($FEjaa['data']['modules'])) { foreach ($FEjaa['data']['modules'] as $vp2_j) { goto UXUvH; D_zoz: $vp2_j['_isSystem'] = false; goto QBG0H; qsRxE: $vp2_j['_isEnabled'] = false; goto WlWGn; UXUvH: $vp2_j['_isLocal'] = false; goto QCvlD; WlWGn: $vp2_j['_localVersion'] = null; goto D_zoz; QBG0H: $vp2_j['_hasConfig'] = false; goto VJeEZ; VJeEZ: $f6JWK[$vp2_j['name']] = $vp2_j; goto G5W1a; QCvlD: $vp2_j['_isInstalled'] = false; goto qsRxE; G5W1a: } } goto gRyLy; AeJdn: $WcJl3 = array(); goto qanUS; nXwFU: return array('storeConfig' => $Rspph, 'categories' => $WcJl3, 'types' => $YZXT9, 'modules' => array_values($f6JWK)); goto S6Fkf; gRyLy: foreach (ModuleManager::listModules() as $E1j2M => $ts2Yv) { $hEapL = ModuleManager::getModuleBasic($E1j2M); if (isset($f6JWK[$E1j2M])) { goto Wqw2k; MCm7d: $f6JWK[$E1j2M]['_hasConfig'] = !empty($hEapL['config']); goto cGkRV; hqzoO: $f6JWK[$E1j2M]['_isSystem'] = $ts2Yv['isSystem']; goto MCm7d; Wqw2k: $f6JWK[$E1j2M]['_isInstalled'] = $ts2Yv['isInstalled']; goto RecIg; RecIg: $f6JWK[$E1j2M]['_isEnabled'] = $ts2Yv['enable']; goto CZuDB; CZuDB: $f6JWK[$E1j2M]['_localVersion'] = $hEapL['version']; goto hqzoO; cGkRV: } else { $f6JWK[$E1j2M] = array('id' => 0, 'name' => $E1j2M, 'title' => $hEapL['title'], 'cover' => null, 'categoryId' => null, 'latestVersion' => $hEapL['version'], 'releases' => array(), 'url' => null, 'isFee' => false, 'priceSuper' => null, 'priceSuperEnable' => false, 'priceYear' => null, 'priceYearEnable' => false, 'description' => $hEapL['description'], '_isLocal' => true, '_isInstalled' => $ts2Yv['isInstalled'], '_isEnabled' => $ts2Yv['enable'], '_localVersion' => $hEapL['version'], '_isSystem' => $ts2Yv['isSystem'], '_hasConfig' => !empty($hEapL['config'])); } } goto nXwFU; dCHNk: $FEjaa = self::remoteModuleData(); goto AeJdn; v3mOs: $YZXT9 = array(); goto Db9E1; hQ3Rw: $f6JWK = array(); goto dbNQ1; S6Fkf: } private static function baseRequest($ZFzMa, $XWlC_, $qtbsi) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $ZFzMa, $XWlC_, array('header' => array('api-token' => $qtbsi, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function checkPackage($qtbsi, $NS22k, $hi1qn) { goto Jia0I; Jia0I: $FZUh3 = self::baseRequest('/api/store/module_info', array('module' => $NS22k, 'version' => $hi1qn), $qtbsi); goto UB1e1; SOTNW: $e_0AT = array(); goto V3i61; J0Z73: $ts2Yv = $FZUh3['data']['config']; goto UHIv0; QcQlM: if (empty($ts2Yv['env'])) { $ts2Yv['env'] = array('laravel5'); } goto nM3SP; UB1e1: if ($FZUh3['code'] && isset($FZUh3['data']['buyCode'])) { return Response::generate(-1, $FZUh3['msg'], array('msg' => $FZUh3['data']['buyCode'], 'buyCodeId' => isset($FZUh3['data']['buyCodeId']) ? $FZUh3['data']['buyCodeId'] : null, 'payWatchUrl' => isset($FZUh3['data']['payWatchUrl']) ? $FZUh3['data']['payWatchUrl'] : null)); } goto EFYiB; UHIv0: $yYAk7 = $FZUh3['data']['packageSize']; goto SOTNW; V3i61: if (!empty($ts2Yv['modstartVersion'])) { goto ryVWC; ryVWC: $s2mjC = array('name' => '<a href=\'https://modstart.com/download\' class=\'ub-text-white tw-underline\' target=\'_blank\'>MSCore</a>:' . htmlspecialchars($ts2Yv['modstartVersion']), 'success' => VersionUtil::match(ModStart::$version, $ts2Yv['modstartVersion']), 'resolve' => null); goto I8m2Z; I8m2Z: if (!$s2mjC['success']) { $s2mjC['resolve'] = '请使用 MSCore' . $ts2Yv['modstartVersion'] . ' 的版本'; } goto PYwya; PYwya: $e_0AT[] = $s2mjC; goto tBL2y; tBL2y: } goto rfTp5; b2T1U: return Response::generateSuccessData(array('requires' => $e_0AT, 'errorCount' => count(array_filter($e_0AT, function ($ZOvGj) { return !$ZOvGj['success']; })), 'packageSize' => $yYAk7)); goto ZE52f; nM3SP: if (method_exists(ModuleManager::class, 'getEnv')) { $P2ylS = ModuleManager::getEnv(); BizException::throwsIf(L('Module %s:%s compatible with env %s, current is %s', $NS22k, $ts2Yv['version'], join(',', $ts2Yv['env']), $P2ylS), !in_array($P2ylS, $ts2Yv['env'])); } goto b2T1U; EFYiB: BizException::throwsIfResponseError($FZUh3); goto J0Z73; rfTp5: if (!empty($ts2Yv['require'])) { foreach ($ts2Yv['require'] as $s2mjC) { goto SlG5R; Gri_E: $e_0AT[] = $s2mjC; goto o3_aG; qBcrW: if (ModuleManager::isModuleInstalled($E1j2M)) { goto lJ8Eo; glR5z: $s2mjC['success'] = VersionUtil::match($K_e5a['version'], $gghxW); goto Fkp52; Fkp52: if (!$s2mjC['success']) { $s2mjC['resolve'] = '请使用版本 ' . htmlspecialchars($gghxW) . " 的模块 <a href='https://modstart.com/m/{$E1j2M}' class='ub-text-white tw-underline' target='_blank'>{$E1j2M}</a>"; } goto w1msj; lJ8Eo: $K_e5a = ModuleManager::getModuleBasic($E1j2M); goto kzduF; kzduF: BizException::throwsIfEmpty("获取模块 {$E1j2M} 信息失败", $K_e5a); goto glR5z; w1msj: } else { $s2mjC['success'] = false; $s2mjC['resolve'] = "请先安装 {$s2mjC['name']} <a href='https://modstart.com/m/{$E1j2M}' class='ub-text-white tw-underline' target='_blank'>[点击查看]</a>"; } goto Gri_E; an0UM: $s2mjC = array('name' => "<a href='https://modstart.com/m/{$E1j2M}' class='ub-text-white tw-underline' target='_blank'>{$E1j2M}</a>:" . htmlspecialchars($gghxW), 'success' => true, 'resolve' => null); goto qBcrW; SlG5R: list($E1j2M, $gghxW) = VersionUtil::parse($s2mjC); goto an0UM; o3_aG: } } goto QcQlM; ZE52f: } public static function downloadPackage($qtbsi, $NS22k, $hi1qn) { goto LsLEB; dNz3C: BizException::throwsIfResponseError($FZUh3); goto zX33k; UQieI: $xJIso = FileUtil::generateLocalTempPath('zip'); goto Rqhav; j_uVE: $yoKUU = $FZUh3['data']['licenseKey']; goto WtXFs; J4XM3: return Response::generateSuccessData(array('package' => $xJIso, 'licenseKey' => $yoKUU, 'packageSize' => filesize($xJIso))); goto XBULC; LsLEB: $FZUh3 = self::baseRequest('/api/store/module_package', array('module' => $NS22k, 'version' => $hi1qn), $qtbsi); goto dNz3C; Rqhav: file_put_contents($xJIso, $XWlC_); goto NNOWY; NwAn6: $Vm_EI = $FZUh3['data']['packageMd5']; goto j_uVE; Vv33r: BizException::throwsIfEmpty('安装包获取失败', $XWlC_); goto UQieI; WtXFs: $XWlC_ = CurlUtil::getRaw($WJlDi); goto Vv33r; NNOWY: BizException::throwsIf('文件MD5校验失败', md5_file($xJIso) != $Vm_EI); goto J4XM3; zX33k: $WJlDi = $FZUh3['data']['package']; goto NwAn6; XBULC: } public static function cleanDownloadedPackage($WJlDi) { FileUtil::safeCleanLocalTemp($WJlDi); } public static function unpackModule($NS22k, $WJlDi, $yoKUU) { goto s8Ovj; Kw6Wg: BizException::throwsIf('解压失败', !file_exists($GEitI . '/config.json')); goto WK_wI; EffeA: $c8yQj = new Zipper(); goto p6H3y; ggISu: $c8yQj->close(); goto Kw6Wg; YGpMq: $FZUh3 = FileUtil::filePathWritableCheck(array('module/._write_check_')); goto o5Bgw; CCZj0: self::cleanDownloadedPackage($WJlDi); goto jRCmT; KvmZh: @set_time_limit(60 * 10); goto EffeA; p6H3y: $c8yQj->make($WJlDi); goto GbfTf; o5Bgw: BizException::throwsIfResponseError($FZUh3); goto r_Juj; kXW_l: $c8yQj->extractTo($GEitI); goto ggISu; jRCmT: return Response::generateSuccessData($PBpnF); goto HrBpD; WK_wI: file_put_contents($GEitI . '/license.json', SerializeUtil::jsonEncode(array('licenseKey' => $yoKUU))); goto CCZj0; GbfTf: if ($c8yQj->contains($NS22k . '/config.json')) { $c8yQj->folder($NS22k . ''); } goto kXW_l; r_Juj: $GEitI = base_path('module/' . $NS22k); goto OSbL2; s8Ovj: $PBpnF = array(); goto pcTSo; OSbL2: if (file_exists($GEitI)) { goto p2F2T; NUKG0: BizException::throwsIf('模块目录 module/' . $NS22k . ' 不正常，请手动删除', !is_dir($GEitI)); goto A8HMF; eiu42: $PBpnF[] = "备份模块 {$NS22k} 到 {$IvF2s}"; goto E29fz; p2F2T: $IvF2s = '_delete_.' . date('Ymd_His') . '.' . $NS22k; goto NUKG0; RB1Ig: BizException::throwsIf('备份模块旧文件失败', !file_exists($DRskb)); goto eiu42; A8HMF: $DRskb = base_path("module/{$IvF2s}"); goto mdDK6; mdDK6: try { rename($GEitI, $DRskb); } catch (\Exception $VPhVw) { BizException::throws("备份模块 {$NS22k} 到 {$IvF2s} 失败（确保模块中所有文件和目录已关闭）"); } goto RB1Ig; E29fz: } goto Qlm5D; Qlm5D: BizException::throwsIf('模块目录 module/' . $NS22k . ' 不正常，请手动删除', file_exists($GEitI)); goto KvmZh; pcTSo: BizException::throwsIf('文件不存在 ' . $WJlDi, empty($WJlDi) || !file_exists($WJlDi)); goto YGpMq; HrBpD: } public static function removeModule($NS22k, $hi1qn) { goto wnzXH; wnzXH: $GEitI = base_path('module/' . $NS22k); goto EN4AB; S2c9K: return Response::generateSuccessData(array()); goto uTznW; EN4AB: BizException::throwsIf('模块目录不存在 ', !file_exists($GEitI)); goto LhOVY; sjeGa: $DRskb = base_path("module/{$IvF2s}"); goto nXta3; LhOVY: BizException::throwsIf('模块目录 module/' . $NS22k . ' 不正常，请手动删除', !is_dir($GEitI)); goto GN_PD; hsuxV: BizException::throwsIf('模块目录备份失败', !file_exists($DRskb)); goto S2c9K; nXta3: try { rename($GEitI, $DRskb); } catch (\Exception $VPhVw) { BizException::throws("移除模块 {$NS22k} 到 {$IvF2s} 失败，请确保模块 {$NS22k} 中没有文件正在被使用"); } goto hsuxV; GN_PD: $IvF2s = '_delete_.' . date('Ymd_His') . '.' . $NS22k; goto sjeGa; uTznW: } }