<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ModuleStore\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\ReUtil; use ModStart\Form\Form; use ModStart\Module\ModuleManager; use ModStart\Repository\RepositoryUtil; use Module\ModuleStore\Util\ModuleStoreUtil; class ModuleStoreController extends Controller { public function index() { AdminPermission::permitCheck('ModuleStoreManage'); return view('module::ModuleStore.View.admin.moduleStore.index'); } public function all() { AdminPermission::permitCheck('ModuleStoreManage'); return Response::generateSuccessData(ModuleStoreUtil::all()); } private function moduleOperateCheck($NS22k) { goto WvZPd; Mi4m8: if (empty($mlNIf)) { return; } goto MNrLQ; VFAOI: $mlNIf = array_filter($mlNIf); goto Mi4m8; CAQcc: if (empty($mlNIf)) { return; } goto uoDAf; rtt6T: BizException::throwsIf('只允许操作模块:' . join(',', $mlNIf), !$XBeol); goto YLi2W; ff24C: $mlNIf = config('env.MS_MODULE_WHITELIST', ''); goto CAQcc; uoDAf: $mlNIf = array_map(function ($gghxW) { return trim($gghxW); }, explode(',', $mlNIf)); goto VFAOI; WvZPd: BizException::throwsIf('当前环境禁止「模块管理」相关操作', config('env.MS_MODULE_STORE_DISABLE', false)); goto ff24C; MNrLQ: $XBeol = false; goto K8b0m; K8b0m: foreach ($mlNIf as $AVLNU) { if (ReUtil::isWildMatch($AVLNU, $NS22k)) { $XBeol = true; break; } } goto rtt6T; YLi2W: } private function doFinish($WjX62) { return Response::generateSuccessData(array('msg' => array_map(function ($AVLNU) { return '<i class="iconfont icon-hr"></i> ' . $AVLNU; }, $WjX62), 'finish' => true)); } private function doNext($YmK0O, $W9SYw, $WjX62 = array(), $XWlC_ = array()) { goto gQf1G; gQf1G: $ErQts = InputPackage::buildFromInput(); goto bry2G; bry2G: $XWlC_ = array_merge($ErQts->getJsonAsInput('data')->all(), $XWlC_); goto FvshR; FvshR: return Response::generateSuccessData(array('msg' => array_map(function ($AVLNU) { if (!starts_with($AVLNU, '<')) { $AVLNU = "<span class='ub-text-white'>{$AVLNU}</span>"; } return '<i class="iconfont icon-hr"></i> ' . $AVLNU; }, $WjX62), 'command' => $YmK0O, 'step' => $W9SYw, 'data' => $XWlC_, 'finish' => false)); goto lo3pu; lo3pu: } public function disable() { goto ZZXll; RWHEH: AdminPermission::demoCheck(); goto d8Got; IhW4X: $hi1qn = $dvCKi->getTrimString('version'); goto TfASi; ZZXll: AdminPermission::permitCheck('ModuleStoreManage'); goto RWHEH; QDM8O: $NS22k = $dvCKi->getTrimString('module'); goto IhW4X; Tg6FB: $dvCKi = $ErQts->getJsonAsInput('data'); goto QDM8O; FHLWx: switch ($W9SYw) { default: goto wMI0Y; x95Z3: BizException::throwsIfResponseError($FZUh3); goto RjplR; RjplR: return $this->doFinish(array('<span class="ub-text-success">禁用成功，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto ILz34; wMI0Y: $FZUh3 = ModuleManager::disable($NS22k); goto x95Z3; ILz34: } goto nEH_U; Z4Pgf: $W9SYw = $ErQts->getTrimString('step'); goto Tg6FB; kUSlK: BizException::throwsIfEmpty('version为空', $hi1qn); goto RPkin; RPkin: $this->moduleOperateCheck($NS22k); goto FHLWx; TfASi: BizException::throwsIfEmpty('module为空', $NS22k); goto kUSlK; d8Got: $ErQts = InputPackage::buildFromInput(); goto Z4Pgf; nEH_U: } public function enable() { goto JHVIU; i9fd4: $this->moduleOperateCheck($NS22k); goto g6rtg; kzGqW: $dvCKi = $ErQts->getJsonAsInput('data'); goto Wwgda; g6rtg: switch ($W9SYw) { default: goto xvupe; hOSiO: return $this->doFinish(array('<span class="ub-text-success">启动成功，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto cBC4g; ebN8C: BizException::throwsIfResponseError($FZUh3); goto hOSiO; xvupe: $FZUh3 = ModuleManager::enable($NS22k); goto ebN8C; cBC4g: } goto cyC9K; FSVFM: $ErQts = InputPackage::buildFromInput(); goto YnNhW; eddf6: $hi1qn = $dvCKi->getTrimString('version'); goto cHQNA; Wwgda: $NS22k = $dvCKi->getTrimString('module'); goto eddf6; SZ1GF: AdminPermission::demoCheck(); goto FSVFM; cHQNA: BizException::throwsIfEmpty('module为空', $NS22k); goto oPoLd; JHVIU: AdminPermission::permitCheck('ModuleStoreManage'); goto SZ1GF; oPoLd: BizException::throwsIfEmpty('version为空', $hi1qn); goto i9fd4; YnNhW: $W9SYw = $ErQts->getTrimString('step'); goto kzGqW; cyC9K: } public function uninstall() { goto zkI7G; PQI4O: BizException::throwsIf('系统模块不能动态设置', ModuleManager::isSystemModule($NS22k)); goto i1a0P; QsTSh: BizException::throwsIfEmpty('module为空', $NS22k); goto m2lU3; ojAoW: $hi1qn = $dvCKi->getTrimString('version'); goto g44Ri; iR2o5: $W9SYw = $ErQts->getTrimString('step'); goto Z9KQB; VuDt9: AdminPermission::demoCheck(); goto ahIQo; i1a0P: $this->moduleOperateCheck($NS22k); goto Mvqst; g44Ri: $kelov = $dvCKi->getBoolean('isLocal'); goto QsTSh; ahIQo: $ErQts = InputPackage::buildFromInput(); goto iR2o5; mcV9_: $NS22k = $dvCKi->getTrimString('module'); goto ojAoW; Mvqst: if ($kelov) { switch ($W9SYw) { default: goto lx0V4; IB7bw: BizException::throwsIfResponseError($FZUh3); goto yzzJH; yzzJH: return $this->doFinish(array('<span class="ub-text-success">卸载完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto SdV5_; lx0V4: $FZUh3 = ModuleManager::uninstall($NS22k); goto IB7bw; SdV5_: } } else { switch ($W9SYw) { case 'removePackage': goto dqNCI; fgbfr: return $this->doFinish(array('<span class="ub-text-success">卸载完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto xHGkg; dqNCI: $FZUh3 = ModuleStoreUtil::removeModule($NS22k, $hi1qn); goto WSRlQ; WSRlQ: BizException::throwsIfResponseError($FZUh3); goto fgbfr; xHGkg: default: goto GnR1C; GnR1C: $FZUh3 = ModuleManager::uninstall($NS22k); goto tpzEq; B4dEi: return $this->doNext('uninstall', 'removePackage', array('<span class="ub-text-success">开始卸载 ' . $NS22k . ' V' . $hi1qn . '</span>')); goto ohvcm; tpzEq: BizException::throwsIfResponseError($FZUh3); goto B4dEi; ohvcm: } } goto WbsSm; zkI7G: AdminPermission::permitCheck('ModuleStoreManage'); goto VuDt9; Z9KQB: $dvCKi = $ErQts->getJsonAsInput('data'); goto mcV9_; m2lU3: BizException::throwsIfEmpty('version为空', $hi1qn); goto PQI4O; WbsSm: } public function upgrade() { goto fcjjy; KaS1w: $hi1qn = $dvCKi->getTrimString('version'); goto R1Spz; lpeS3: $W9SYw = $ErQts->getTrimString('step'); goto cx2R_; CuQOI: $this->moduleOperateCheck($NS22k); goto xkht3; fcjjy: AdminPermission::permitCheck('ModuleStoreManage'); goto Du9lM; gvVH_: $ErQts = InputPackage::buildFromInput(); goto RdQJR; RdQJR: $qtbsi = $ErQts->getTrimString('token'); goto lpeS3; jzBix: $NS22k = $dvCKi->getTrimString('module'); goto KaS1w; xkht3: switch ($W9SYw) { case 'installModule': goto kTp2_; p2Oae: BizException::throwsIfResponseError($FZUh3); goto dLOp3; S1q6z: BizException::throwsIfResponseError($FZUh3); goto VKytX; dLOp3: $FZUh3 = ModuleManager::enable($NS22k); goto S1q6z; kTp2_: $FZUh3 = ModuleManager::install($NS22k, true); goto p2Oae; VKytX: return $this->doFinish(array('<span class="ub-text-success">升级安装完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto abAPo; abAPo: case 'unpackPackage': goto zhn97; s5oz6: BizException::throwsIfEmpty('package为空', $WJlDi); goto W2wf8; LRuxO: return $this->doNext('upgrade', 'installModule', array_merge(array('<span class="ub-text-success">模块解压完成</span>', '<span class="ub-text-white">开始安装...</span>'), $FZUh3['data'])); goto fK2IJ; zTdsl: BizException::throwsIfResponseError($FZUh3); goto LRuxO; W2wf8: $yoKUU = $dvCKi->getTrimString('licenseKey'); goto jrHja; zhn97: $WJlDi = $dvCKi->getTrimString('package'); goto s5oz6; jrHja: BizException::throwsIfEmpty('licenseKey为空', $yoKUU); goto n1s07; n1s07: try { $FZUh3 = ModuleStoreUtil::unpackModule($NS22k, $WJlDi, $yoKUU); } catch (\Exception $VPhVw) { ModuleStoreUtil::cleanDownloadedPackage($WJlDi); throw $VPhVw; } goto zTdsl; fK2IJ: case 'downloadPackage': goto HJsYp; rf8qd: return $this->doNext('upgrade', 'unpackPackage', array('<span class="ub-text-success">获取安装包完成，大小 ' . FileUtil::formatByte($FZUh3['data']['packageSize']) . '</span>', '<span class="ub-text-white">开始解压安装包...</span>'), array('package' => $FZUh3['data']['package'], 'licenseKey' => $FZUh3['data']['licenseKey'])); goto LCjdC; HJsYp: $FZUh3 = ModuleStoreUtil::downloadPackage($qtbsi, $NS22k, $hi1qn); goto ohyra; ohyra: BizException::throwsIfResponseError($FZUh3); goto rf8qd; LCjdC: case 'checkPackage': goto Qjx8I; wRRcL: foreach ($FZUh3['data']['requires'] as $s2mjC) { $WjX62[] = '<span>&nbsp;&nbsp;</span>' . ($s2mjC['success'] ? '<span class="ub-text-success"><i class="iconfont icon-check"></i> 成功</span>' : '<span class="ub-text-danger"><i class="iconfont icon-warning"></i> 失败</span>') . " <span>{$s2mjC['name']}</span> " . ($s2mjC['resolve'] ? " <span>解决：{$s2mjC['resolve']}</span>" : ''); } goto v2crx; kznkW: $WjX62 = array(); goto wRRcL; Qjx8I: $FZUh3 = ModuleStoreUtil::checkPackage($qtbsi, $NS22k, $hi1qn); goto w3_MQ; YbWtk: $WjX62[] = '<span class="ub-text-white">开始下载安装包...</span>'; goto Kof8y; w3_MQ: if (Response::isError($FZUh3)) { return $FZUh3; } goto kznkW; Kof8y: return $this->doNext('upgrade', 'downloadPackage', array_merge(array('PHP版本: v' . PHP_VERSION, '<span class="ub-text-success">预检成功，' . count($FZUh3['data']['requires']) . '个依赖满足要求，安装包大小 ' . FileUtil::formatByte($FZUh3['data']['packageSize']) . '</span>'), $WjX62)); goto CQ5fD; v2crx: if ($FZUh3['data']['errorCount'] > 0) { return $this->doFinish(array_merge($WjX62, array('<span class="ub-text-danger">预检失败，' . $FZUh3['data']['errorCount'] . '个依赖不满足要求</span>'))); } goto YbWtk; CQ5fD: default: return $this->doNext('upgrade', 'checkPackage', array('<span class="ub-text-success">开始升级到远程模块 ' . $NS22k . ' V' . $hi1qn . '</span>', '<span class="ub-text-white">开始模块安装预检...</span>')); } goto AMEgZ; R1Spz: BizException::throwsIfEmpty('module为空', $NS22k); goto XllLH; cx2R_: BizException::throwsIfEmpty('请先登录ModStartCMS账号', $qtbsi); goto jPH3k; XllLH: BizException::throwsIfEmpty('version为空', $hi1qn); goto CuQOI; jPH3k: $dvCKi = $ErQts->getJsonAsInput('data'); goto jzBix; Du9lM: AdminPermission::demoCheck(); goto gvVH_; AMEgZ: } public function install() { goto TX3gp; RtGDE: $kelov = $dvCKi->getBoolean('isLocal'); goto tFnX0; Wlzbv: $dvCKi = $ErQts->getJsonAsInput('data'); goto uHlUt; fUAT7: $ErQts = InputPackage::buildFromInput(); goto YQLOg; kdQ3e: BizException::throwsIfEmpty('version为空', $hi1qn); goto ngH5j; pn2Dv: if ($kelov) { switch ($W9SYw) { case 'installModule': goto UfshF; lYI33: $FZUh3 = ModuleManager::enable($NS22k); goto ACHPp; NbbFw: BizException::throwsIfResponseError($FZUh3); goto lYI33; UfshF: $FZUh3 = ModuleManager::install($NS22k, true); goto NbbFw; A2NcT: return $this->doFinish(array('<span class="ub-text-success">安装完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto tFbL2; ACHPp: BizException::throwsIfResponseError($FZUh3); goto A2NcT; tFbL2: default: return $this->doNext('install', 'installModule', array('<span class="ub-text-success">开始安装本地模块 ' . $NS22k . ' V' . $hi1qn . '</span>', '<span class="ub-text-white">开始安装..</span>')); } } else { switch ($W9SYw) { case 'installModule': goto INxdm; INxdm: $FZUh3 = ModuleManager::install($NS22k, true); goto KIbMu; KIbMu: if (Response::isError($FZUh3)) { ModuleManager::clean($NS22k); BizException::throws($FZUh3['msg']); } goto Vn_2y; Vn_2y: $FZUh3 = ModuleManager::enable($NS22k); goto uJaNH; uJaNH: BizException::throwsIfResponseError($FZUh3); goto bnTx9; bnTx9: return $this->doFinish(array('<span class="ub-text-success">安装完成，请 <a href="javascript:;" onclick="parent.location.reload()">刷新后台</a> 查看最新系统</span>')); goto p159V; p159V: case 'unpackPackage': goto OEoNb; ck46l: $yoKUU = $dvCKi->getTrimString('licenseKey'); goto sxqYr; sxqYr: BizException::throwsIfEmpty('licenseKey为空', $yoKUU); goto KyjwZ; nDKiV: return $this->doNext('install', 'installModule', array_merge(array('<span class="ub-text-success">模块解压完成</span>', '<span class="ub-text-white">开始安装...</span>'), $FZUh3['data'])); goto Mj48X; OEoNb: $WJlDi = $dvCKi->getTrimString('package'); goto yfbn_; KyjwZ: try { $FZUh3 = ModuleStoreUtil::unpackModule($NS22k, $WJlDi, $yoKUU); } catch (\Exception $VPhVw) { ModuleStoreUtil::cleanDownloadedPackage($WJlDi); throw $VPhVw; } goto cc5tv; cc5tv: BizException::throwsIfResponseError($FZUh3); goto nDKiV; yfbn_: BizException::throwsIfEmpty('package为空', $WJlDi); goto ck46l; Mj48X: case 'downloadPackage': goto mzJb3; mzJb3: $FZUh3 = ModuleStoreUtil::downloadPackage($qtbsi, $NS22k, $hi1qn); goto ssQcy; ssQcy: BizException::throwsIfResponseError($FZUh3); goto sfrhJ; sfrhJ: return $this->doNext('install', 'unpackPackage', array('<span class="ub-text-success">获取安装包完成，大小 ' . FileUtil::formatByte($FZUh3['data']['packageSize']) . '</span>', '<span class="ub-text-white">开始解压安装包...</span>'), array('package' => $FZUh3['data']['package'], 'licenseKey' => $FZUh3['data']['licenseKey'])); goto hkJwI; hkJwI: case 'checkPackage': goto hwXAB; UWHFy: return $this->doNext('install', 'downloadPackage', array_merge(array('PHP版本: v' . PHP_VERSION, '<span class="ub-text-success">预检成功，' . count($FZUh3['data']['requires']) . '个依赖满足要求，安装包大小 ' . FileUtil::formatByte($FZUh3['data']['packageSize']) . '</span>'), $WjX62)); goto Za3S1; BmQAm: if (Response::isError($FZUh3)) { return $FZUh3; } goto TVimT; hwXAB: $FZUh3 = ModuleStoreUtil::checkPackage($qtbsi, $NS22k, $hi1qn); goto BmQAm; Za3S1: break; goto WuDPT; TVimT: $WjX62 = array(); goto miXe_; V2JbU: if ($FZUh3['data']['errorCount'] > 0) { return $this->doFinish(array_merge($WjX62, array('<span class="ub-text-danger">预检失败，' . $FZUh3['data']['errorCount'] . '个依赖不满足要求</span>'))); } goto jKrkJ; miXe_: foreach ($FZUh3['data']['requires'] as $s2mjC) { $WjX62[] = '<span>&nbsp;&nbsp;</span>' . ($s2mjC['success'] ? '<span class="ub-text-success"><i class="iconfont icon-check"></i> 成功</span>' : '<span class="ub-text-danger"><i class="iconfont icon-warning"></i> 失败</span>') . " <span>{$s2mjC['name']}</span> " . ($s2mjC['resolve'] ? " <span>解决：{$s2mjC['resolve']}</span>" : ''); } goto V2JbU; jKrkJ: $WjX62[] = '<span class="ub-text-white">开始下载安装包...</span>'; goto UWHFy; WuDPT: default: return $this->doNext('install', 'checkPackage', array('<span class="ub-text-success">开始安装远程模块 ' . $NS22k . ' V' . $hi1qn . '</span>', '<span class="ub-text-white">开始模块安装预检...</span>')); } } goto AViN5; I7u3B: $hi1qn = $dvCKi->getTrimString('version'); goto RtGDE; K00V9: AdminPermission::demoCheck(); goto fUAT7; qprx8: BizException::throwsIfEmpty('请先登录ModStartCMS账号', $qtbsi); goto Wlzbv; YQLOg: $qtbsi = $ErQts->getTrimString('token'); goto AsM36; ngH5j: BizException::throwsIf('系统模块不能动态设置', ModuleManager::isSystemModule($NS22k)); goto Zt0RZ; AsM36: $W9SYw = $ErQts->getTrimString('step'); goto qprx8; tFnX0: BizException::throwsIfEmpty('module为空', $NS22k); goto kdQ3e; uHlUt: $NS22k = $dvCKi->getTrimString('module'); goto I7u3B; Zt0RZ: $this->moduleOperateCheck($NS22k); goto pn2Dv; TX3gp: AdminPermission::permitCheck('ModuleStoreManage'); goto K00V9; AViN5: } public function config(AdminConfigBuilder $U2qv4, $NS22k) { goto Hv4G8; yhPnU: $U2qv4->pageTitle(htmlspecialchars($K_e5a['title']) . ' ' . L('Module Config')); goto fE0C9; FMy9I: return $U2qv4->perform(RepositoryUtil::itemFromArray($xLMVN['config']), function (Form $yAhCR) use($NS22k, $xLMVN) { AdminPermission::demoCheck(); if ($xLMVN['isSystem']) { ModuleManager::saveSystemOverwriteModuleConfig($NS22k, $yAhCR->dataForming()); } else { ModuleManager::saveUserInstalledModuleConfig($NS22k, $yAhCR->dataForming()); } return Response::generate(0, '保存成功', null, CRUDUtil::jsDialogClose()); }); goto X0TC3; mcU1X: foreach ($K_e5a['config'] as $Cc2wA => $e0LHO) { goto HbGpn; KxAf0: if (!isset($xLMVN['config'][$Cc2wA])) { $xLMVN['config'][$Cc2wA] = null; } goto CpE_S; HbGpn: $E9h4W = null; goto KxAf0; CpE_S: foreach ($e0LHO as $qUAUi) { $rfBQu = array_shift($qUAUi); if (null === $E9h4W) { array_unshift($qUAUi, $Cc2wA); $E9h4W = call_user_func(array($U2qv4, $rfBQu), ...$qUAUi); } else { call_user_func(array($E9h4W, $rfBQu), ...$qUAUi); } } goto iyxmj; iyxmj: } goto FMy9I; woGVb: BizException::throwsIfEmpty('Module config error', $K_e5a['config']); goto mcU1X; Hv4G8: AdminPermission::permitCheck('ModuleStoreManage'); goto mjMDj; mjMDj: $K_e5a = ModuleManager::getModuleBasic($NS22k); goto JxJbK; JxJbK: $U2qv4->useDialog(); goto yhPnU; fE0C9: $U2qv4->layoutHtml('<div class="ub-alert danger"><i class="iconfont icon-warning"></i> 本页面包含的配置仅供开发使用，设置不当可能会导致系统功能异常</div>'); goto GDM3v; GDM3v: $xLMVN = ModuleManager::getInstalledModuleInfo($NS22k); goto woGVb; X0TC3: } }