<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Nav\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Type\TypeUtil; use ModStart\Core\Util\SerializeUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Field\Type\FieldRenderMode; use ModStart\Form\Form; use ModStart\ModStart; use ModStart\Repository\Filter\ScopeFilter; use ModStart\Support\Concern\HasFields; use Module\Nav\Type\NavOpenType; use Module\Nav\Type\NavPosition; use Module\Nav\Util\NavUtil; class NavController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $U2qv4) { goto iUiPt; upbUQ: $U2qv4->scopeDefault(NavPosition::first()); goto ot09U; kLEHZ: foreach (NavPosition::getList() as $Cc2wA => $qTz8C) { $U2qv4->scopeFilter($Cc2wA, $qTz8C, function (ScopeFilter $RryBq) use($Cc2wA) { return $RryBq->where('position', $Cc2wA); }); } goto upbUQ; iUiPt: if ($U2qv4->mode() == AdminCRUDBuilder::MODE_FORM) { goto at5ri; LRp15: foreach (NavUtil::tree() as $gghxW) { $pvGIH[] = array('id' => $gghxW['id'], 'position' => $gghxW['position'], 'name' => $gghxW['name']); if (!empty($gghxW['_child'])) { foreach ($gghxW['_child'] as $j52xC) { $pvGIH[] = array('id' => $j52xC['id'], 'position' => $j52xC['position'], 'name' => $gghxW['name'] . ' → ' . $j52xC['name']); } } } goto SpbcB; SpbcB: ModStart::script('window.__positionNavs=' . SerializeUtil::jsonEncode($pvGIH) . ';'); goto YQkwL; YQkwL: ModStart::scriptFile('module/Nav/Admin/Controller/NavEdit.js'); goto r6IaC; at5ri: $pvGIH = array(); goto LRp15; r6IaC: } goto fz1H_; ot09U: $U2qv4->hookSaved(function (Form $yAhCR) { $AVLNU = $yAhCR->item(); if ($AVLNU->pid > 0) { $d68rN = ModelUtil::get('nav', $AVLNU->pid); ModelUtil::update('nav', $AVLNU->id, array('position' => $d68rN['position'])); } })->hookChanged(function (Form $yAhCR) { NavUtil::clearCache(); })->canBatchDelete(true)->asTree('id', 'pid', 'sort', 'name')->treeMaxLevel(3)->title('导航设置'); goto IwVxf; fz1H_: $U2qv4->init('nav')->field(function ($U2qv4) { $U2qv4->id('id', 'ID'); $U2qv4->select('position', '位置')->optionType(NavPosition::class)->hookRendering(function (AbstractField $E9h4W, $AVLNU, $oPu4k) { switch ($E9h4W->renderMode()) { case FieldRenderMode::DETAIL: case FieldRenderMode::GRID: if ($AVLNU->pid) { return AutoRenderedFieldValue::make(''); } return AutoRenderedFieldValue::make(TypeUtil::name(NavPosition::class, $AVLNU->position)); } }); $U2qv4->text('name', '名称'); $U2qv4->icon('icon', '图标')->help('部分主题支持图标显示'); $U2qv4->link('link', '链接'); $U2qv4->switch('enable', '启用')->optionsYesNo()->gridEditable(true)->defaultValue(true); $U2qv4->radio('openType', '打开方式')->optionType(NavOpenType::class)->defaultValue(NavOpenType::CURRENT_WINDOW); $U2qv4->display('created_at', L('Created At'))->listable(false); $U2qv4->display('updated_at', L('Updated At'))->listable(false); }); goto kLEHZ; IwVxf: } }