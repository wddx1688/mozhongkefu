<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Core; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Module\ModuleManager; use Module\Member\Events\MemberUserVipChangeEvent; use Module\Member\Util\MemberCreditUtil; use Module\Member\Util\MemberUtil; use Module\Member\Util\MemberVipUtil; use Module\PayCenter\Biz\AbstractPayCenterBiz; use Module\Vendor\Type\OrderStatus; class MemberVipPayCenterBiz extends AbstractPayCenterBiz { const NAME = 'mMemberVip'; public function name() { return self::NAME; } public function title() { return '会员VIP'; } public function onPayed($luzPt, $fE2Qa, $uZEpM = array()) { goto UQ8iy; QuVtk: if (empty($DrwL4)) { return; } goto CwLfC; eZ2jx: if (ModuleManager::getModuleConfig('Member', 'creditEnable', false)) { $fzxih = MemberVipUtil::get($DrwL4['vipId']); if ($fzxih['creditPresentEnable']) { MemberCreditUtil::change($DrwL4['memberUserId'], $fzxih['creditPresentValue'], '会员VIP赠送积分'); } } goto Q2VCN; Q2VCN: if ($Bj5vh['vipId'] != $CRCLA['vipId']) { MemberUserVipChangeEvent::fire($DrwL4['memberUserId'], $CRCLA['vipId'], $Bj5vh['vipId']); } goto MDQkW; l8_OI: MemberUtil::update($DrwL4['memberUserId'], $Bj5vh); goto eZ2jx; HCq7T: $Bj5vh['vipExpire'] = $DrwL4['expire']; goto l8_OI; pq0_3: $Bj5vh = array(); goto ZZelu; UQ8iy: $DrwL4 = ModelUtil::get('member_vip_order', $luzPt); goto QuVtk; CwLfC: ModelUtil::update('member_vip_order', array('id' => $luzPt), array('status' => OrderStatus::COMPLETED)); goto jJY2p; jJY2p: $CRCLA = MemberUtil::get($DrwL4['memberUserId']); goto Q9lkF; Q9lkF: if (empty($CRCLA)) { return; } goto pq0_3; ZZelu: $Bj5vh['vipId'] = $DrwL4['vipId']; goto HCq7T; MDQkW: } public function createOrderForQuick($RQr3R, $uZEpM = array()) { goto XnJNh; ZnhSb: $ECp_x = $Jty9h['data']['price']; goto xmEaL; xmEaL: BizException::throwsIf('订单金额异常', $ECp_x < 0.01 || $ECp_x > 1000 * 10000); goto Qputj; Ssf03: BizException::throwsIfEmpty('用户ID为空', $tJ6XI); goto SQ_Yk; SQ_Yk: $ybqNI = $RQr3R['param']['vipId']; goto r9Zek; BEDN2: BizException::throwsIf($Jty9h['msg'], $Jty9h['code'] > 0); goto ZnhSb; SeVY1: return Response::generateSuccessData(array('bizId' => $DrwL4['id'], 'feeTotal' => $ECp_x, 'body' => '开通VIP', 'param' => array(), 'redirect' => modstart_web_url('member_vip'))); goto VXwvt; XnJNh: $tJ6XI = $RQr3R['session']['memberUserId']; goto Ssf03; hzjdN: $Jty9h = MemberVipUtil::calcPrice($CRCLA['vipId'], $CRCLA['vipExpire'], $ybqNI); goto BEDN2; Qputj: $DrwL4 = ModelUtil::insert('member_vip_order', array('status' => OrderStatus::WAIT_PAY, 'memberUserId' => $tJ6XI, 'vipId' => $bKLUw['id'], 'payFee' => $ECp_x, 'expire' => $Jty9h['data']['expire'], 'type' => $Jty9h['data']['type'])); goto SeVY1; FF8r6: BizException::throwsIfEmpty('会员类型不存在', $bKLUw); goto A9JN_; UwfMk: $bKLUw = MemberVipUtil::get($ybqNI); goto FF8r6; r9Zek: BizException::throwsIfEmpty('请选择会员类型', $ybqNI); goto UwfMk; A9JN_: $CRCLA = MemberUtil::get($tJ6XI); goto AchbW; AchbW: BizException::throwsIfEmpty('会员不存在', $CRCLA); goto hzjdN; VXwvt: } }