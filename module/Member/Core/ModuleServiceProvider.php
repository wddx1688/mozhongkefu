<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Core; use Illuminate\Events\Dispatcher; use Illuminate\Support\Facades\Event; use Illuminate\Support\ServiceProvider; use ModStart\Admin\Config\AdminMenu; use ModStart\Admin\Widget\DashboardItemA; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Util\ColorUtil; use ModStart\Data\Event\DataDeletedEvent; use ModStart\Data\Event\DataUploadedEvent; use ModStart\Data\Event\DataUploadingEvent; use ModStart\Layout\Row; use ModStart\Module\ModuleManager; use Module\Member\Auth\MemberUser; use Module\Member\Config\MemberHomeIcon; use Module\Member\Config\MemberMenu; use Module\Member\Events\MemberUserRegisteredEvent; use Module\Member\Model\MemberUpload; use Module\Member\Provider\MemberAdminShowPanel\MemberAdminShowPanelProvider; use Module\Member\Provider\MemberDeleteScheduleProvider; use Module\Member\Provider\VerifySmsTemplateProvider; use Module\Member\Util\MemberCreditUtil; use Module\Member\Util\MemberDataStatisticUtil; use Module\Member\Util\MemberMessageUtil; use Module\Member\Util\MemberMoneyUtil; use Module\Member\Util\MemberParamUtil; use Module\Member\Util\MemberUtil; use Module\PayCenter\Biz\PayCenterBiz; use Module\Vendor\Admin\Widget\AdminWidgetDashboard; use Module\Vendor\Admin\Widget\AdminWidgetLink; use Module\Vendor\Job\MailSendJob; use Module\Vendor\Provider\Schedule\ScheduleBiz; use Module\Vendor\Provider\SmsTemplate\SmsTemplateProvider; class ModuleServiceProvider extends ServiceProvider { public function boot(Dispatcher $HLRQG) { goto o3WkX; uAsmH: if (modstart_module_enabled('PayCenter')) { PayCenterBiz::register(MemberMoneyChargePayCenterBiz::class); PayCenterBiz::register(MemberVipPayCenterBiz::class); } goto qgASA; qgASA: if (ModuleManager::getModuleConfig('Member', 'dataStatisticEnable', false)) { goto YvNwH; fl2FS: if (class_exists(DataUploadingEvent::class)) { DataUploadingEvent::listen('member_upload', function (DataUploadingEvent $VPhVw) { MemberDataStatisticUtil::checkQuota($VPhVw->userId); }); } goto JbiiN; JbiiN: if (class_exists(DataUploadedEvent::class)) { DataUploadedEvent::listen('member_upload', function (DataUploadedEvent $VPhVw) { MemberDataStatisticUtil::updateMemberUserUsedSize($VPhVw->userId); }); } goto C4Izn; YvNwH: MemberAdminShowPanelProvider::register(MemberDataStatisticAdminShowPanelProvider::class); goto fl2FS; C4Izn: if (class_exists(DataDeletedEvent::class)) { DataDeletedEvent::listen(function (DataDeletedEvent $VPhVw) { $He0J8 = MemberUpload::where(array('dataId' => $VPhVw->data['id']))->first(); if ($He0J8) { $He0J8->delete(); MemberDataStatisticUtil::updateMemberUserUsedSize($He0J8->userId); } }); } goto NdiPH; NdiPH: } goto YLfrn; o3WkX: MemberMenu::register(function () { $ftQC9 = ModuleManager::getModuleConfig('Member', 'moneyEnable', false); $Pn190 = ModuleManager::getModuleConfig('Member', 'creditEnable', false); $YGeA5 = '我的' . ModuleManager::getModuleConfig('Member', 'creditName', '积分'); $TFA03 = ModuleManager::getModuleConfig('Member', 'addressEnable', false); return array(array('icon' => 'details', 'title' => '资产', 'sort' => 900, 'children' => array($ftQC9 ? array('title' => '我的钱包', 'url' => modstart_web_url('member_money')) : null, $Pn190 ? array('title' => $YGeA5, 'url' => modstart_web_url('member_credit')) : null)), array('icon' => 'user', 'title' => '我的', 'sort' => 1000, 'children' => array($TFA03 ? array('title' => '我的地址', 'url' => modstart_web_url('member_address')) : null, array('icon' => 'iconfont icon-comment', 'title' => '我的消息', 'url' => modstart_web_url('member_message')), array('title' => '账号安全', 'url' => modstart_web_url('member_profile/security')), array('title' => '账号资料', 'url' => modstart_web_url('member_profile/profile')), array('sort' => 999999, 'title' => '退出登录', 'url' => modstart_web_url('logout'))))); }); goto moBNk; O6TWq: AdminWidgetDashboard::registerIcon(function (Row $sDTP5) { $sDTP5->column(3, DashboardItemA::makeIconNumberTitle('iconfont icon-user', ModelUtil::count('member_user', array('isDeleted' => false)), '用户管理', modstart_admin_url('member'), ColorUtil::randomColor())); }); goto yR1jH; YDSzd: MemberHomeIcon::register(function () { $ftQC9 = ModuleManager::getModuleConfig('Member', 'moneyEnable', false); $Pn190 = ModuleManager::getModuleConfig('Member', 'creditEnable', false); $YGeA5 = '我的' . ModuleManager::getModuleConfig('Member', 'creditName', '积分'); return array(array('title' => '我的', 'sort' => 1000, 'children' => array($ftQC9 ? array('icon' => 'iconfont icon-pay', 'value' => sprintf('￥%.2f', MemberMoneyUtil::getTotal(MemberUser::id())), 'title' => '我的钱包', 'url' => modstart_web_url('member_money')) : null, $Pn190 ? array('icon' => 'iconfont icon-credit', 'value' => MemberCreditUtil::getTotal(MemberUser::id()), 'title' => $YGeA5, 'url' => modstart_web_url('member_credit')) : null, array('icon' => 'iconfont icon-comment', 'title' => '我的消息', 'url' => modstart_web_url('member_message')), array('icon' => 'iconfont icon-card', 'title' => '我的资料', 'url' => modstart_web_url('member_profile')), array('icon' => 'iconfont icon-lock', 'title' => '修改密码', 'url' => modstart_web_url('member_profile/password')), array('icon' => 'iconfont icon-user', 'title' => '修改头像', 'url' => modstart_web_url('member_profile/avatar')), array('icon' => 'iconfont icon-lock', 'title' => '退出登录', 'url' => modstart_web_url('logout'))))); }); goto O6TWq; yR1jH: AdminWidgetLink::register(function () { return AdminWidgetLink::build('会员', array(array('注册', modstart_web_url('register')), array('登录', modstart_web_url('login')), array('找回密码', modstart_web_url('retrieve')), ModuleManager::getModuleConfig('Member', 'vipEnable', false) ? array('开通VIP', modstart_web_url('member_vip')) : null, ModuleManager::getModuleConfig('Member', 'moneyEnable', false) ? array('用户钱包', modstart_web_url('member_money')) : null, ModuleManager::getModuleConfig('Member', 'creditEnable', false) ? array('用户积分', modstart_web_url('login')) : null)); }); goto uAsmH; a1Cvp: AdminMenu::register(function () { $ftQC9 = ModuleManager::getModuleConfig('Member', 'moneyEnable', false); $Pn190 = ModuleManager::getModuleConfig('Member', 'creditEnable', false); $G2ZSf = ModuleManager::getModuleConfig('Member', 'vipEnable', false); $o1TC6 = ModuleManager::getModuleConfig('Member', 'groupEnable', false); return array(array('title' => '用户中心', 'icon' => 'users', 'sort' => 100, 'children' => array(array('title' => '用户统计', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberDashboardController@index'), array('title' => '用户管理', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberController@index'), array('title' => '用户资产', 'children' => array($ftQC9 ? array('title' => '用户钱包流水', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberMoneyLogController@index') : null, $ftQC9 ? array('title' => '用户钱包提现申请', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberMoneyCashController@index') : null, $Pn190 ? array('title' => '用户积分流水', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberCreditLogController@index') : null)), array('title' => '用户设置', 'sort' => 999999, 'children' => array(array('title' => '功能设置', 'url' => '\\Module\\Member\\Admin\\Controller\\ConfigController@setting'), array('title' => '用户协议', 'url' => '\\Module\\Member\\Admin\\Controller\\ConfigController@agreement'), array('title' => '消息设置', 'url' => '\\Module\\Member\\Admin\\Controller\\ConfigController@message'), $ftQC9 ? array('title' => '钱包设置', 'url' => '\\Module\\Member\\Admin\\Controller\\ConfigController@money') : null, $G2ZSf ? array('title' => '用户VIP等级', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberVipSetController@index') : null, $o1TC6 ? array('title' => '用户分组', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberGroupController@index') : null)))), array('title' => '财务中心', 'icon' => 'cny', 'sort' => 200, 'children' => array(array('title' => '业务订单', 'sort' => 999999, 'children' => array($ftQC9 ? array('title' => '用户-钱包充值订单', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberMoneyChargeOrderController@index') : null, $G2ZSf ? array('title' => '用户VIP订单', 'url' => '\\Module\\Member\\Admin\\Controller\\MemberVipOrderController@index') : null))))); }); goto CVuEm; qiH79: ScheduleBiz::register(MemberDeleteScheduleProvider::class); goto YDSzd; moBNk: SmsTemplateProvider::register(VerifySmsTemplateProvider::class); goto qiH79; YLfrn: Event::listen(MemberUserRegisteredEvent::class, function (MemberUserRegisteredEvent $VPhVw) { $AF6tQ = modstart_config('Member_Registered_Message', ''); if ($AF6tQ) { goto ZQ3ks; UUGlZ: $AF6tQ = MemberParamUtil::replaceParam($AF6tQ, $CRCLA); goto jw3Mm; jw3Mm: MemberMessageUtil::send($VPhVw->memberUserId, MemberParamUtil::replaceParam($AF6tQ, $CRCLA)); goto MOf1S; ZQ3ks: $CRCLA = MemberUtil::getCached($VPhVw->memberUserId); goto UUGlZ; MOf1S: } $BEylm = modstart_config('Member_Registered_Email', ''); $NGe20 = modstart_config('Member_Registered_EmailTitle', ''); if ($NGe20 && $BEylm) { $CRCLA = MemberUtil::getCached($VPhVw->memberUserId); if (!empty($CRCLA['email'])) { goto FbdSv; FbdSv: $NGe20 = MemberParamUtil::replaceParam($NGe20, $CRCLA); goto Idddl; xAspe: MailSendJob::createHtml($CRCLA['email'], $NGe20, $BEylm); goto SfXdG; Idddl: $BEylm = MemberParamUtil::replaceParam($BEylm, $CRCLA); goto xAspe; SfXdG: } } }); goto a1Cvp; CVuEm: } public function register() { } }