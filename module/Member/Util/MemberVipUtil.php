<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use Illuminate\Support\Facades\Cache; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use ModStart\Module\ModuleManager; use Module\Member\Events\MemberUserVipChangeEvent; use Module\Vendor\Util\CacheUtil; class MemberVipUtil { public static function isEnable() { return ModuleManager::getModuleConfig('Member', 'vipEnable', false); } public static function allWithGuest() { goto qKqBm; WjqRv: $BPfSK[] = array('id' => 0, 'title' => '游客'); goto NmDIN; Z496H: return $BPfSK; goto sJ4fG; NmDIN: $BPfSK = array_merge($BPfSK, self::all()); goto Z496H; qKqBm: $BPfSK = array(); goto WjqRv; sJ4fG: } public static function allVisible() { goto SH7bc; R9YDm: return $BPfSK; goto F2dE3; aqreV: $BPfSK = array_values($BPfSK); goto R9YDm; SH7bc: $BPfSK = array_filter(self::all(), function ($Gl_x4) { return $Gl_x4['visible']; }); goto aqreV; F2dE3: } public static function all() { return CacheUtil::rememberForever('MemberVipList', function () { return ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')); }); } public static function update($vWdBd, $XWlC_) { ModelUtil::update('member_vip_set', $vWdBd, $XWlC_); self::clearCache(); } public static function map() { return CacheUtil::rememberForever('MemberVipMap', function () { $VQao2 = array(); foreach (ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')) as $AVLNU) { $VQao2[intval($AVLNU['id'])] = $AVLNU; } return $VQao2; }); } public static function vipsByIds($X0ZF5) { goto c4FVu; b3ino: foreach ($X0ZF5 as $ybqNI) { if (isset($VQao2[$ybqNI])) { $BPfSK[] = $VQao2[$ybqNI]; } } goto OT2vx; c4FVu: $VQao2 = self::map(); goto YF5kR; OT2vx: return $BPfSK; goto bUMhK; YF5kR: $BPfSK = array(); goto b3ino; bUMhK: } public static function mapTitleWithGuest() { goto ZyAmp; RvWwZ: $VQao2[0] = '游客'; goto kt64I; kt64I: foreach (self::map() as $U8G_W => $gghxW) { $VQao2[$U8G_W] = $gghxW['title']; } goto M8HhU; ZyAmp: $VQao2 = array(); goto RvWwZ; M8HhU: return $VQao2; goto hs_Wb; hs_Wb: } public static function mapTitle() { return array_build(self::map(), function ($U8G_W, $gghxW) { return array($U8G_W, $gghxW['title']); }); } public static function getMemberVipById($tJ6XI, $Cc2wA = null, $BHEh0 = null) { $CRCLA = MemberUtil::get($tJ6XI); return self::getMemberVip($CRCLA, $Cc2wA, $BHEh0); } public static function getMemberVipByIdCached($tJ6XI, $Cc2wA = null, $BHEh0 = null) { $CRCLA = MemberUtil::getCached($tJ6XI); return self::getMemberVip($CRCLA, $Cc2wA, $BHEh0); } public static function getMemberVip($CRCLA, $Cc2wA = null, $BHEh0 = null) { goto KZ3jA; KNRWP: if (null === $Cc2wA) { return $Gl_x4; } goto Js_Tu; KZ3jA: if (!empty($CRCLA['vipId']) && (empty($CRCLA['vipExpire']) || strtotime($CRCLA['vipExpire']) > time())) { $Gl_x4 = self::get($CRCLA['vipId']); } else { $Gl_x4 = self::get(null); } goto g_cdx; khFwM: if (empty($Gl_x4)) { return null; } goto KNRWP; g_cdx: if (!empty($CRCLA['vipExpire']) && strtotime($CRCLA['vipExpire']) <= time()) { goto KboWf; eGTID: MemberUtil::update($CRCLA['id'], array('vipId' => $p0Dla, 'vipExpire' => null)); goto ys6fa; ys6fa: if ($p0Dla != $CRCLA['vipId']) { MemberUserVipChangeEvent::fire($CRCLA['id'], $p0Dla, $CRCLA['vipId']); } goto dVMe3; KboWf: $p0Dla = self::defaultVipId(); goto eGTID; dVMe3: } goto khFwM; Js_Tu: return isset($Gl_x4[$Cc2wA]) ? $Gl_x4[$Cc2wA] : $BHEh0; goto N5dUc; N5dUc: } public static function sortRecordsByVipOrder($EnI2D) { goto gbPN0; To1eF: usort($EnI2D, function ($EnX8D, $ioTcP) use($V29wc) { if (isset($V29wc[$EnX8D['vipId']]) && isset($V29wc[$ioTcP['vipId']])) { return $V29wc[$EnX8D['vipId']] - $V29wc[$ioTcP['vipId']]; } else { if (isset($V29wc[$EnX8D['vipId']])) { return -1; } else { if (isset($V29wc[$ioTcP['vipId']])) { return 1; } } } return 0; }); goto fyyKJ; gbPN0: $V29wc = array(0 => 0); goto uXhS0; fyyKJ: return $EnI2D; goto ZtGtg; uXhS0: foreach (MemberVipUtil::all() as $k8Rwr => $gghxW) { $V29wc[$gghxW['id']] = $k8Rwr + 1; } goto To1eF; ZtGtg: } public static function getDefaultVip() { return self::defaultVip(); } public static function defaultVip() { foreach (self::map() as $ybqNI => $Gl_x4) { if (!empty($Gl_x4['isDefault'])) { return $Gl_x4; } } return null; } public static function defaultVipId() { $Gl_x4 = self::defaultVip(); return $Gl_x4 ? $Gl_x4['id'] : null; } public static function get($ybqNI, $Cc2wA = null) { goto re18T; re18T: $VQao2 = self::map(); goto Rwme3; Poa26: return null; goto XVgo1; Rwme3: if (null === $Cc2wA) { if (isset($VQao2[$ybqNI])) { return $VQao2[$ybqNI]; } return self::defaultVip(); } else { goto JGNBC; xOQQf: if (isset($Gl_x4[$Cc2wA])) { return $Gl_x4[$Cc2wA]; } goto d5DPP; ZQGUF: $Gl_x4 = self::defaultVip(); goto xOQQf; JGNBC: if (isset($VQao2[$ybqNI][$Cc2wA])) { return $VQao2[$ybqNI][$Cc2wA]; } goto ZQGUF; d5DPP: } goto Poa26; XVgo1: } public static function calcExpire($Nc4zi, $xy2z0) { goto fVoy1; vkDzu: $BEhU2 = $Pzr2f ? $Pzr2f['vipDays'] : 0; goto y5R2o; y5R2o: $e3gVC = time(); goto pRpnV; fVoy1: $Pzr2f = self::get($xy2z0); goto vkDzu; Hp0bt: return date('Y-m-d', $e3gVC + $BEhU2 * 24 * 3600); goto j0yW2; Jb9kT: if ($Tf2hV > time()) { $e3gVC = $Tf2hV; } goto Hp0bt; pRpnV: $Tf2hV = max(strtotime($Nc4zi), 0); goto Jb9kT; j0yW2: } public static function calcPrice($uLo1Q, $vmwBA, $xy2z0) { goto N9Nz6; wEsFr: $ObrCw = strtotime($vmwBA) > 0 ? strtotime($vmwBA) : 0; goto z7Eb_; rgaW7: $Cs0Qx = 0; goto dygCk; z7Eb_: $u0rBB = null; goto rgaW7; tyghO: $FmMAw = $Pzr2f ? $Pzr2f['price'] : 0; goto emy1k; N9Nz6: $uXqMu = self::get($uLo1Q); goto Axjsy; emy1k: $BEhU2 = $Pzr2f ? $Pzr2f['vipDays'] : 0; goto Px4I4; dygCk: $mhShF = null; goto TOEfm; Axjsy: $Pnux6 = $uXqMu ? $uXqMu['price'] : 0; goto d12oY; pSnuz: return Response::generate(0, 'ok', array('type' => $mhShF, 'expire' => $u0rBB, 'price' => $Cs0Qx)); goto C1Jc7; Px4I4: if (empty($Pzr2f)) { return Response::generate(-1, '数据错误'); } goto wEsFr; TOEfm: if ($uLo1Q == $xy2z0) { goto N_0s2; E4UwT: $Cs0Qx = $Pzr2f['price']; goto a7iKU; N_0s2: $mhShF = '续费会员'; goto N3mNV; N3mNV: $u0rBB = date('Y-m-d', max($ObrCw, time()) + $Pzr2f['vipDays'] * 24 * 3600); goto E4UwT; a7iKU: } else { if ($ObrCw > 0) { goto EJHrU; nF2vZ: $pewOU = max(0, intval(($ObrCw - time()) / (24 * 3600))); goto g_RxT; g_RxT: $x7xMn = $uXqMu['vipDays']; goto RLfz2; EJHrU: $mhShF = '变更会员'; goto Nl7Yp; UZnNK: $Cs0Qx = max(bcsub($Cs0Qx, $YDs_h, 2), 0.01); goto wKUzR; RLfz2: $YDs_h = $x7xMn > 0 ? $uXqMu['price'] * $pewOU / $x7xMn : 0; goto UZnNK; Nl7Yp: $CRjQq = max(time() + $Pzr2f['vipDays'] * 24 * 3600, $ObrCw); goto X5QJi; ydDKq: $Cs0Qx = $Pzr2f['price'] * (($CRjQq - time()) / (24 * 3600)) / $Pzr2f['vipDays']; goto nF2vZ; X5QJi: $u0rBB = date('Y-m-d', $CRjQq); goto ydDKq; wKUzR: } else { goto Wj_lK; Ek6Vq: $u0rBB = date('Y-m-d', time() + $Pzr2f['vipDays'] * 24 * 3600); goto w4NWa; w4NWa: $Cs0Qx = $Pzr2f['price']; goto hPzAr; Wj_lK: $mhShF = '新开会员'; goto Ek6Vq; hPzAr: } } goto pSnuz; d12oY: $h8OSb = $uXqMu ? $uXqMu['vipDays'] : 0; goto SHonK; SHonK: $Pzr2f = self::get($xy2z0); goto tyghO; C1Jc7: } public static function rights() { return Cache::rememberForever('MemberVipRights', function () { $EnI2D = ModelUtil::all('member_vip_right', array(), array('*'), array('sort', 'asc')); AssetsUtil::recordsFixFullOrDefault($EnI2D, 'image'); ModelUtil::decodeRecordsJson($EnI2D, array('vipIds')); return $EnI2D; }); } public static function clearCache() { goto ZLnsG; MoOlj: CacheUtil::forget('MemberVipMap'); goto wj8up; ZLnsG: CacheUtil::forget('MemberVipList'); goto MoOlj; wj8up: CacheUtil::forget('MemberVipRights'); goto HkGaF; HkGaF: } }