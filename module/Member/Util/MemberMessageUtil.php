<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use Illuminate\Support\Facades\View; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use Module\Member\Type\MemberMessageStatus; class MemberMessageUtil { public static function getUnreadMessageCount($qzstR) { if (empty($qzstR)) { return 0; } return ModelUtil::count('member_message', array('userId' => $qzstR, 'status' => MemberMessageStatus::UNREAD)); } public static function setMemberMessageRead($qzstR, $Yb10b = array()) { goto p0A4X; JHpPj: foreach ($Yb10b as $vWdBd) { self::updateMessageCount($vWdBd); } goto CSaov; p0A4X: if (empty($Yb10b)) { return; } goto FV8X6; FV8X6: ModelUtil::model('member_message')->where(array('userId' => $qzstR))->whereIn('id', $Yb10b)->update(array('status' => MemberMessageStatus::READ)); goto JHpPj; CSaov: } public function setMemberMessageReadAll($qzstR) { ModelUtil::model('member_message')->where(array('userId' => $qzstR))->update(array('status' => MemberMessageStatus::READ)); self::updateMessageCount($qzstR); } public static function updateMessageCount($qzstR) { MemberUtil::update($qzstR, array('messageCount' => self::getUnreadMessageCount($qzstR))); } public static function paginate($qzstR, $ZkvUG, $PP9UF, $cD48i = array()) { goto xxzgD; xxzgD: $cD48i['where']['userId'] = $qzstR; goto ISu3i; ISu3i: $NmpUA = ModelUtil::paginate('member_message', $ZkvUG, $PP9UF, $cD48i); goto Mf5kU; Mf5kU: $EnI2D = array(); goto zeTy5; QJ06z: return array('records' => $EnI2D, 'total' => $NmpUA['total']); goto Gf0jZ; zeTy5: foreach ($NmpUA['records'] as $He0J8) { goto kL1rC; aiV_B: $AVLNU['fromId'] = $He0J8['fromId']; goto BlSur; HGdKS: $EnI2D[] = $AVLNU; goto t3rep; BlSur: $AVLNU['content'] = $He0J8['content']; goto K5vab; K5vab: $AVLNU['createTime'] = $He0J8['created_at']; goto HGdKS; oY3UP: $AVLNU['id'] = $He0J8['id']; goto fEKpI; kL1rC: $AVLNU = array(); goto oY3UP; fEKpI: $AVLNU['status'] = $He0J8['status']; goto aiV_B; t3rep: } goto QJ06z; Gf0jZ: } public static function delete($qzstR, $Yb10b = array()) { goto VZ73S; z0ccl: ModelUtil::model('member_message')->whereIn('id', $Yb10b)->where(array('userId' => $qzstR))->delete(); goto RA5M_; VZ73S: if (empty($Yb10b)) { return; } goto nWWzH; nWWzH: if (!is_array($Yb10b)) { $Yb10b = array($Yb10b); } goto z0ccl; RA5M_: self::updateMessageCount($qzstR); goto Xs7WV; Xs7WV: } public static function deleteAll($qzstR) { ModelUtil::model('member_message')->where(array('userId' => $qzstR))->delete(); self::updateMessageCount($qzstR); } public static function update($qzstR, $Yb10b = array(), $Bj5vh = array()) { goto Av30s; Av30s: if (empty($Yb10b) || empty($Bj5vh)) { return; } goto jUDxn; jUDxn: if (!is_array($Yb10b)) { $Yb10b = array($Yb10b); } goto AlBgz; AlBgz: ModelUtil::model('member_message')->whereIn('id', $Yb10b)->where(array('userId' => $qzstR))->update($Bj5vh); goto JQNyM; JQNyM: self::updateMessageCount($qzstR); goto Jbz8T; Jbz8T: } public static function updateRead($qzstR, $Yb10b = array()) { self::update($qzstR, $Yb10b, array('status' => MemberMessageStatus::READ)); self::updateMessageCount($qzstR); } public static function updateReadAll($qzstR) { ModelUtil::model('member_message')->where(array('userId' => $qzstR))->update(array('status' => MemberMessageStatus::READ)); self::updateMessageCount($qzstR); } public static function send($qzstR, $n3GvS, $BVcOi = 0) { goto qRcxV; kRc27: self::updateMessageCount($qzstR); goto B1jqy; qRcxV: ModelUtil::insert('member_message', array('userId' => $qzstR, 'fromId' => $BVcOi, 'status' => MemberMessageStatus::UNREAD, 'content' => $n3GvS)); goto kRc27; B1jqy: return Response::generate(0, null); goto QVqFO; QVqFO: } public static function sendTemplate($tJ6XI, $mPYOc, $NALde = array(), $huOI5 = 0, $NS22k = null) { goto zpRnw; zpRnw: $kmL0f = modstart_config()->getWithEnv('siteTemplate', 'default'); goto GdgNF; ZXN99: if (!view()->exists($tURZC)) { BizException::throws(L('View Not Found : %s', $mPYOc)); } goto H5aEG; yihiB: self::send($tJ6XI, $AF6tQ, $huOI5); goto gIL0B; PpFWK: if (!view()->exists($tURZC)) { $tURZC = 'theme.default.message.' . $mPYOc; if (!view()->exists($tURZC)) { if ($NS22k) { $tURZC = 'module::' . $NS22k . '.View.m.message.' . $mPYOc; if (!view()->exists($tURZC)) { $tURZC = 'module::' . $NS22k . '.View.message.' . $mPYOc; if (!view()->exists($tURZC)) { $tURZC = 'module::' . $NS22k . '.View.pc.message.' . $mPYOc; } } } else { $tURZC = 'module::Member.View.' . $kmL0f . '.message.' . $mPYOc; if (!view()->exists($tURZC)) { $tURZC = 'module::Member.View.default.message.' . $mPYOc; } } } } goto ZXN99; GdgNF: $tURZC = 'theme.' . $kmL0f . '.message.' . $mPYOc; goto PpFWK; H5aEG: $AF6tQ = View::make($tURZC, $NALde)->render(); goto yihiB; gIL0B: } public static function sendTemplateFromView($tURZC, $EU1iR, $tJ6XI, $huOI5 = 0) { goto AfYRH; N4JdM: $AF6tQ = View::make($tURZC, $EU1iR)->render(); goto n9rS0; AfYRH: if (!view()->exists($tURZC)) { throw new \Exception('message view not found : ' . $tURZC); } goto N4JdM; n9rS0: self::send($tJ6XI, $AF6tQ, $huOI5); goto esCBZ; esCBZ: } }