<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Util\IdUtil; use Module\Member\Type\MemberMoneyCashStatus; use Module\Member\Type\MemberMoneyChargeStatus; class MemberMoneyUtil { public static function paginateLog($tJ6XI, $ZkvUG, $PP9UF, $cD48i = array()) { goto bzESE; bzESE: $cD48i['where']['memberUserId'] = $tJ6XI; goto iTHNU; YpNVI: return ModelUtil::paginate('member_money_log', $ZkvUG, $PP9UF, $cD48i); goto vr8XJ; iTHNU: $cD48i['order'] = array('id', 'desc'); goto YpNVI; vr8XJ: } public static function getTotal($tJ6XI) { goto mmqX2; mmqX2: $E1j2M = ModelUtil::get('member_money', array('memberUserId' => $tJ6XI)); goto qD0pW; qD0pW: if (empty($E1j2M)) { return '0.00'; } goto cVuow; cVuow: return $E1j2M['total']; goto J9QJX; J9QJX: } public static function change($tJ6XI, $MBpBZ, $bv12A) { goto XKykR; vPOeq: ModelUtil::update('member_money', array('id' => $E1j2M['id']), array('total' => $E1j2M['total'] + $MBpBZ)); goto mbHW5; X1d_a: if ($MBpBZ < 0 && $E1j2M['total'] + $MBpBZ < 0) { BizException::throws('Member.MoneyChangeUtil -> total change to empty'); } goto sTkxv; sTkxv: ModelUtil::insert('member_money_log', array('memberUserId' => $tJ6XI, 'change' => $MBpBZ, 'remark' => $bv12A)); goto vPOeq; S13a9: if (empty($E1j2M)) { $E1j2M = ModelUtil::insert('member_money', array('memberUserId' => $tJ6XI, 'total' => 0)); } goto X1d_a; XKykR: if (!$MBpBZ) { BizException::throws('Member.MoneyChangeUtil -> change empty'); } goto Hca70; Hca70: $E1j2M = ModelUtil::getWithLock('member_money', array('memberUserId' => $tJ6XI)); goto S13a9; mbHW5: } public static function cash($tJ6XI, $ECp_x, $OB9E8, $mhShF, $ZVX2u, $B5WTe, $bv12A = '余额提现') { self::change($tJ6XI, -$ECp_x, '余额提现'); ModelUtil::insert('member_money_cash', array('memberUserId' => $tJ6XI, 'status' => MemberMoneyCashStatus::VERIFYING, 'money' => $ECp_x, 'moneyAfterTax' => $OB9E8, 'type' => $mhShF, 'realname' => $ZVX2u, 'account' => $B5WTe, 'remark' => $bv12A)); } public static function paginateCash($tJ6XI, $ZkvUG, $PP9UF, $cD48i = array()) { $cD48i['where']['memberUserId'] = $tJ6XI; return ModelUtil::paginate('member_money_cash', $ZkvUG, $PP9UF, $cD48i); } public static function createCharge($tJ6XI, $cNB0p) { return ModelUtil::insert('member_money_charge', array('sn' => IdUtil::generateSN(), 'status' => MemberMoneyChargeStatus::CREATED, 'memberUserId' => $tJ6XI, 'fee' => $cNB0p)); } public static function processCharge($ny1E9) { goto Na9Mc; Na9Mc: $qTtEs = ModelUtil::getWithLock('member_money_charge', array('id' => $ny1E9)); goto Mh5Yi; wswB_: if ($qTtEs['status'] != MemberMoneyChargeStatus::CREATED) { throw new \Exception('member_money_charge status error -> ' . $ny1E9); } goto ILpgR; Mh5Yi: if (empty($qTtEs)) { throw new \Exception('member_money_charge empty -> ' . $ny1E9); } goto wswB_; ILpgR: self::change($qTtEs['memberUserId'], $qTtEs['fee'], '充值'); goto BAURV; BAURV: ModelUtil::update('member_money_charge', array('id' => $ny1E9), array('status' => MemberMoneyChargeStatus::SUCCESS)); goto GA4eQ; GA4eQ: } }