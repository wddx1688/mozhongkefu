<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Api\Controller; use Illuminate\Routing\Controller; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use Module\Member\Auth\MemberUser; use Module\Member\Auth\MemberVip; use Module\Member\Core\MemberVipPayCenterBiz; use Module\Member\Support\MemberLoginCheck; use Module\Member\Util\MemberVipUtil; use Module\PayCenter\Support\PayCenterPerform; use Module\Vendor\Type\OrderStatus; class MemberVipController extends Controller implements MemberLoginCheck { public static $memberLoginCheckIgnores = array('info', 'calc'); public function info() { goto XDlyb; XDlyb: $XWlC_ = array(); goto PeCQU; iZDXD: $XWlC_['subTitle'] = modstart_config('Member_VipSubTitle'); goto CrHrh; PeCQU: $XWlC_['title'] = modstart_config('Member_VipTitle'); goto iZDXD; RRVMA: $XWlC_['rights'] = MemberVipUtil::rights(); goto bWgCa; R62hO: $XWlC_['vips'] = MemberVipUtil::allVisible(); goto RRVMA; bWgCa: return Response::generateSuccessData($XWlC_); goto bDBKd; CrHrh: $XWlC_['content'] = modstart_config('Member_VipContent'); goto R62hO; bDBKd: } public function all() { return Response::generateSuccessData(MemberVipUtil::allVisible()); } public function buy() { goto IAXKI; ST18B: if (empty($ybqNI)) { return Response::generateError('请选择会员类型'); } goto x_xOu; U3c3e: $TPM1W = app(PayCenterPerform::class); goto RvjrC; x_xOu: $bKLUw = MemberVipUtil::get($ybqNI); goto gS_Yw; GhE2S: BizException::throwsIf('请安装 PayCenter 模块', !modstart_module_enabled('PayCenter')); goto U3c3e; IAXKI: $ErQts = InputPackage::buildFromInput(); goto KQVD7; IIhUN: $zhPU7 = ModelUtil::insert('member_vip_order', array('status' => OrderStatus::WAIT_PAY, 'memberUserId' => MemberUser::id(), 'vipId' => $bKLUw['id'], 'payFee' => $ECp_x, 'expire' => $Jty9h['data']['expire'], 'type' => $Jty9h['data']['type'])); goto GhE2S; iv1Cf: if ($Jty9h['code']) { return Response::generateError($Jty9h['msg']); } goto r6zlL; gS_Yw: if (empty($bKLUw)) { return Response::generateError('请选择会员类型'); } goto g4bKA; g4bKA: $Jty9h = $this->calc($ybqNI); goto iv1Cf; r6zlL: $ECp_x = $Jty9h['data']['price']; goto nTpOD; nTpOD: if ($ECp_x < 0.01) { return Response::generateError('支付金额为空0.01'); } goto IIhUN; KQVD7: $ybqNI = $ErQts->getInteger('vipId'); goto ST18B; RvjrC: return $TPM1W->performSubmitOrder(MemberVipPayCenterBiz::NAME, $zhPU7['id'], $zhPU7['payFee'], '购买会员'); goto jcWEd; jcWEd: } public function calc($ybqNI = 0) { goto ktIr8; oDsaJ: if (MemberUser::isNotLogin()) { return Response::generate(0, 'ok', array('type' => '-', 'expire' => '-', 'price' => '-')); } goto Lymss; Lymss: $bKLUw = MemberVip::get(); goto E5fRG; zBha5: return Response::generateSuccessData($FZUh3['data']); goto l9vaQ; JhxKY: if ($FZUh3['code']) { return Response::generateError($FZUh3['msg']); } goto zBha5; quoD5: if (empty($ybqNI)) { return Response::generateError('请选择会员'); } goto C6h7f; ktIr8: $ErQts = InputPackage::buildFromInput(); goto oDsaJ; E5fRG: if (empty($ybqNI)) { $ybqNI = $ErQts->getInteger('vipId'); } goto quoD5; C6h7f: $FZUh3 = MemberVipUtil::calcPrice($bKLUw ? $bKLUw['id'] : 0, MemberUser::get('vipExpire'), $ybqNI); goto JhxKY; l9vaQ: } }