<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use ModStart\Form\Form; use ModStart\Module\ModuleManager; use ModStart\Support\Concern\HasFields; use Module\Member\Config\MemberOauth; use Module\Member\Type\MemberPasswordStrength; use Module\Member\Util\MemberDataStatisticUtil; use Module\Member\Util\MemberParamUtil; use Module\Vendor\Provider\Captcha\CaptchaProvider; class ConfigController extends Controller { public static $PermitMethodMap = array('param' => '*', 'dataStatistic' => '\\Module\\Member\\Admin\\Controller\\MemberController@index'); public function setting(AdminConfigBuilder $U2qv4) { goto lHQ1p; Dlzth: if (ModuleManager::getModuleConfig('Member', 'dataStatisticEnable', false)) { $U2qv4->layoutPanel('存储上传', function ($U2qv4) { $U2qv4->switch('Member_DataStatisticEnable', '开启上传限制')->when('=', true, function ($U2qv4) { $U2qv4->number('Member_DataStatisticDefaultLimit', '默认空间大小')->help('用户的默认空间大小，单位MB，默认为1024')->defaultValue(1024); }); }); } goto rbJ6q; rbJ6q: $U2qv4->formClass('wide'); goto tM62T; X3oJs: $U2qv4->showReset(false)->showSubmit(false); goto VGmsQ; VGmsQ: return $U2qv4->perform(); goto OqpG6; BFNO3: $U2qv4->pageTitle('功能设置'); goto Tr5BZ; wmoB3: $U2qv4->disableBoxWrap(true); goto X3oJs; Tr5BZ: $U2qv4->layoutPanel('登录', function ($U2qv4) use($lJ4Vo) { $U2qv4->switch('loginCaptchaEnable', '启用登录验证码')->when('=', true, function (Form $yAhCR) use($lJ4Vo) { $yAhCR->select('loginCaptchaProvider', '登录验证码类型')->options($lJ4Vo)->help('用于 用户名密码登录（/login）、短信验证登录（/login/phone） 的人机验证'); }); $gxtzY = array('default' => '用户名密码登录 /login', 'phone' => '短信验证登录 /login/phone'); if (modstart_module_enabled('MemberOauth')) { $gxtzY['wechat'] = '微信授权登录 /login/wechat'; } if (modstart_config('ssoClientEnable', false)) { $gxtzY['sso'] = 'SSO单点登录 /login/sso'; } if (modstart_module_enabled('MemberWechatMpLogin')) { $gxtzY['other'] = '扫码登录方式 /login/other'; } $U2qv4->select('Member_LoginDefault', '默认登录方式')->options($gxtzY); $U2qv4->switch('Member_LoginPhoneEnable', '启用短信验证登录')->when('=', true, function (Form $yAhCR) { $yAhCR->switch('Member_LoginPhoneAutoRegister', '短信验证登录自动注册')->help('开启后，短信验证登录遇用户不存在则自动注册，关闭表示手机号不存在不能登录')->when('=', true, function (Form $yAhCR) { $yAhCR->text('Member_LoginPhoneNameSuggest', '短信验证登录用户名')->defaultValue('用户')->help(join('', array('<p>默认为 <span class="ub-text-warning">用户</span>，用户注册后自动设置用户名和昵称为 <span class="ub-text-warning">用户xxxx</span></p>', '<p>可使用占位符，如 <span class="ub-text-warning">用户{Phone}</span> 表示注册后自动设置为 <span class="ub-text-warning">用户+手机号</span>，用户名如遇冲突将会自动追加随机字符串</p>', '<p>其它可用占位符：<span class="ub-text-warning">{Phone}</span> 用户手机、<span class="ub-text-warning">{Phone4}</span> 手机后4位、<span class="ub-text-warning">{Uid}</span> 用户ID</p>'))); }); })->help('开启短信验证登录 /login/phone'); }); goto ltqOx; vfLjy: $U2qv4->layoutPanel('账号安全', function ($U2qv4) { $U2qv4->switch('Member_ProfileEmailEnable', '开启邮箱绑定')->help('启用后用户中心增加邮箱绑定页面'); $U2qv4->switch('Member_ProfilePhoneEnable', '开启手机绑定')->help('启用后用户中心增加手机绑定页面'); $U2qv4->switch('Member_LoginRedirectCheckEnable', '登录后跳转安全验证')->when('=', true, function ($U2qv4) { $U2qv4->textarea('Member_LoginRedirectWhiteList', '白名单')->placeholder('请输入域名白名单，每行一个，如：www.example.com'); }); $U2qv4->switch('Member_DeleteEnable', '启用自助注销账号')->help('开启后，用户中心可自主申请注销账号。用户注销账号后，用户名会重置为随机字符串，已绑定的手机、邮箱均会解绑'); $U2qv4->radio('Member_PasswordStrength', '密码强度')->optionType(MemberPasswordStrength::class)->defaultValue(MemberPasswordStrength::NO_LIMIT); $U2qv4->number('Member_PasswordLengthMin', '密码最小长度')->defaultValue(0)->help('0表示不限制，推荐为8位以上'); }); goto Dlzth; lHQ1p: $lJ4Vo = array_merge(array('' => '默认'), CaptchaProvider::nameTitleMap()); goto BFNO3; tM62T: $U2qv4->contentFixedBottomContentSave(); goto wmoB3; ltqOx: $U2qv4->layoutPanel('注册', function ($U2qv4) use($lJ4Vo) { $U2qv4->select('Member_RegisterCaptchaProvider', '注册验证码类型')->options($lJ4Vo)->help('用于 普通注册（/register）、短信验证注册（/register/phone） 的人机验证'); $U2qv4->switch('registerDisable', '禁用注册')->when('!=', true, function ($U2qv4) { $U2qv4->select('Member_RegisterDefault', '默认注册方式')->options(array('default' => '普通注册 /register', 'phone' => '短信验证注册 /register/phone')); $U2qv4->switch('Member_RegisterPhoneEnable', '启用短信验证注册')->help('开启短信验证注册 /register/phone')->when('=', true, function (Form $yAhCR) { $yAhCR->switch('Member_RegisterPhonePasswordEnable', '短信验证注册设置密码'); }); $U2qv4->switch('registerEmailEnable', '普通注册时填写邮箱'); $U2qv4->switch('registerPhoneEnable', '普通注册时填写手机'); })->when('=', true, function ($U2qv4) { if (MemberOauth::hasItems()) { $U2qv4->switch('registerOauthEnable', '允许以授权方式注册'); } })->help('禁用后，可通过后台增加账号'); if (MemberOauth::hasItems()) { $U2qv4->switch('Member_OauthBindAuto', '授权登录自动绑定账号')->when('=', false, function ($U2qv4) { $U2qv4->switch('Member_OauthBindPhoneEnable', '授权登录需绑定手机'); $U2qv4->switch('Member_OauthBindEmailEnable', '授权登录需绑定邮箱'); }, array('type' => 'boolean'))->help('授权登录后需要用户二次确认绑定账号，开启后将自动绑定账号')->defaultValue(false); } $U2qv4->number('Member_UsernameMinLength', '用户名最小长度')->defaultValue(3); }); goto aFH1V; aFH1V: $U2qv4->layoutPanel('找回密码', function ($U2qv4) { $U2qv4->switch('retrieveDisable', '禁用找回密码')->when('!=', true, function ($U2qv4) { $U2qv4->switch('retrievePhoneEnable', '启用手机找回密码'); $U2qv4->switch('retrieveEmailEnable', '启用邮箱找回密码'); }); }); goto vfLjy; OqpG6: } public function agreement(AdminConfigBuilder $U2qv4) { goto CArFp; LjwJa: return $U2qv4->perform(); goto OP26m; YmSZG: $U2qv4->switch('Member_AgreementEnable', '用户使用协议开启')->when('=', true, function ($U2qv4) { $U2qv4->text('Member_AgreementTitle', '用户使用协议标题')->help('默认为 用户使用协议'); $U2qv4->richHtml('Member_AgreementContent', '用户使用协议内容'); }); goto PZQn5; DKWQ6: $U2qv4->formClass('wide'); goto LjwJa; CArFp: $U2qv4->pageTitle('用户协议'); goto YmSZG; PZQn5: $U2qv4->switch('Member_PrivacyEnable', '用户隐私协议开启')->when('=', true, function ($U2qv4) { $U2qv4->text('Member_PrivacyTitle', '用户隐私协议标题')->help('默认为 用户隐私协议'); $U2qv4->richHtml('Member_PrivacyContent', '用户隐私协议内容'); }); goto DKWQ6; OP26m: } public function money(AdminConfigBuilder $U2qv4) { goto BSDVk; EEUlh: return $U2qv4->perform(); goto kBYXf; oiLYj: $U2qv4->richHtml('Member_MoneyChargeDesc', '钱包充值说明'); goto sJYwR; sJYwR: $U2qv4->formClass('wide'); goto EEUlh; FHGzq: $U2qv4->switch('Member_MoneyCashEnable', '开启用户提现')->when('=', 1, function (Form $yAhCR) { $yAhCR->number('Member_MoneyCashMin', '最小提现金额')->help('默认为 100'); $yAhCR->number('Member_MoneyCashTaxRate', '用户提现手续费')->help('如 1.00 表示手续费为 1.00%'); $yAhCR->richHtml('Member_MoneyCashDescription', '用户提现说明'); }); goto ZVmzW; ZVmzW: $U2qv4->switch('Member_MoneyChargeEnable', '开启钱包充值'); goto oiLYj; BSDVk: $U2qv4->pageTitle('钱包设置'); goto FHGzq; kBYXf: } public function message(AdminConfigBuilder $U2qv4) { goto aoKTU; ebkYk: $U2qv4->richHtml('Member_Registered_Email', '注册成功邮件')->help(MemberParamUtil::paramTitle()); goto P7s4J; miGDr: $U2qv4->richHtml('Member_Registered_Message', '注册成功站内信')->help(MemberParamUtil::paramTitle()); goto n1lQ_; aoKTU: $U2qv4->pageTitle('消息设置'); goto miGDr; P7s4J: $U2qv4->formClass('wide'); goto QupMF; n1lQ_: $U2qv4->text('Member_Registered_EmailTitle', '注册成功邮件标题')->help(MemberParamUtil::paramTitle()); goto ebkYk; QupMF: return $U2qv4->perform(); goto wHXnp; wHXnp: } public function dataStatistic() { goto LK4yx; Qy8aH: return Response::generateSuccess('保存成功'); goto c3HyD; tar80: $XWlC_['sizeLimit'] = $ErQts->getInteger('sizeLimit'); goto Sf1IC; LK4yx: AdminPermission::demoCheck(); goto HOCEg; YsWpS: $XWlC_ = array(); goto tar80; Sf1IC: MemberDataStatisticUtil::updateMemberUser($tJ6XI, $XWlC_); goto Qy8aH; HOCEg: $ErQts = InputPackage::buildFromInput(); goto bMR8k; bMR8k: $tJ6XI = $ErQts->getInteger('memberUserId'); goto YsWpS; c3HyD: } public function param() { return view('module::Member.View.admin.config.param'); } }