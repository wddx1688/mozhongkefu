<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\View; use ModStart\App\Web\Layout\WebConfigBuilder; use ModStart\App\Web\Layout\WebPage; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\CRUDUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Form\Form; use ModStart\Grid\Grid; use ModStart\Grid\GridFilter; use ModStart\Module\ModuleManager; use ModStart\Repository\Filter\RepositoryFilter; use Module\Member\Auth\MemberUser; use Module\Member\Support\MemberLoginCheck; class MemberAddressController extends MemberFrameController implements MemberLoginCheck { private $api; public function __construct() { parent::__construct(); $this->api = app(\Module\Member\Api\Controller\MemberAddressController::class); } public function index(WebPage $ZkvUG) { goto FdTP7; rNH85: list($tURZC, $HdyS4) = $this->viewPaths('memberAddress.index'); goto bOm_e; FdTP7: $qCqqU = Grid::make('member_address'); goto fduQz; KOi3n: $qCqqU->title('地址'); goto ybuVS; xfhJq: $qCqqU->disableCUD()->disableItemOperate()->canAdd(true)->urlAdd(action('\\' . __CLASS__ . '@add'))->addDialogSize(array('60%', '80%')); goto rBLXu; rBLXu: $qCqqU->useSimple(function (AbstractField $E9h4W, $AVLNU, $oPu4k) { return AutoRenderedFieldValue::makeView('module::Member.View.pc.memberAddress.item', array('item' => $AVLNU)); }); goto KOi3n; fduQz: $qCqqU->repositoryFilter(function (RepositoryFilter $RryBq) { $RryBq->where(array('memberUserId' => MemberUser::id())); }); goto xfhJq; ybuVS: if (Request::isPost()) { return $qCqqU->request(); } goto rNH85; bOm_e: return $ZkvUG->view($tURZC)->pageTitle('我的地址')->body($qCqqU); goto dtHoa; dtHoa: } private function doAddEdit() { goto SRIL9; v7XtZ: $U2qv4->pageTitle(($vWdBd ? '修改' : '增加') . '地址'); goto Lj5jZ; SHTs4: $U2qv4 = app(WebConfigBuilder::class); goto Ueqxf; x1aAI: $U2qv4->text('phone', '手机号')->required(); goto Y3bv5; WZ3rc: $U2qv4->textarea('detail', '详细地址')->required(); goto V2YEb; V2YEb: $U2qv4->text('post', '邮政编码'); goto pDYt3; HDqzK: if ($vWdBd) { $He0J8 = ModelUtil::get('member_address', array('id' => $vWdBd, 'memberUserId' => MemberUser::id())); BizException::throwsIfEmpty('地址不存在', $He0J8); } goto SHTs4; Lj5jZ: $U2qv4->text('name', '姓名')->required(); goto x1aAI; Y3bv5: if (modstart_module_enabled('Area')) { $U2qv4->areaChina('area', '省市地区')->required(); } else { $ZpNyF = '<div class=\'tw-bg-gray-200 tw-rounded tw-px-2\'>省市地区需要依赖 <a href=\'https://modstart.com/m/Area\' target=\'_blank\'>Area</a> 模块</div>'; $U2qv4->html('area', '省市地区')->html($ZpNyF)->addable(true)->required(); } goto WZ3rc; pDYt3: return $U2qv4->perform(ArrayUtil::keepKeys($He0J8, array('name', 'phone', 'area', 'detail', 'post')), function (Form $yAhCR) use($vWdBd) { $XWlC_ = $yAhCR->dataForming(); if ($vWdBd) { ModelUtil::update('member_address', $vWdBd, $XWlC_); } else { $XWlC_['memberUserId'] = MemberUser::id(); ModelUtil::insert('member_address', $XWlC_); } return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto J7sYt; XhuGP: $He0J8 = null; goto HDqzK; Ueqxf: $U2qv4->useDialog(); goto v7XtZ; SRIL9: $vWdBd = CRUDUtil::id(); goto XhuGP; J7sYt: } public function add() { return $this->doAddEdit(); } public function edit() { return $this->doAddEdit(); } public function delete() { goto Hx2zZ; tv2P3: return Response::redirect(CRUDUtil::jsGridRefresh()); goto gHgFO; fxGRd: ModelUtil::delete('member_address', $vWdBd); goto tv2P3; Hx2zZ: $vWdBd = CRUDUtil::id(); goto T2ZaA; T2ZaA: $He0J8 = ModelUtil::get('member_address', array('id' => $vWdBd, 'memberUserId' => MemberUser::id())); goto MdNEf; MdNEf: BizException::throwsIfEmpty('地址不存在', $He0J8); goto fxGRd; gHgFO: } }