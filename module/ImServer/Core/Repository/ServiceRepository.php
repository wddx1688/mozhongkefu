<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ImServer\Core\Repository; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use Module\ImServer\Constant\ImRedisConstant; use Module\ImServer\Core\GatewayUtil; use Module\ImServer\Core\Message\ChatMsg; use Module\ImServer\Core\Model\ServiceModel; use Module\ImServer\Type\ImMsgType; use Module\ImServer\Type\ImPushType; use Module\ImServer\Type\ImServiceStatus; class ServiceRepository { public static function addServiceUser($FWfay, $qzstR) { RedisRepository::sadd(sprintf(ImRedisConstant::SERVICE_USER_SET, $FWfay), $qzstR); } public static function listServiceUsers($FWfay) { return RedisRepository::smembers(sprintf(ImRedisConstant::SERVICE_USER_SET, $FWfay)); } public static function transfer($FWfay, $IZ3Sg) { goto OKqyb; s19fr: ServiceModel::update($FWfay, array('serviceUserId' => $IZ3Sg, 'status' => ImServiceStatus::QUEUE)); goto XPfWB; vKUjF: ServiceModel::removeUser($FhRrv['id'], $FhRrv['serviceUserId']); goto s19fr; OKqyb: $FhRrv = ServiceModel::get($FWfay); goto vKUjF; XPfWB: } public static function pushQueueToUsers($a8qgs, $swc4I) { goto B73cj; OI7D5: $NmpUA = ServiceModel::paginateQueue($a8qgs, 1, 10); goto MyXT9; B73cj: if (!is_array($swc4I)) { $swc4I = array($swc4I); } goto OI7D5; Mo01E: PushRepository::toUsers($swc4I, $miOiF); goto EQwBX; LwAc3: $miOiF->data(array('type' => ImPushType::ServiceQueueList, 'data' => $NmpUA)); goto Mo01E; MyXT9: $miOiF = ChatMsg::make(ImMsgType::PUSH); goto LwAc3; EQwBX: } public static function pushQueueToBizUsers($a8qgs, $UegGl, $rlYPX) { goto AL0mM; neNfG: PushRepository::toBizUsers($UegGl, $rlYPX, $miOiF); goto M9zu5; xuWin: $miOiF = ChatMsg::make(ImMsgType::PUSH); goto cOOYD; AL0mM: $NmpUA = ServiceModel::paginateQueue($a8qgs, 1, 10); goto xuWin; cOOYD: $miOiF->data(array('type' => ImPushType::ServiceQueueList, 'data' => $NmpUA)); goto neNfG; M9zu5: } public static function pushQueueToClient($a8qgs, $U1CFU, $ZkvUG, $PP9UF) { goto EgDCP; KwjC4: $miOiF->data(array('type' => ImPushType::ServiceQueueList, 'data' => $NmpUA)); goto XREyC; XREyC: GatewayUtil::send($U1CFU, $miOiF); goto g9YiW; EgDCP: $NmpUA = ServiceModel::paginateQueue($a8qgs, $ZkvUG, $PP9UF); goto J6WQF; J6WQF: $miOiF = ChatMsg::make(ImMsgType::PUSH); goto KwjC4; g9YiW: } public static function pushProcessingToClient($a8qgs, $qzstR, $U1CFU, $ZkvUG = 1, $PP9UF = 10) { goto hJ8ld; hJ8ld: $NmpUA = ServiceModel::paginateProcessing($a8qgs, $qzstR, $ZkvUG, $PP9UF); goto LFJUi; JM9QQ: $miOiF->data(array('type' => ImPushType::ServiceProcessingList, 'data' => $NmpUA)); goto ayZyU; ayZyU: GatewayUtil::send($U1CFU, $miOiF); goto ktnMS; LFJUi: $miOiF = ChatMsg::make(ImMsgType::PUSH); goto JM9QQ; ktnMS: } public static function pushProcessedToClient($a8qgs, $qzstR, $U1CFU, $ZkvUG, $PP9UF) { goto TbxWa; Zw7DK: $miOiF->data(array('type' => ImPushType::ServiceProcessedList, 'data' => $NmpUA)); goto KOwTP; TbxWa: $NmpUA = ServiceModel::paginateProcessed($a8qgs, $qzstR, $ZkvUG, $PP9UF); goto NbO65; NbO65: $miOiF = ChatMsg::make(ImMsgType::PUSH); goto Zw7DK; KOwTP: GatewayUtil::send($U1CFU, $miOiF); goto ZoNd2; ZoNd2: } public static function processingRequest($qzstR, $FWfay) { goto bz8ls; Lothv: return Response::generateSuccess(); goto wBd8P; bz8ls: ModelUtil::transactionBegin(); goto ztEm6; N8eRW: if ($FhRrv['status'] != ImServiceStatus::QUEUE) { ModelUtil::transactionCommit(); return Response::generateError('已经被其他客服接待'); } goto BoHPI; cyOPA: ModelUtil::transactionCommit(); goto Lothv; ztEm6: $FhRrv = ModelUtil::getWithLock('im_service', $FWfay); goto N8eRW; BoHPI: ModelUtil::update('im_service', $FWfay, array('status' => ImServiceStatus::PROCESSING, 'serviceUserId' => $qzstR)); goto AUwDM; AUwDM: ServiceModel::addUserIfMissing($FWfay, $qzstR); goto cyOPA; wBd8P: } }