<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ImServer\Command; use GatewayWorker\BusinessWorker; use GatewayWorker\Gateway; use GatewayWorker\Register; use Illuminate\Console\Command; use ModStart\Core\Exception\BizException; use Module\ImServer\Core\Amqp\AmqpFactory; use Module\ImServer\Core\Consumer\ChatMsgConsumer; use Module\ImServer\Core\Handler\WebsocketHandler; use Module\ImServer\Core\Message\ChatMsg; use Module\ImServer\Core\Repository\LogRepository; use Workerman\Worker; class ImServerWorkerCommand extends Command { protected $signature = 'im-server:worker {action} {--daemon}'; public function handle() { goto rYvei; pAysH: $JfN5N = new Gateway("Websocket://0.0.0.0:{$nV6rg}"); goto JIF7G; Uo86g: $aF4D_ = array($yA25I); goto Nw2Zc; rrAJV: $SdxVO->name = 'ImServerBusinessWorker'; goto E60rS; mD9gK: $ZHRnN = new Worker(); goto gyZbE; rYvei: global $aF4D_; goto PgCmK; dWFce: Worker::$pidFile = storage_path('ImServerWorker.lock'); goto f7E9G; E60rS: $SdxVO->count = $WUEbo; goto x645h; AaVIt: $SdxVO->eventHandler = WebsocketHandler::class; goto mD9gK; VqH2j: Worker::runAll(); goto keTta; gyZbE: $ZHRnN->name = 'ImServerConsumer'; goto grVe2; f7E9G: Worker::$logFile = storage_path('logs/ImServerWorker.log'); goto VqH2j; wJmon: $JfN5N->lanIp = env('IM_SERVER_GATEWAY_LAN_IP', '127.0.0.1'); goto amZ4X; rQv6Z: $xzBqW = intval(env('IM_SERVER_GATEWAY_PROCESS_COUNT', 2)); goto PTEkZ; NyMC3: $JfN5N->count = $xzBqW; goto Rx782; rMxE2: $ZHRnN->onWorkerStart = function () { AmqpFactory::make()->listen(function ($AF6tQ) { LogRepository::log('Consumer ', $AF6tQ); $miOiF = ChatMsg::parse($AF6tQ); $UR3Zf = 'on' . ucfirst($miOiF->type()); if (!method_exists(ChatMsgConsumer::class, $UR3Zf)) { LogRepository::error('Consumer  - NotSupport', $UR3Zf); } else { call_user_func_array(array(ChatMsgConsumer::class, $UR3Zf), array($miOiF)); } }); }; goto Uo86g; koh2f: $mTfIT = intval(env('IM_SERVER_REGISTER_PORT', 4029)); goto anWes; anWes: $nV6rg = intval(env('IM_SERVER_GATEWAY_PORT', 4050)); goto GSuY0; PgCmK: $yA25I = $this->argument('action'); goto At4sV; PTEkZ: $WUEbo = intval(env('IM_SERVER_BUSINESS_WORKER_COUNT', 4)); goto M3KKP; JIF7G: $JfN5N->name = 'ImServerGateway'; goto Ejhdb; Rx782: $SdxVO = new BusinessWorker(); goto rrAJV; amZ4X: $JfN5N->startPort = $rifmj; goto NyMC3; GSuY0: $rifmj = intval(env('IM_SERVER_GATEWAY_PORT_START', 4030)); goto rQv6Z; M3KKP: $U7iOM = new Register("text://0.0.0.0:{$mTfIT}"); goto xTnvL; Nw2Zc: if ($this->option('daemon')) { $aF4D_[] = '-d'; } goto dWFce; xTnvL: $yXmHx = "127.0.0.1:{$mTfIT}"; goto pAysH; Ejhdb: $JfN5N->registerAddress = $yXmHx; goto wJmon; At4sV: BizException::throwsIf('action error (start|stop|reload)', !in_array($yA25I, array('start', 'stop', 'reload'))); goto koh2f; x645h: $SdxVO->registerAddress = $yXmHx; goto AaVIt; grVe2: $ZHRnN->count = 1; goto rMxE2; keTta: } }