<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\ImServer\Api\Controller; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Response; use Module\ImServer\Core\Model\ChatRecordModel; use Module\ImServer\Core\Model\ServiceModel; use Module\ImServer\Core\Repository\UnreadMsgRepository; use Module\ImServer\Type\ImChatType; use Module\ImServer\Type\ImServiceStatus; class ServiceController extends AbstractUserBaseController { public function get() { goto xDIVh; x103I: $FWfay = $ErQts->getInteger('serviceId'); goto Yjc0U; lIHuc: return Response::generateSuccessData(array('service' => $FhRrv, 'creatorUser' => $NXMc1, 'users' => $jo_Nl)); goto A38fM; dn1xE: BizException::throwsIfEmpty('Service用户不存在', $zcWCd); goto SP_t0; yFTmF: $jo_Nl = ModelUtil::allIn('im_user', 'id', $ATQc3); goto ObgzW; pkz6H: $ATQc3 = ModelUtil::values('im_service_user', 'userId', array('serviceId' => $FWfay)); goto yFTmF; ObgzW: $EvmEZ = array_build($jo_Nl, function ($U8G_W, $gghxW) { return array($gghxW['id'], $gghxW); }); goto QZa5T; mKoxq: $FhRrv['_unreadTalkCount'] = UnreadMsgRepository::get(ImChatType::SERVICE, $FhRrv['id'], $this->userId()); goto lIHuc; QZa5T: $NXMc1 = isset($EvmEZ[$FhRrv['creatorUserId']]) ? $EvmEZ[$FhRrv['creatorUserId']] : null; goto mKoxq; SP_t0: $FhRrv = ServiceModel::get($FWfay); goto emEFm; xDIVh: $ErQts = InputPackage::buildFromInput(); goto x103I; emEFm: BizException::throwsIfEmpty('Service不存在', $zcWCd); goto pkz6H; Yjc0U: $zcWCd = ServiceModel::getUser($FWfay, $this->userId()); goto dn1xE; A38fM: } public function history() { goto OAPK5; RI97z: return Response::generateSuccessData(array('records' => $EnI2D)); goto Z7elZ; ttgCo: $EnI2D = ChatRecordModel::history(ImChatType::SERVICE, $FWfay, $LIhQG, $FijOM, $hprYL); goto RI97z; OAPK5: $ErQts = InputPackage::buildFromInput(); goto eEA00; ViiYp: BizException::throwsIfEmpty('Service用户不存在', $zcWCd); goto qpse1; C8akP: $hprYL = $ErQts->getInteger('maxId', -1); goto xGlDm; xGlDm: $LIhQG = $ErQts->getInteger('limit', 100); goto ttgCo; eEA00: $FWfay = $ErQts->getInteger('serviceId'); goto TwugV; qpse1: $FijOM = $ErQts->getInteger('minId', -1); goto C8akP; TwugV: $zcWCd = ServiceModel::getUser($FWfay, $this->userId()); goto ViiYp; Z7elZ: } public function processed() { goto ibsMt; t1Am9: return Response::generateSuccess(); goto IgnJm; Hxt58: $zcWCd = ServiceModel::getUser($FWfay, $this->userId()); goto v6gGS; k1Dqm: BizException::throwsIf('不是您的客户不能结单', $FhRrv['serviceUserId'] != $this->userId()); goto eqMGF; bTf22: $FWfay = $ErQts->getInteger('serviceId'); goto Hxt58; efPKy: BizException::throwsIfEmpty('Service不存在', $zcWCd); goto k1Dqm; Kf1dm: $FhRrv = ServiceModel::get($FWfay); goto efPKy; ibsMt: $ErQts = InputPackage::buildFromInput(); goto bTf22; v6gGS: BizException::throwsIfEmpty('Service用户不存在', $zcWCd); goto Kf1dm; eqMGF: ServiceModel::updateStatus($FhRrv['id'], ImServiceStatus::PROCESSED); goto t1Am9; IgnJm: } }