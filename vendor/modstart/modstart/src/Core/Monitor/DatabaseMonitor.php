<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Core\Monitor; use Illuminate\Database\Events\QueryExecuted; use Illuminate\Support\Facades\DB; use Illuminate\Support\Facades\Log; use ModStart\Core\Util\ArrayUtil; class DatabaseMonitor { private static $queryCountPerRequest = 0; private static $queryCountPerRequestSqls = array(); public static function init() { goto vwnno; BuYwk: try { DB::listen(function ($IpOIw, $soYF4 = null, $FU6n6 = null, $tztl4 = null) { self::$queryCountPerRequest++; $N4nxN = $IpOIw; if (method_exists(\ModStart\ModStart::class, 'env') && \ModStart\ModStart::env() == 'laravel9') { goto llcs0; bg5Iz: $FU6n6 = $IpOIw->time; goto W0dJU; dTP5m: $soYF4 = $IpOIw->bindings; goto bg5Iz; llcs0: $N4nxN = $IpOIw->sql; goto dTP5m; W0dJU: } self::$queryCountPerRequestSqls[] = array('sql' => $N4nxN, 'bindings' => $soYF4); if ($FU6n6 > config('modstart.trackLongSqlThreshold', 5000)) { Log::warning("LONG_SQL {$FU6n6}ms, {$N4nxN}, " . ArrayUtil::serializeForLog($soYF4)); } }); } catch (\Exception $l8i0J) { } goto tc7Ub; vwnno: if (!config('modstart.trackPerformance', false)) { return; } goto Z9qa1; Z9qa1: self::$queryCountPerRequest = 0; goto uJVLd; uJVLd: self::$queryCountPerRequestSqls = array(); goto BuYwk; tc7Ub: } public static function getQueryCountPerRequest() { return self::$queryCountPerRequest; } public static function getQueryCountPerRequestSqls() { foreach (self::$queryCountPerRequestSqls as $qsK6T => $yFWLi) { if (is_array($yFWLi)) { $soYF4 = ArrayUtil::serializeForLog($yFWLi['bindings']); self::$queryCountPerRequestSqls[$qsK6T] = $yFWLi['sql'] . ', ' . $soYF4; } } return self::$queryCountPerRequestSqls; } }