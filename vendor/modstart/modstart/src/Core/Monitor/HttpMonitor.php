<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Core\Monitor; use Illuminate\Http\Request; use Illuminate\Http\Response; use Illuminate\Support\Facades\Event; use Illuminate\Support\Facades\Log; use ModStart\Core\Events\ModStartRequestHandled; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\EventUtil; use ModStart\Core\Util\SerializeUtil; class HttpMonitor { public static function init() { goto mPJvr; hQCsQ: Event::listen($a_pKA, function ($WZWEZ = null, $xtWCf = null) use($a_pKA) { if (!defined('LARAVEL_START')) { return; } $mHrWb = $WZWEZ; if ($a_pKA == 'kernel.handled') { } else { $mHrWb = $WZWEZ->request; $xtWCf = $WZWEZ->response; } $FU6n6 = round((microtime(true) - LARAVEL_START) * 1000, 2); $ikc2A = $mHrWb->url(); $lrQvV = $mHrWb->method(); if (class_exists('\\ModStart\\Core\\Events\\ModStartRequestHandled')) { goto WUeL_; eaa0t: $l8i0J->response = $xtWCf; goto wAXIR; wzYFh: $l8i0J->time = $FU6n6; goto vxdaR; K0tuM: $l8i0J->url = $mHrWb->path(); goto CDSMH; CDSMH: $l8i0J->method = $lrQvV; goto wzYFh; WUeL_: $l8i0J = new ModStartRequestHandled(); goto K0tuM; RjfG2: EventUtil::fire($l8i0J); goto xpBzL; wAXIR: if (method_exists($xtWCf, 'status')) { $l8i0J->statusCode = $xtWCf->status(); } else { if (method_exists($xtWCf, 'getStatusCode')) { $l8i0J->statusCode = $xtWCf->getStatusCode(); } } goto RjfG2; vxdaR: $l8i0J->statusCode = 0; goto eaa0t; xpBzL: } if (!config('modstart.trackPerformance', false)) { return; } $iAI4f = DatabaseMonitor::getQueryCountPerRequest(); $kKcR8 = '{}'; if ($FU6n6 > 5000 || $iAI4f > 30) { $kKcR8 = ArrayUtil::serializeForLog($mHrWb->input()); } if ($FU6n6 > 5000) { Log::warning("LONG_REQUEST {$lrQvV} [{$ikc2A}] {$FU6n6}ms {$kKcR8}"); } if ($iAI4f > 30) { Log::warning("MASS_REQUEST_SQL {$lrQvV} [{$ikc2A}] {$iAI4f} {$kKcR8} -> " . SerializeUtil::jsonEncode(DatabaseMonitor::getQueryCountPerRequestSqls())); } }); goto stczG; mPJvr: $a_pKA = 'kernel.handled'; goto IOVyk; IOVyk: if (class_exists('Illuminate\\Foundation\\Http\\Events\\RequestHandled')) { $a_pKA = 'Illuminate\\Foundation\\Http\\Events\\RequestHandled'; } goto hQCsQ; stczG: } }