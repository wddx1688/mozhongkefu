<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Core\Exception; use Illuminate\Database\Eloquent\ModelNotFoundException; use Illuminate\Support\Facades\Request; use Illuminate\Support\Facades\Route; use Illuminate\Support\Str; use Illuminate\View\View; use ModStart\Core\Input\Response; use ModStart\Core\Monitor\StatisticMonitor; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\SerializeUtil; use Symfony\Component\HttpKernel\Exception\HttpException; use Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException; use Symfony\Component\HttpKernel\Exception\NotFoundHttpException; trait ExceptionReportHandleTrait { private function errorReportCheck($W0oQK) { try { goto hXKfE; qcVgD: if (!$rEISD) { return; } goto XRaNb; n9V9d: $rEISD = true; goto aYgXz; cyukC: if ($rEISD && $this->isExceptionIgnore($W0oQK)) { $rEISD = false; } goto qcVgD; rRaWn: if ($rEISD && $W0oQK instanceof HttpException) { switch ($W0oQK->getStatusCode()) { case 200: $rEISD = false; break; } } goto cyukC; hXKfE: $hbSCL = config('env.ERROR_REPORT_URL', null); goto KbAM0; XRaNb: $H8Ec_ = array(); goto zaB1y; S5POG: CurlUtil::get($hbSCL, array('data' => SerializeUtil::jsonEncode($H8Ec_))); goto NA30o; zaB1y: $H8Ec_['url'] = Request::url(); goto fTRlf; Fflvg: $H8Ec_['message'] = $W0oQK->getMessage(); goto pa3MV; fTRlf: $H8Ec_['file'] = $W0oQK->getFile() . ':' . $W0oQK->getLine(); goto Fflvg; aYgXz: if ($rEISD && $W0oQK instanceof BizException) { $rEISD = false; } goto jCR4E; KbAM0: if (empty($hbSCL)) { return; } goto n9V9d; Yzu1N: if ($rEISD && $W0oQK instanceof MethodNotAllowedHttpException) { $rEISD = false; } goto rRaWn; pa3MV: foreach ($H8Ec_ as &$yFWLi) { $yFWLi = str_replace(base_path(), '', $yFWLi); } goto S5POG; jCR4E: if ($rEISD && $W0oQK instanceof NotFoundHttpException) { $rEISD = false; } goto Yzu1N; NA30o: } catch (\Exception $l8i0J) { } } private function isExceptionIgnore($W0oQK) { if ($W0oQK instanceof \UnexpectedValueException) { if (Str::contains($W0oQK->getMessage(), 'Invalid method override')) { return true; } } return false; } private function getExceptionResponse($W0oQK) { goto Vm5Ck; Vm5Ck: if ($W0oQK instanceof BizException) { goto JF8rL; JF8rL: $lJDUY = $W0oQK->param; goto pOCvq; Abhvy: if (!\ModStart\Core\Input\Request::isAjax()) { if (empty($lJDUY['view']) && !empty($lJDUY['statusCode']) && in_array($lJDUY['statusCode'], array(403, 404, 500))) { $lJDUY['view'] = 'modstart::core.msg.' . $lJDUY['statusCode']; $O3vHW = $lJDUY['statusCode']; } if (!empty($lJDUY['view'])) { if (!isset($lJDUY['viewData'])) { $lJDUY['viewData'] = array(); } $nMi2c = view($lJDUY['view'], array_merge(array('_viewFrame' => 'theme.default.pc.frame', 'msg' => $W0oQK->getMessage()), $lJDUY['viewData'])); } } goto AKEeK; AKEeK: if ($nMi2c instanceof View) { return response()->make($nMi2c, $O3vHW); } goto Ef_w2; Ef_w2: return $nMi2c; goto d51qO; Z26hI: $O3vHW = 200; goto Abhvy; pOCvq: $nMi2c = Response::sendError($W0oQK->getMessage()); goto Z26hI; d51qO: } else { if ($W0oQK instanceof MethodNotAllowedHttpException) { return Response::page404(); } elseif ($W0oQK instanceof NotFoundHttpException) { if (\ModStart\Core\Input\Request::isAjax()) { return Response::page404(); } return null; } elseif ($W0oQK instanceof ModelNotFoundException) { return null; } else { if ($W0oQK instanceof HttpException) { switch ($W0oQK->getStatusCode()) { case 200: goto xqRG0; Y3ip3: return $nMi2c; goto FGjaz; hPTrz: if ($nMi2c instanceof View) { return response()->make($nMi2c); } goto Y3ip3; V5Tu5: $nMi2c = Response::sendError($W0oQK->getMessage()); goto hPTrz; xqRG0: if (\ModStart\Core\Input\Request::isJsonp()) { $nMi2c = Response::generateError($W0oQK->getMessage()); return Response::jsonp($nMi2c); } goto V5Tu5; FGjaz: } } else { if ($W0oQK instanceof \UnexpectedValueException) { if (Str::contains($W0oQK->getMessage(), 'Invalid method override')) { return Response::page404(); } } } } } goto uci0l; iYh7B: return null; goto CvMPX; uci0l: try { if (StatisticMonitor::isEnable()) { goto aedxr; gHoAh: $lrQvV = $mHrWb->method(); goto G8jV3; G8jV3: $bpf5d = Route::currentRouteAction(); goto pOxme; dSxBY: StatisticMonitor::tick($diycn, "{$lrQvV}." . $bpf5d, $FU6n6, false, 500); goto zkMjv; mNaDq: $FU6n6 = round((microtime(true) - LARAVEL_START) * 1000, 2); goto Yt44M; Yt44M: $ikc2A = $mHrWb->url(); goto gHoAh; pOxme: $diycn = \ModStart\Core\Input\Request::domain(); goto dSxBY; aedxr: $mHrWb = \ModStart\Core\Input\Request::instance(); goto mNaDq; zkMjv: } } catch (\Exception $l8i0J) { } goto iYh7B; CvMPX: } }