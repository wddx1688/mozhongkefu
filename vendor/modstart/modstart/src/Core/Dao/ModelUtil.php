<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Core\Dao; use Illuminate\Database\Eloquent\Model; use Illuminate\Database\Query\Builder; use Illuminate\Support\Facades\DB; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Util\PageHtmlUtil; use ModStart\Core\Util\SerializeUtil; class ModelUtil { public static function isModel($Ee3WF) { if (!is_string($Ee3WF)) { return true; } return strtolower($Ee3WF) != $Ee3WF; } public static function autoModel($Ee3WF) { if (self::isModel($Ee3WF)) { if (is_string($Ee3WF)) { return new $Ee3WF(); } return $Ee3WF; } return self::model($Ee3WF); } public static function model($Wa8N4) { goto sdQ29; IvKOZ: $AkyhD->setTable($Wa8N4); goto a29wz; a29wz: return $AkyhD; goto oo8d4; yOjMG: $AkyhD = new DynamicModel(); goto IvKOZ; Hk9Sn: if (preg_match('/\\\\Model\\\\(.*)$/', $Wa8N4)) { if (class_exists($Wa8N4)) { return new $Wa8N4(); } } goto yOjMG; sdQ29: if (is_object($Wa8N4)) { return $Wa8N4; } goto Hk9Sn; oo8d4: } public static function insert($Wa8N4, $nx179) { goto zGVk1; UrM7f: return $AkyhD->toArray(); goto Viv4q; zGVk1: $AkyhD = self::model($Wa8N4); goto fPoy3; eie3T: $AkyhD->save(); goto UrM7f; fPoy3: foreach ($nx179 as $dKmL2 => $yFWLi) { $AkyhD->{$dKmL2} = $yFWLi; } goto eie3T; Viv4q: } public static function insertAll($Wa8N4, $nQYo_, $lrbMf = true) { goto Ff_Kv; K72Bg: DB::table($Wa8N4)->insert($nQYo_); goto EzkND; Ff_Kv: if (empty($nQYo_)) { return; } goto rlqbm; rlqbm: if ($lrbMf) { foreach ($nQYo_ as $qsK6T => $nx179) { if (!isset($nQYo_[$qsK6T]['created_at'])) { $nQYo_[$qsK6T]['created_at'] = date('Y-m-d H:i:s'); } if (!isset($nQYo_[$qsK6T]['updated_at'])) { $nQYo_[$qsK6T]['updated_at'] = date('Y-m-d H:i:s'); } } } goto K72Bg; EzkND: } public static function delete($Wa8N4, $kNTjB) { if (is_string($kNTjB) || is_numeric($kNTjB)) { $kNTjB = array('id' => $kNTjB); } return self::model($Wa8N4)->where($kNTjB)->delete(); } public static function deleteOperator($Wa8N4, $dBa7F, $xfg26, $VuXfH) { return self::model($Wa8N4)->where($dBa7F, $xfg26, $VuXfH)->delete(); } public static function deleteIn($Wa8N4, $tcwC2, $dBa7F = 'id') { if (empty($tcwC2)) { return 0; } return self::model($Wa8N4)->whereIn($dBa7F, $tcwC2)->delete(); } public static function updateAll($Wa8N4, $nx179, $kNTjB = array('id', '>', '0')) { self::model($Wa8N4)->where($kNTjB[0], $kNTjB[1], $kNTjB[2])->update($nx179); } public static function update($Wa8N4, $kNTjB, $nx179) { goto jwZn6; YSLnX: if (is_string($kNTjB) || is_numeric($kNTjB)) { $kNTjB = array('id' => $kNTjB); } goto Ccl6O; jwZn6: if (empty($kNTjB) || empty($nx179)) { return 0; } goto YSLnX; Ccl6O: return self::model($Wa8N4)->where($kNTjB)->update($nx179); goto R7q05; R7q05: } public static function first($Wa8N4, $kNTjB, $Px5Cq = array('*'), $Ln38v = null) { goto LJH5d; NR06Q: return $AkyhD->toArray(); goto sqyX7; lY_Ck: if ($Ln38v) { $AkyhD = self::model($Wa8N4)->where($kNTjB)->orderBy($Ln38v[0], $Ln38v[1])->first($Px5Cq); } else { $AkyhD = self::model($Wa8N4)->where($kNTjB)->first($Px5Cq); } goto UfvW0; UfvW0: if (empty($AkyhD)) { return null; } goto NR06Q; LJH5d: if (is_string($kNTjB) || is_numeric($kNTjB)) { $kNTjB = array('id' => $kNTjB); } goto lY_Ck; sqyX7: } public static function get($Wa8N4, $kNTjB, $Px5Cq = array('*'), $Ln38v = null) { goto FuRQg; yb4AP: if (is_string($kNTjB) || is_numeric($kNTjB)) { $kNTjB = array('id' => $kNTjB); } goto b3UJe; FuRQg: if (null === $kNTjB) { return null; } goto yb4AP; YDk_C: if (!empty($Ln38v)) { $Wa8N4 = $Wa8N4->orderBy($Ln38v[0], $Ln38v[1]); } goto vIuHl; vIuHl: $AkyhD = $Wa8N4->first($Px5Cq); goto pwtoR; m3UPQ: return $AkyhD->toArray(); goto rwZgB; b3UJe: $Wa8N4 = self::model($Wa8N4)->where($kNTjB); goto YDk_C; pwtoR: if (empty($AkyhD)) { return null; } goto m3UPQ; rwZgB: } public static function getOr404($Wa8N4, $kNTjB, $Px5Cq = array('*'), $Ln38v = null) { goto LMErO; LMErO: $oyMBi = self::get($Wa8N4, $kNTjB, $Px5Cq, $Ln38v); goto ajxeE; ajxeE: if (empty($oyMBi)) { abort(404, L('Page Not Found')); } goto UcWlD; UcWlD: return $oyMBi; goto Pq9Ue; Pq9Ue: } public static function getOrCreate($Wa8N4, $kNTjB) { goto pUf8k; NHYAd: return $AkyhD->toArray(); goto yJBYW; qRhnj: if (empty($AkyhD)) { self::insert($Wa8N4, $kNTjB); $AkyhD = self::model($Wa8N4)->where($kNTjB)->first(); } goto NHYAd; MrBrJ: $AkyhD = self::model($Wa8N4)->where($kNTjB)->first(); goto qRhnj; pUf8k: if (is_string($kNTjB) || is_numeric($kNTjB)) { $kNTjB = array('id' => $kNTjB); } goto MrBrJ; yJBYW: } public static function getWithCache($Wa8N4, $kNTjB) { goto qaZHT; BNFHM: $HE8Kt = serialize(array('model' => $Wa8N4, 'where' => $kNTjB)); goto dxFyj; qaZHT: static $bx4aO = array(); goto BNFHM; dxFyj: if (!array_key_exists($HE8Kt, $bx4aO)) { $bx4aO[$HE8Kt] = self::get($Wa8N4, $kNTjB); } goto NINyL; NINyL: return $bx4aO[$HE8Kt]; goto ggSFE; ggSFE: } public static function getWithLock($Wa8N4, $kNTjB, $Px5Cq = array('*')) { goto klcIC; Gg1KU: $AkyhD = self::model($Wa8N4)->where($kNTjB)->lockForUpdate()->first($Px5Cq); goto nURmo; nURmo: if (empty($AkyhD)) { return null; } goto uC0hT; uC0hT: return $AkyhD->toArray(); goto Nx7vq; klcIC: if (is_string($kNTjB) || is_numeric($kNTjB)) { $kNTjB = array('id' => $kNTjB); } goto Gg1KU; Nx7vq: } public static function count($Wa8N4, $kNTjB = array()) { goto P91Ye; godzI: return self::model($Wa8N4)->where($kNTjB)->count(); goto Fqwc2; P91Ye: if (is_string($kNTjB) || is_numeric($kNTjB)) { $kNTjB = array('id' => $kNTjB); } goto lgjc3; lgjc3: if (empty($kNTjB)) { return self::model($Wa8N4)->count(); } goto godzI; Fqwc2: } public static function exists($Wa8N4, $kNTjB) { return !!self::get($Wa8N4, $kNTjB); } public static function batch($Wa8N4, $RPl_0, $RbFi7 = 1000, $kNTjB = array(), $Px5Cq = array('*'), $GYMeL = 'id', $Je5AK = 'asc') { goto fSfPy; IFHOa: return array('records' => $nQYo_, 'nextId' => $RPl_0); goto SlLH_; dpz_U: foreach ($nQYo_ as $DUr2V) { switch ($Je5AK) { case 'asc': $RPl_0 = max($RPl_0, $DUr2V[$GYMeL]); break; default: $RPl_0 = min($RPl_0, $DUr2V[$GYMeL]); break; } } goto IFHOa; fSfPy: $nQYo_ = self::model($Wa8N4)->where($kNTjB)->where($GYMeL, $Je5AK == 'asc' ? '>' : '<', $RPl_0)->limit($RbFi7)->orderBy($GYMeL, $Je5AK)->get($Px5Cq)->toArray(); goto dpz_U; SlLH_: } public static function allFirstGroupOrder($R3agm, $m1Qr9, $oecTy, $BbUZ0) { $R3agm = ModelManageUtil::table($R3agm); return ModelManageUtil::query("SELECT * FROM (SELECT * FROM {$R3agm} WHERE {$m1Qr9} ORDER BY {$BbUZ0} DESC) AS t GROUP BY {$oecTy}"); } public static function all($Wa8N4, $kNTjB = array(), $Px5Cq = array('*'), $Ln38v = null) { if ($Ln38v) { return self::model($Wa8N4)->where($kNTjB)->orderBy($Ln38v[0], $Ln38v[1])->get($Px5Cq)->toArray(); } return self::model($Wa8N4)->where($kNTjB)->get($Px5Cq)->toArray(); } public static function allMap($Wa8N4, $kNTjB = array(), $Px5Cq = array('*'), $Ln38v = null, $dP2lx = 'id') { return array_build(self::all($Wa8N4, $kNTjB, $Px5Cq, $Ln38v), function ($dKmL2, $yFWLi) use($dP2lx) { return array($yFWLi[$dP2lx], $yFWLi); }); } public static function allIn($Wa8N4, $dBa7F, $TjpEr, $Px5Cq = array('*')) { if (empty($TjpEr)) { return array(); } return self::model($Wa8N4)->whereIn($dBa7F, $TjpEr)->get($Px5Cq)->toArray(); } public static function allInWithOrder($Wa8N4, $dBa7F, $TjpEr, $Px5Cq = array('*')) { goto STJdF; VFobr: foreach ($TjpEr as $DUr2V) { if (isset($bx4aO[$DUr2V])) { $nQYo_[] = $bx4aO[$DUr2V]; } } goto I0t0C; I0t0C: return $nQYo_; goto iPsml; vDzbp: $nQYo_ = array(); goto VFobr; STJdF: if (empty($TjpEr)) { return array(); } goto hHUsL; hHUsL: $bx4aO = array_build(self::allIn($Wa8N4, $dBa7F, $TjpEr, $Px5Cq), function ($dKmL2, $yFWLi) use($dBa7F) { return array($yFWLi[$dBa7F], $yFWLi); }); goto vDzbp; iPsml: } public static function allInMap($Wa8N4, $dBa7F, $TjpEr, $Px5Cq = array('*'), $dP2lx = 'id') { return array_build(self::allIn($Wa8N4, $dBa7F, $TjpEr, $Px5Cq), function ($dKmL2, $yFWLi) use($dP2lx) { return array($yFWLi[$dP2lx], $yFWLi); }); } public static function allIds($R3agm, $kNTjB, $Ssd58, $kpkZ6 = 'id') { $nQYo_ = self::model($R3agm)->where($kNTjB)->limit($Ssd58)->get(array($kpkZ6)); return ArrayUtil::fetchSpecifiedKeyToArray($nQYo_, $kpkZ6); } public static function values($Wa8N4, $dBa7F, $kNTjB = array(), $Ln38v = null) { goto PURAV; Xy3cz: $s3Gqv = $s3Gqv->get($Px5Cq)->toArray(); goto hAuHE; eRUx9: if (!empty($Ln38v)) { $s3Gqv = $s3Gqv->orderBy($Ln38v[0], $Ln38v[1]); } goto Xy3cz; b5cG8: $s3Gqv = self::model($Wa8N4)->where($kNTjB); goto eRUx9; hAuHE: if ($L_OSi) { return array_map(function ($DUr2V) use($dBa7F) { return $DUr2V[$dBa7F]; }, $s3Gqv); } goto Mhj0T; PURAV: $L_OSi = false; goto om5V3; Mhj0T: return $s3Gqv; goto RIPhm; om5V3: if (!is_array($dBa7F)) { $Px5Cq = array($dBa7F); $L_OSi = true; } else { $Px5Cq = $dBa7F; } goto b5cG8; RIPhm: } public static function valueMap($Wa8N4, $efCC3, $G6R7g, $kNTjB = array()) { $s3Gqv = self::model($Wa8N4)->where($kNTjB)->get(array($efCC3, $G6R7g))->toArray(); return array_build($s3Gqv, function ($dKmL2, $yFWLi) use($efCC3, $G6R7g) { return array($yFWLi[$efCC3], $yFWLi[$G6R7g]); }); } public static function relationList($Wa8N4, $tx0TC, $Agc1s, $AKg7l = array(), $jTpM2 = array(), $iuVL2 = 'id') { return self::all($Wa8N4, array_merge(array($tx0TC => $Agc1s), $AKg7l), array_merge(array($iuVL2, $tx0TC), $jTpM2)); } public static function relationClean($Wa8N4, $dBa7F, $VuXfH) { return self::model($Wa8N4)->where($dBa7F, $dBa7F)->delete(); } public static function relationAssign($Wa8N4, $tx0TC, $Agc1s, $pOz1o, $f91mU, $AKg7l = array(), $iuVL2 = 'id') { goto yCpW3; LPfAK: return $K5EtC; goto xEYd2; uo6Kk: $fE8zi = array(); goto aiJ0P; r5r0G: if (!empty($pxMM_)) { self::insertAll($Wa8N4, $pxMM_); $K5EtC = true; } goto LPfAK; i9FID: $K5EtC = false; goto fKlmo; jsjga: $De765 = array(); goto dcGLy; dcGLy: $pxMM_ = array(); goto uo6Kk; yCpW3: if (empty($f91mU)) { $f91mU = array(); } goto QQVgj; QQVgj: $Gv5gR = self::all($Wa8N4, array_merge(array($tx0TC => $Agc1s), $AKg7l), array($iuVL2, $pOz1o)); goto jsjga; aiJ0P: foreach ($Gv5gR as $HN67o) { $fE8zi[$HN67o[$pOz1o]] = true; if (!in_array($HN67o[$pOz1o], $f91mU)) { $De765[] = $HN67o[$iuVL2]; continue; } } goto oLKCi; fKlmo: if (!empty($De765)) { self::deleteIn($Wa8N4, $De765, $iuVL2); $K5EtC = true; } goto r5r0G; oLKCi: foreach ($f91mU as $v2vKp) { if (!isset($fE8zi[$v2vKp])) { $pxMM_[] = array_merge(array($tx0TC => $Agc1s, $pOz1o => $v2vKp), $AKg7l); } } goto i9FID; xEYd2: } public static function next($Wa8N4, $S0wnp, $kNTjB = array(), $Ecy08 = 'id', $Px5Cq = array('*')) { $jdXuk = self::model($Wa8N4)->where($kNTjB)->where($Ecy08, '>', $S0wnp)->orderBy($Ecy08, 'asc')->first($Px5Cq); return $jdXuk ? $jdXuk->toArray() : null; } public static function prev($Wa8N4, $S0wnp, $kNTjB = array(), $Ecy08 = 'id', $Px5Cq = array('*')) { $jdXuk = self::model($Wa8N4)->where($kNTjB)->where($Ecy08, '<', $S0wnp)->orderBy($Ecy08, 'desc')->first($Px5Cq); return $jdXuk ? $jdXuk->toArray() : null; } public static function sortNext($Wa8N4, $kNTjB = array(), $Ecy08 = 'sort') { return intval(self::model($Wa8N4)->where($kNTjB)->max($Ecy08)) + 1; } public static function sortMove($Wa8N4, $CeOJi, $Vg301 = 'up|down|top|bottom', $AKg7l = array(), $iuVL2 = 'id', $Ecy08 = 'sort') { goto Uj87I; hw74Q: if ($n3_jf < 0) { return false; } goto o_6z1; tpjaq: foreach ($pVCto as $kOFY1 => $hsl_x) { if ($hsl_x[$iuVL2] == $CeOJi) { $n3_jf = $kOFY1; break; } } goto hw74Q; GutK6: $n3_jf = -1; goto tpjaq; o_6z1: switch ($Vg301) { case 'up': if ($n3_jf > 0) { goto MOMJ9; QCWOs: return true; goto dK2vO; y4LRL: self::update($Wa8N4, $pVCto[$n3_jf - 1][$iuVL2], array($Ecy08 => $pVCto[$n3_jf][$Ecy08])); goto QCWOs; MOMJ9: self::update($Wa8N4, $pVCto[$n3_jf][$iuVL2], array($Ecy08 => $pVCto[$n3_jf - 1][$Ecy08])); goto y4LRL; dK2vO: } break; case 'down': if ($n3_jf < count($pVCto) - 1) { goto ZR8sE; ugDNl: return true; goto NZ3ky; ZR8sE: self::update($Wa8N4, $pVCto[$n3_jf][$iuVL2], array($Ecy08 => $pVCto[$n3_jf + 1][$Ecy08])); goto hkm8M; hkm8M: self::update($Wa8N4, $pVCto[$n3_jf + 1][$iuVL2], array($Ecy08 => $pVCto[$n3_jf][$Ecy08])); goto ugDNl; NZ3ky: } break; case 'top': if ($n3_jf > 0) { goto L_r4c; r1kFm: foreach ($pVCto as $kOFY1 => $hsl_x) { if ($kOFY1 == $n3_jf) { self::update($Wa8N4, $hsl_x[$iuVL2], array($Ecy08 => 1)); } else { self::update($Wa8N4, $hsl_x[$iuVL2], array($Ecy08 => $eI1Ye)); $eI1Ye++; } } goto gl1ZR; L_r4c: $eI1Ye = 2; goto r1kFm; gl1ZR: return true; goto A3hvr; A3hvr: } break; case 'bottom': if ($n3_jf < count($pVCto) - 1) { goto vPEWP; QNTm_: return true; goto Kkzgt; oCutD: foreach ($pVCto as $kOFY1 => $hsl_x) { goto znExu; znExu: if ($kOFY1 == $n3_jf) { continue; } goto wehbL; iJHop: $eI1Ye++; goto EXlNJ; wehbL: self::update($Wa8N4, $hsl_x[$iuVL2], array($Ecy08 => $eI1Ye)); goto iJHop; EXlNJ: } goto zr0l1; vPEWP: $eI1Ye = 1; goto oCutD; zr0l1: self::update($Wa8N4, $pVCto[$n3_jf][$iuVL2], array($Ecy08 => $eI1Ye)); goto QNTm_; Kkzgt: } break; } goto cOsEh; cOsEh: return false; goto qIpA0; Uj87I: if (!in_array($Vg301, array('up', 'down', 'top', 'bottom'))) { return false; } goto wI3Lo; wI3Lo: $pVCto = self::all($Wa8N4, $AKg7l, array($iuVL2, $Ecy08), array($Ecy08, 'asc')); goto GutK6; qIpA0: } public static function join(&$nQYo_, $zvb11 = 'userId', $iCuCK = '_user', $Wa8N4 = 'join_model', $cZbgx = 'id') { goto HjSjW; FCAda: $S_pUg = array_build($A2S3q, function ($dKmL2, $yFWLi) use($cZbgx) { return array($yFWLi[$cZbgx], $yFWLi); }); goto wbZLX; ly0bz: $iUHLt = array_map(function ($DUr2V) use($zvb11) { return $DUr2V[$zvb11]; }, $nQYo_); goto R3eKk; R3eKk: $A2S3q = self::model($Wa8N4)->whereIn($cZbgx, $iUHLt)->get()->toArray(); goto FCAda; HjSjW: if (empty($nQYo_)) { return; } goto ly0bz; wbZLX: foreach ($nQYo_ as &$DUr2V) { $cANPj = $DUr2V[$zvb11]; if (isset($S_pUg[$cANPj])) { $DUr2V[$iCuCK] = $S_pUg[$cANPj]; } else { $DUr2V[$iCuCK] = null; } } goto RCTXl; RCTXl: } public static function joinItems(&$c0PBf, $zvb11 = 'userId', $iCuCK = '_user', $Wa8N4 = 'join_model', $cZbgx = 'id') { goto hCVek; hCVek: if (empty($c0PBf)) { return; } goto woBEC; igUKr: $iUHLt = array_unique($iUHLt); goto BdMD3; BdMD3: $A2S3q = self::model($Wa8N4)->whereIn($cZbgx, $iUHLt)->get()->toArray(); goto nvBEI; woBEC: $iUHLt = array(); goto Vhtas; nvBEI: $S_pUg = array_build($A2S3q, function ($dKmL2, $yFWLi) use($cZbgx) { return array($yFWLi[$cZbgx], $yFWLi); }); goto Y8dpj; Y8dpj: foreach ($c0PBf as &$DUr2V) { $cANPj = $DUr2V->{$zvb11}; if (isset($S_pUg[$cANPj])) { $DUr2V->{$iCuCK} = $S_pUg[$cANPj]; } else { $DUr2V->{$iCuCK} = null; } } goto Vsww0; Vhtas: foreach ($c0PBf as $DUr2V) { $iUHLt[] = $DUr2V->{$zvb11}; } goto igUKr; Vsww0: } public static function joinAll(&$nx179, $zvb11 = 'userId', $iCuCK = '_user', $Wa8N4 = 'join_model', $cZbgx = 'id') { goto dZrGU; dZrGU: if (empty($nx179)) { return; } goto qaB71; HS0ah: $A2S3q = self::model($Wa8N4)->whereIn($cZbgx, $iUHLt)->get()->toArray(); goto Z9X9h; w5q1b: foreach ($A2S3q as $DUr2V) { if (array_key_exists($DUr2V[$cZbgx], $S_pUg)) { $S_pUg[$DUr2V[$cZbgx]][] = $DUr2V; } else { $S_pUg[$DUr2V[$cZbgx]] = array($DUr2V); } } goto oUG06; Z9X9h: $S_pUg = array(); goto w5q1b; qaB71: $iUHLt = array_map(function ($DUr2V) use($zvb11) { return $DUr2V[$zvb11]; }, $nx179); goto HS0ah; oUG06: foreach ($nx179 as &$DUr2V) { $cANPj = $DUr2V[$zvb11]; if (isset($S_pUg[$cANPj])) { $DUr2V[$iCuCK] = $S_pUg[$cANPj]; } else { $DUr2V[$iCuCK] = array(); } } goto r2l5D; r2l5D: } public static function paginateMergeConditionParam(&$VL0g3, $mH3Yd) { goto sJd8E; AxPUi: if (!empty($mH3Yd['whereRaw'])) { if (is_array($mH3Yd['whereRaw'])) { $VL0g3 = $VL0g3->whereRaw($mH3Yd['whereRaw'][0], $mH3Yd['whereRaw'][1]); } else { $VL0g3 = $VL0g3->whereRaw($mH3Yd['whereRaw']); } } goto yxHgj; sJd8E: if (!empty($mH3Yd['whereIn'])) { if (is_array($mH3Yd['whereIn'][0])) { foreach ($mH3Yd['whereIn'] as &$L_gXc) { $VL0g3 = $VL0g3->whereIn($L_gXc[0], $L_gXc[1]); } } else { $VL0g3 = $VL0g3->whereIn($mH3Yd['whereIn'][0], $mH3Yd['whereIn'][1]); } } goto lzSH5; grqGB: if (!empty($mH3Yd['filter']) && is_array($mH3Yd['filter'])) { self::queryFilterExecute($VL0g3, $mH3Yd['filter']); } goto tjIWD; KbKAE: if (!empty($mH3Yd['where'])) { if (is_array($mH3Yd['where'])) { $VL0g3 = $VL0g3->where($mH3Yd['where']); } else { $VL0g3 = $VL0g3->whereRaw($mH3Yd['where']); } } goto AxPUi; lzSH5: if (!empty($mH3Yd['whereOperate'])) { if (is_array($mH3Yd['whereOperate'][0])) { foreach ($mH3Yd['whereOperate'] as &$Rp0jm) { $VL0g3 = $VL0g3->where($Rp0jm[0], $Rp0jm[1], $Rp0jm[2]); } } else { $VL0g3 = $VL0g3->where($mH3Yd['whereOperate'][0], $mH3Yd['whereOperate'][1], $mH3Yd['whereOperate'][2]); } } goto KbKAE; yxHgj: if (!empty($mH3Yd['search']) && is_array($mH3Yd['search'])) { self::querySearchExecute($VL0g3, $mH3Yd['search']); } goto grqGB; tjIWD: } public static function querySearchExecute(&$IpOIw, $fOTZy) { foreach ($fOTZy as $TixC1) { goto drnSL; uc2Dd: $zAjtK = true; goto d2mG8; tMFxP: $IpOIw = $IpOIw->where(function ($uUJzo) use(&$TixC1, $zAjtK, $YmWVw) { foreach ($TixC1 as $dBa7F => $SPnSA) { goto kxDGM; QLyfF: $SPnSA['exp'] = strtolower($SPnSA['exp']); goto BtKMa; WDm0X: if (!isset($SPnSA['exp'])) { $SPnSA['exp'] = 'and'; } goto QLyfF; mI2zG: $uUJzo = $uUJzo->{$kNTjB}(function ($IpOIw) use(&$dBa7F, &$SPnSA) { $zPRvu = true; foreach ($SPnSA as $dKmL2 => $yFWLi) { switch ($dKmL2) { case 'likes': $IpOIw->where(function ($Ts9td) use($yFWLi, $dBa7F) { foreach ($yFWLi as $G3PnY) { $Ts9td->where($dBa7F, 'like', '%' . $G3PnY . '%'); } }); break; case 'like': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->where($dBa7F, 'like', '%' . $yFWLi . '%'); } else { $IpOIw->orWhere($dBa7F, 'like', '%' . $yFWLi . '%'); } break; case 'leftLike': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->where($dBa7F, 'like', $yFWLi . '%'); } else { $IpOIw->orWhere($dBa7F, 'like', $yFWLi . '%'); } break; case 'rightLike': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->where($dBa7F, 'like', '%' . $yFWLi); } else { $IpOIw->orWhere($dBa7F, 'like', '%' . $yFWLi); } break; case 'equal': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->where($dBa7F, '=', $yFWLi); } else { $IpOIw->orWhere($dBa7F, '=', $yFWLi); } break; case 'eq': case 'min': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->where($dBa7F, '>=', $yFWLi); } else { $IpOIw->orWhere($dBa7F, '>=', $yFWLi); } break; case 'max': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->where($dBa7F, '<=', $yFWLi); } else { $IpOIw->orWhere($dBa7F, '<=', $yFWLi); } break; case 'in': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->whereIn($dBa7F, $yFWLi); } else { $IpOIw->whereIn($dBa7F, $yFWLi, 'or'); } break; case 'is': if (null === $yFWLi) { if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->whereNull($dBa7F); } else { $IpOIw->orWhereNull($dBa7F); } } else { die('TODO'); } break; case 'raw': if ($zPRvu || $SPnSA['exp'] == 'and') { $zPRvu = false; $IpOIw->whereRaw($yFWLi); } else { $IpOIw->orWhereRaw($yFWLi); } break; case 'exp': break; default: BizException::throws('unknown search exp : ' . $dKmL2); } } }); goto W0CGl; BtKMa: if ($zAjtK) { $kNTjB = 'where'; $zAjtK = false; } else { $kNTjB = $YmWVw; } goto mI2zG; kxDGM: if (in_array($dBa7F, array('__exp'))) { continue; } goto WDm0X; W0CGl: } }); goto XowlS; drnSL: if (!isset($TixC1['__exp'])) { $TixC1['__exp'] = 'and'; } else { $TixC1['__exp'] = strtolower($TixC1['__exp']); } goto uc2Dd; d2mG8: $YmWVw = 'where'; goto WEI7p; WEI7p: if ($TixC1['__exp'] == 'or') { $YmWVw = 'orWhere'; } goto tMFxP; XowlS: } } public static function queryFilterExecute(&$IpOIw, $P8qbI) { $IpOIw = $IpOIw->where(function ($Ts9td) use(&$P8qbI) { foreach ($P8qbI as $AKg7l) { switch ($AKg7l['condition']) { case 'is': $Ts9td = $Ts9td->where(array($AKg7l['field'] => $AKg7l['value'])); break; case 'is_not': $Ts9td = $Ts9td->where($AKg7l['field'], '<>', $AKg7l['value']); break; case 'contains': $Ts9td = $Ts9td->where($AKg7l['field'], 'like', '%' . $AKg7l['value'] . '%'); break; case 'not_contains': $Ts9td = $Ts9td->where($AKg7l['field'], 'not like', '%' . $AKg7l['value'] . '%'); break; case 'range': goto t7ZSK; FRJvb: break; goto nK0tg; Z49O5: if (!empty($AKg7l['value'][1])) { $Ts9td = $Ts9td->where($AKg7l['field'], '<=', $AKg7l['value'][1]); } goto FRJvb; t7ZSK: if (!empty($AKg7l['value'][0])) { $Ts9td = $Ts9td->where($AKg7l['field'], '>=', $AKg7l['value'][0]); } goto Z49O5; nK0tg: case 'is_empty': $Ts9td = $Ts9td->where($AKg7l['field'], '=', ''); break; case 'is_not_empty': $Ts9td = $Ts9td->where($AKg7l['field'], '<>', ''); break; case 'gt': $Ts9td = $Ts9td->where($AKg7l['field'], '>', $AKg7l['value']); break; case 'egt': $Ts9td = $Ts9td->where($AKg7l['field'], '>=', $AKg7l['value']); break; case 'lt': $Ts9td = $Ts9td->where($AKg7l['field'], '<', $AKg7l['value']); break; case 'elt': $Ts9td = $Ts9td->where($AKg7l['field'], '<=', $AKg7l['value']); break; } } }); } public static function paginateQuick($Wa8N4, $mZ5xK = null, $qp8x7 = null, $mH3Yd = array(), $P4Rw1 = '?page={page}') { goto CYCd1; VnZpG: $LHFyR = self::paginate($Wa8N4, $mZ5xK, $qp8x7, $mH3Yd); goto KDejw; CYCd1: if (null === $mZ5xK) { $mZ5xK = InputPackage::buildFromInput()->getPage(); } goto WmQX7; WmQX7: if (null === $qp8x7) { $qp8x7 = InputPackage::buildFromInput()->getPageSize(); } goto VnZpG; KDejw: return array('records' => $LHFyR['records'], 'total' => $LHFyR['total'], 'page' => $mZ5xK, 'pageSize' => $qp8x7, 'pageHtml' => PageHtmlUtil::render($LHFyR['total'], $qp8x7, $mZ5xK, $P4Rw1)); goto i9fzC; i9fzC: } public static function paginate($Wa8N4, $mZ5xK, $qp8x7, $mH3Yd = array()) { goto CKDoz; nD5w8: self::paginateMergeConditionParam($AkyhD, $mH3Yd); goto K7q_Q; K7q_Q: if (!empty($mH3Yd['order'])) { if (is_array($mH3Yd['order'][0])) { foreach ($mH3Yd['order'] as &$Ln38v) { $AkyhD = $AkyhD->orderBy($Ln38v[0], $Ln38v[1]); } } else { $AkyhD = $AkyhD->orderBy($mH3Yd['order'][0], $mH3Yd['order'][1]); } } goto igz68; igz68: if (!empty($mH3Yd['fields'])) { $AkyhD = $AkyhD->select($mH3Yd['fields']); } goto pzLch; R2vT7: if (!empty($mH3Yd['joins'])) { goto E3cAl; E3cAl: $Nqp7v = array(); goto NDz0U; OH4mH: $AkyhD = call_user_func_array(array($AkyhD, 'select'), $Nqp7v); goto T0eoY; NtOtl: foreach ($mH3Yd['joins'] as $SdLqb) { if (!empty($SdLqb['table'])) { $AkyhD = $AkyhD->leftJoin($SdLqb['table'][0], $SdLqb['table'][1], $SdLqb['table'][2], $SdLqb['table'][3]); } if (!empty($SdLqb['fields'])) { foreach ($SdLqb['fields'] as $QGmtb => $n_Dgi) { array_push($Nqp7v, "{$n_Dgi} as {$QGmtb}"); } } } goto OH4mH; NDz0U: $Nqp7v[] = $Wa8N4 . '.*'; goto NtOtl; T0eoY: } goto nD5w8; CKDoz: $AkyhD = self::model($Wa8N4); goto R2vT7; raHZv: return array('total' => $AkyhD['total'], 'records' => $AkyhD['data']); goto DLH39; pzLch: $AkyhD = $AkyhD->paginate($qp8x7, array('*'), 'page', $mZ5xK)->toArray(); goto raHZv; DLH39: } public static function transactionBegin() { DB::beginTransaction(); } public static function transactionRollback() { DB::rollback(); } public static function transactionCommit() { DB::commit(); } public static function isFieldUniqueForInsertOrUpdate($Wa8N4, $CeOJi, $dBa7F, $VuXfH, $kNTjB = array()) { goto rOMjN; rOMjN: $pVCto = self::all($Wa8N4, array_merge(array($dBa7F => $VuXfH), $kNTjB)); goto LsTGm; Ci8x8: return false; goto BooLU; nrHMM: if (count($pVCto) == 1 && $CeOJi > 0 && $CeOJi == $pVCto[0]['id']) { return true; } goto Ci8x8; LsTGm: if (empty($pVCto)) { return true; } goto nrHMM; BooLU: } public static function replaceConditionParamField(&$mH3Yd, $jYQWv = array()) { goto zxH0w; AbieC: if (!empty($mH3Yd['where'])) { foreach ($mH3Yd['where'] as $dKmL2 => $DUr2V) { if (array_key_exists($dKmL2, $jYQWv)) { unset($mH3Yd['where'][$dKmL2]); $mH3Yd['where'][$jYQWv[$dKmL2]] = $DUr2V; } } } goto PUf34; zxH0w: if (empty($jYQWv)) { return; } goto EgW1w; xiync: if (!empty($mH3Yd['whereIn'])) { if (is_array($mH3Yd['whereIn'][0])) { foreach ($mH3Yd['whereIn'] as &$L_gXc) { if (array_key_exists($L_gXc[0], $jYQWv)) { $L_gXc[0] = $jYQWv[$L_gXc[0]]; } } } else { if (array_key_exists($mH3Yd['whereIn'][0], $jYQWv)) { $mH3Yd['whereIn'][0] = $jYQWv[$mH3Yd['whereIn'][0]]; } } } goto BUBj2; EgW1w: if (!empty($mH3Yd['search']) && is_array($mH3Yd['search'])) { foreach ($mH3Yd['search'] as &$TixC1) { foreach ($TixC1 as $dBa7F => $SPnSA) { if (array_key_exists($dBa7F, $jYQWv)) { unset($TixC1[$dBa7F]); $TixC1[$jYQWv[$dBa7F]] = $SPnSA; } } } } goto xiync; BUBj2: if (!empty($mH3Yd['whereOperate'])) { if (is_array($mH3Yd['whereOperate'][0])) { foreach ($mH3Yd['whereOperate'] as &$Rp0jm) { if (array_key_exists($Rp0jm[0], $jYQWv)) { $Rp0jm[0] = $jYQWv[$Rp0jm[0]]; } } } else { if (array_key_exists($mH3Yd['whereOperate'][0], $jYQWv)) { $mH3Yd['whereOperate'][0] = $jYQWv[$mH3Yd['whereOperate'][0]]; } } } goto AbieC; PUf34: } public static function decodeRecordBoolean(&$jdXuk, $sGhlV) { goto hr4dd; FtLcL: foreach ($sGhlV as $cANPj) { $jdXuk[$cANPj] = $jdXuk[$cANPj] ? true : false; } goto UDWoU; iZvrS: if (is_string($sGhlV)) { $sGhlV = array($sGhlV); } goto FtLcL; hr4dd: if (empty($jdXuk)) { return; } goto iZvrS; UDWoU: } public static function decodeRecordsBoolean(&$nQYo_, $sGhlV) { goto pZ0BA; Bwi2z: if (is_string($sGhlV)) { $sGhlV = array($sGhlV); } goto PTTZE; pZ0BA: if (empty($nQYo_)) { return; } goto Bwi2z; PTTZE: foreach ($nQYo_ as &$jdXuk) { foreach ($sGhlV as $cANPj) { $jdXuk[$cANPj] = $jdXuk[$cANPj] ? true : false; } } goto o35kS; o35kS: } public static function decodeRecordsNumberArray(&$nQYo_, $sGhlV) { goto iDVJ1; Q1Z47: foreach ($nQYo_ as &$jdXuk) { foreach ($sGhlV as $cANPj) { $tcwC2 = @json_decode($jdXuk[$cANPj], true); if (!empty($tcwC2)) { $jdXuk[$cANPj] = array_map(function ($VL0g3) { return intval($VL0g3); }, $tcwC2); } else { $jdXuk[$cANPj] = array(); } } } goto M23VB; iDVJ1: if (empty($nQYo_)) { return; } goto El0uk; El0uk: if (is_string($sGhlV)) { $sGhlV = array($sGhlV); } goto Q1Z47; M23VB: } public static function decodeRecordJson(&$jdXuk, $sGhlV, $RsCDD = array()) { goto AYbUZ; AYbUZ: if (empty($jdXuk)) { return; } goto Ck5D5; Ck5D5: if (is_string($sGhlV)) { $sGhlV = array($sGhlV); } goto RJHNX; RJHNX: foreach ($sGhlV as $cANPj) { $jdXuk[$cANPj] = @json_decode($jdXuk[$cANPj], true); if (empty($jdXuk[$cANPj])) { $jdXuk[$cANPj] = $RsCDD; } } goto OlWN1; OlWN1: } public static function decodeRecordsJson(&$nQYo_, $sGhlV, $RsCDD = array()) { goto n5z6V; MOwNY: foreach ($nQYo_ as &$jdXuk) { foreach ($sGhlV as $cANPj) { $jdXuk[$cANPj] = @json_decode($jdXuk[$cANPj], true); if (empty($jdXuk[$cANPj])) { $jdXuk[$cANPj] = $RsCDD; } } } goto q13GE; gaaLH: if (is_string($sGhlV)) { $sGhlV = array($sGhlV); } goto MOwNY; n5z6V: if (empty($nQYo_)) { return; } goto gaaLH; q13GE: } public static function encodeRecordJson(&$jdXuk, $sGhlV, $RsCDD = array()) { goto I7hJV; I7hJV: if (empty($jdXuk)) { return; } goto xes8Y; xes8Y: if (is_string($sGhlV)) { $sGhlV = array($sGhlV); } goto yDGa4; yDGa4: foreach ($sGhlV as $cANPj) { if (empty($jdXuk[$cANPj])) { $jdXuk[$cANPj] = $RsCDD; } $jdXuk[$cANPj] = @SerializeUtil::jsonEncode($jdXuk[$cANPj]); } goto YCYjx; YCYjx: } public static function encodeRecordsJson(&$nQYo_, $sGhlV, $RsCDD = array()) { goto t7Ou7; yToYy: foreach ($nQYo_ as &$jdXuk) { foreach ($sGhlV as $cANPj) { if (empty($jdXuk[$cANPj])) { $jdXuk[$cANPj] = $RsCDD; } $jdXuk[$cANPj] = @SerializeUtil::jsonEncode($jdXuk[$cANPj]); } } goto vwpiL; zH7EU: if (is_string($sGhlV)) { $sGhlV = array($sGhlV); } goto yToYy; t7Ou7: if (empty($nQYo_)) { return; } goto zH7EU; vwpiL: } public static function increase($Wa8N4, $kNTjB, $dBa7F, $VuXfH = 1) { return ModelUtil::update($Wa8N4, $kNTjB, array($dBa7F => DB::raw('IFNULL(' . $dBa7F . ',0)' . ($VuXfH > 0 ? '+' . $VuXfH : '-' . abs($VuXfH))))); } public static function change($Wa8N4, $kNTjB, $dBa7F, $VuXfH) { if (is_numeric($kNTjB) || is_string($kNTjB)) { $kNTjB = array('id' => $kNTjB); } if ($VuXfH > 0) { self::model($Wa8N4)->where($kNTjB)->increment($dBa7F, $VuXfH); } else { self::model($Wa8N4)->where($kNTjB)->decrement($dBa7F, -$VuXfH); } } public static function sum($Wa8N4, $dBa7F, $kNTjB = array()) { return self::model($Wa8N4)->where($kNTjB)->sum($dBa7F); } public static function max($Wa8N4, $dBa7F, $kNTjB = array()) { return self::model($Wa8N4)->where($kNTjB)->max($dBa7F); } public static function traverse($Wa8N4, $cANPj, $RsCDD = null) { goto L9arw; YL_sd: return $Wa8N4; goto I0hGW; wynz4: foreach (explode('.', $cANPj) as $Y38bi) { try { $Wa8N4 = $Wa8N4->{$Y38bi}; } catch (\Exception $l8i0J) { return value($RsCDD); } } goto YL_sd; L9arw: if (is_array($Wa8N4)) { return array_get($Wa8N4, $cANPj, $RsCDD); } goto vHzMw; vHzMw: if (is_null($cANPj)) { return $Wa8N4; } goto jZ5EC; jZ5EC: if ($Wa8N4 instanceof \stdClass && isset($Wa8N4->{$cANPj})) { return $Wa8N4->{$cANPj}; } else { if (isset($Wa8N4[$cANPj])) { return $Wa8N4[$cANPj]; } } goto wynz4; I0hGW: } public static function queryRemoveCondition($IpOIw, $EY7Cx, $NS5_3) { goto jq6AY; jq6AY: $EY7Cx = strtolower($EY7Cx); goto FIcxz; azMom: foreach ($xSLR3 as $qsK6T => $yFWLi) { goto ufjTX; LpvXd: $EaxFM += $VMJD4; goto tN76m; ufjTX: $VMJD4 = self::getBindingsCount(array($yFWLi)); goto QI3XQ; QI3XQ: if (strtolower($yFWLi['type']) == $EY7Cx && $yFWLi['column'] == $NS5_3) { goto JZ5pF; dYyDY: break; goto qJjad; JZ5pF: array_splice($yQF3R, $qsK6T, 1); goto uBvpD; uBvpD: array_splice($pC70t, $EaxFM, $VMJD4); goto dYyDY; qJjad: } goto LpvXd; tN76m: } goto HjU7u; bv2lQ: $IpOIw->getQuery()->setBindings($pC70t); goto f9fsT; BHwCx: $EaxFM = 0; goto eGriZ; EjVV8: $gjtDu = $soYF4['where']; goto BHwCx; FIcxz: BizException::throwsIf('Unsupported type ' . $EY7Cx, !in_array($EY7Cx, array('basic', 'in'))); goto Ew0MR; rQINk: $soYF4 = $IpOIw->getQuery()->getRawBindings(); goto EjVV8; Ew0MR: $xSLR3 = $IpOIw->getQuery()->wheres; goto rQINk; f9fsT: return $IpOIw; goto iV0_W; HjU7u: $IpOIw->getQuery()->wheres = $yQF3R; goto bv2lQ; eGriZ: $yQF3R = $xSLR3; goto LefUl; LefUl: $pC70t = $gjtDu; goto azMom; iV0_W: } private static function getBindingsCount($xSLR3) { goto bqmsY; DD5uV: foreach ($xSLR3 as $yFWLi) { switch (strtolower($yFWLi['type'])) { case 'in': $tqe7A += count($yFWLi['values']); break; case 'raw': break; case 'nested': $tqe7A += self::getBindingsCount($yFWLi['query']->wheres); break; default: $tqe7A++; break; } } goto AoCZQ; AoCZQ: return $tqe7A; goto FUcpX; bqmsY: $tqe7A = 0; goto DD5uV; FUcpX: } }