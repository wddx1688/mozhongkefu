<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Core\Util; use Intervention\Image\ImageManagerStatic as Image; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Provider\FontProvider; class ImageUtil { public static function base64Src($dF9Uq, $EY7Cx = 'png') { if (!in_array($EY7Cx, array('png', 'gif', 'jpg', 'jpeg'))) { return null; } return 'data:' . FileUtil::mime($EY7Cx) . ';base64,' . base64_encode($dF9Uq); } public static function limitSizeAndDetectOrientation($hCl98, $pCwrj = 1000, $URAOg = 1000) { goto lnMw3; hqn0h: try { goto FWXdA; vVKRR: $IiWca = Image::make($hCl98); goto L0Vwl; lw3Q0: if ($K5EtC) { $IiWca->save($hCl98); } goto mYxsY; FWXdA: $K5EtC = false; goto t4gMQ; t4gMQ: $MErzL = @exif_read_data($hCl98); goto vVKRR; nu7Ud: if ($Niw0h > $pCwrj || $sZ6c3 > $URAOg) { goto l4DDG; l4DDG: $K5EtC = true; goto apsGc; apsGc: if ($Niw0h > $pCwrj) { $IiWca->resize($pCwrj, intval($pCwrj * $sZ6c3 / $Niw0h)); } goto cEfpv; cEfpv: if ($sZ6c3 > $URAOg) { $IiWca->resize(intval($URAOg * $Niw0h / $sZ6c3), $URAOg); } goto Dru34; Dru34: } goto lw3Q0; L0Vwl: if (!empty($MErzL['Orientation'])) { switch (intval($MErzL['Orientation'])) { case 2: goto YRWeb; YRWeb: $IiWca->flip(); goto Tf66e; kXiQW: break; goto BUilC; Tf66e: $K5EtC = true; goto kXiQW; BUilC: case 3: goto bgg31; S1Nzl: break; goto bD9VT; bgg31: $IiWca->rotate(180); goto rRiMA; rRiMA: $K5EtC = true; goto S1Nzl; bD9VT: case 4: goto cC5Cb; ns3sa: $IiWca->flip(); goto iQCz1; iQCz1: $K5EtC = true; goto uNgV0; uNgV0: break; goto Ve_64; cC5Cb: $IiWca->rotate(180); goto ns3sa; Ve_64: case 5: goto R_NX2; jveY4: break; goto u0VWz; axty9: $K5EtC = true; goto jveY4; R_NX2: $IiWca->rotate(90); goto lVIbe; lVIbe: $IiWca->flip(); goto axty9; u0VWz: case 6: goto sIdgc; iqMcS: break; goto hZr_9; gaeYa: $K5EtC = true; goto iqMcS; sIdgc: $IiWca->rotate(-90); goto gaeYa; hZr_9: case 7: goto pwAgP; oaAFE: break; goto CDTDW; ieIck: $IiWca->flip(); goto hdXzq; pwAgP: $IiWca->rotate(90); goto ieIck; hdXzq: $K5EtC = true; goto oaAFE; CDTDW: case 8: goto o5dfu; K85yU: $K5EtC = true; goto fCJKM; fCJKM: break; goto nfGmV; o5dfu: $IiWca->rotate(90); goto K85yU; nfGmV: } } goto z_Ku3; YvxcR: $sZ6c3 = $IiWca->height(); goto nu7Ud; z_Ku3: $Niw0h = $IiWca->width(); goto YvxcR; mYxsY: } catch (\Exception $l8i0J) { throw $l8i0J; } goto Wpvle; r1ZYa: $MbVsF = FileUtil::extension($hCl98); goto FD2M3; FD2M3: if (!in_array($MbVsF, $cwSCQ)) { return; } goto hqn0h; lnMw3: $cwSCQ = array('jpg', 'jpeg', 'png', 'gif'); goto r1ZYa; Wpvle: } public static function watermark($IiWca, $EY7Cx, $N19iJ, $mH3Yd = array()) { goto x96fe; nraVs: $Mn5lh->destroy(); goto Qb6KB; q4MvZ: if ($mH3Yd['return']) { goto xWv0d; xWv0d: $jq2n1 = $Mn5lh->response('png'); goto PNU1e; PNU1e: $Mn5lh->destroy(); goto Yv9tF; Yv9tF: return $jq2n1; goto aA_OS; aA_OS: } goto NMsxf; NBTVg: $F7un5 = $nyHgK['normalPx']; goto fFSrJ; YZRmw: $mH3Yd = $nyHgK['option']; goto zqZAe; N5alM: $K5EtC = false; goto o0I5x; x96fe: $mH3Yd = array_merge(array('return' => false, 'mode' => 'single', 'rotate' => 'horizontal', 'gapX' => 50, 'gapY' => 30, 'minSizePx' => 100, 'textColor' => '#FFFFFF', 'textOpacity' => 40, 'textSize' => 5, 'textFont' => FontProvider::firstLocalPathOrFail(), 'imageSize' => 20, 'imageOpacity' => 40), $mH3Yd); goto CvlwN; zqZAe: switch ($EY7Cx) { case 'text': goto Z30ql; QzY5Y: break; goto WRuTN; vM2xR: $mH3Yd['_textSize'] = intval($mH3Yd['textSize'] * $F7un5); goto me2pc; me2pc: foreach ($NuMpZ as $w3Csd) { $Mn5lh->text($N19iJ, $w3Csd['x'], $w3Csd['y'], function ($A_ecX) use($mH3Yd) { $A_ecX->file($mH3Yd['_textFont']); $A_ecX->size($mH3Yd['_textSize']); $A_ecX->color($mH3Yd['_textColor']); $A_ecX->align('center'); $A_ecX->valign('center'); if ('oblique' == $mH3Yd['rotate']) { $A_ecX->angle(45); } }); } goto JfH0j; AY3aE: $mH3Yd['_textColor'] = ColorUtil::hexToRgba($zhV8p); goto vM2xR; iknWx: $zhV8p = $mH3Yd['textColor'] . sprintf('%02x', intval($mH3Yd['textOpacity'] * 255 / 100)); goto AY3aE; Z30ql: $mH3Yd['_textFont'] = FileUtil::savePathToLocalTemp($mH3Yd['textFont']); goto iknWx; JfH0j: $K5EtC = true; goto QzY5Y; WRuTN: case 'image': goto SVAIQ; XPUgg: $srEmn->resize($ZSuVh, $LTjeA); goto VgJPB; VgJPB: $srEmn->opacity($mH3Yd['imageOpacity']); goto Zz9oy; g6l7N: $d5BqU = intval($mH3Yd['imageSize'] * $F7un5); goto V6Xcd; lfya4: BizException::throwsIf('watermark image not exists', !file_exists($xNzFe)); goto qkrY7; ZJl00: if ($ZSuVh > $LTjeA) { $LTjeA = intval($d5BqU * $LTjeA / $ZSuVh); $ZSuVh = $d5BqU; } else { $ZSuVh = intval($d5BqU * $ZSuVh / $LTjeA); $LTjeA = $d5BqU; } goto XPUgg; Zz9oy: if ('oblique' == $mH3Yd['rotate']) { $srEmn->rotate(45); } goto Ttx6v; Tjzik: $K5EtC = true; goto vzn7L; ZCXAr: $LTjeA = $srEmn->height(); goto ZJl00; V6Xcd: $ZSuVh = $srEmn->width(); goto ZCXAr; vzn7L: break; goto oiskm; SVAIQ: $xNzFe = FileUtil::savePathToLocalTemp($N19iJ); goto lfya4; Ttx6v: foreach ($NuMpZ as $w3Csd) { $Mn5lh->insert($srEmn, 'top-left', intval($w3Csd['x'] - $ZSuVh / 2), intval($w3Csd['y'] - $LTjeA / 2)); } goto Tjzik; qkrY7: $srEmn = Image::make($xNzFe); goto g6l7N; oiskm: } goto q4MvZ; Qb6KB: return Response::generateSuccessData($nx179); goto XoL7O; NMsxf: $nx179['processed'] = true; goto XbTU2; fFSrJ: $NuMpZ = $nyHgK['points']; goto YZRmw; o0I5x: $nx179 = array('processed' => false, 'success' => false, 'message' => ''); goto TP1vP; fi4CY: $nyHgK = self::calcWatermarkPositionInfo($Niw0h, $sZ6c3, $mH3Yd); goto NBTVg; a6SJ9: $sZ6c3 = $Mn5lh->height(); goto Jlzbe; CvlwN: try { goto xwkWw; xwkWw: BizException::throwsIf('Image not exists', !file_exists($IiWca)); goto YDHXY; dxcDK: BizException::throwsIf('watermark text color error', !preg_match('/^#[0-9a-fA-F]{6}$/', $mH3Yd['textColor'])); goto wAHld; YDHXY: BizException::throwsIf('watermark type error', !in_array($EY7Cx, array('image', 'text'))); goto zDU1z; zDU1z: BizException::throwsIf('watermark content empty', empty($N19iJ)); goto dxcDK; wAHld: } catch (BizException $l8i0J) { return Response::generateError($l8i0J->getMessage()); } goto N5alM; TP1vP: $Mn5lh = Image::make($IiWca); goto mUPw3; mUPw3: $Niw0h = $Mn5lh->width(); goto a6SJ9; Jlzbe: if ($Niw0h < $mH3Yd['minSizePx'] || $sZ6c3 < $mH3Yd['minSizePx']) { goto yKqsx; PWaJG: $nx179['message'] = '图片尺寸过小，不加水印'; goto CgnoR; CgnoR: return Response::generateSuccessData($nx179); goto BPrx6; yKqsx: $Mn5lh->destroy(); goto PWaJG; BPrx6: } goto fi4CY; XbTU2: if ($K5EtC) { $nx179['success'] = true; $Mn5lh->save($IiWca); } goto nraVs; XoL7O: } public static function info($Z3orD) { $Mn5lh = Image::make($Z3orD); return array('width' => $Mn5lh->width(), 'height' => $Mn5lh->height(), 'size' => $Mn5lh->filesize()); } public static function calcWatermarkPositionInfo($Niw0h, $sZ6c3, array $mH3Yd) { goto rNsOv; rNsOv: $F7un5 = min($Niw0h, $sZ6c3) / 100; goto CKAsq; gO1F3: switch ($mH3Yd['mode']) { case 'single': $NuMpZ[] = array('x' => intval($Niw0h / 2), 'y' => intval($sZ6c3 / 2)); break; case 'repeat': goto uGPn1; eAr8C: $Tbipf = array(); goto N8KE5; N8KE5: for ($Oe6bC = 0, $aibkj = intval($Niw0h / 2); $aibkj - $Oe6bC > 0 && $aibkj + $Oe6bC < $Niw0h; $Oe6bC += $mH3Yd['_gapX']) { $Tbipf[] = $aibkj + $Oe6bC; if ($Oe6bC > 0) { $Tbipf[] = $aibkj - $Oe6bC; } } goto PK4aF; PK4aF: for ($Oe6bC = 0, $aibkj = intval($sZ6c3 / 2); $aibkj - $Oe6bC > 0 && $aibkj + $Oe6bC < $sZ6c3; $Oe6bC += $mH3Yd['_gapY']) { foreach ($Tbipf as $LNSdp) { $NuMpZ[] = array('x' => $LNSdp, 'y' => $aibkj + $Oe6bC); if ($Oe6bC > 0) { $NuMpZ[] = array('x' => $LNSdp, 'y' => $aibkj - $Oe6bC); } } } goto uJyWS; VxayR: $mH3Yd['_gapY'] = intval($mH3Yd['gapY'] * $F7un5); goto eAr8C; uJyWS: break; goto lhY4a; uGPn1: $mH3Yd['_gapX'] = intval($mH3Yd['gapX'] * $F7un5); goto VxayR; lhY4a: } goto ysK5g; ysK5g: return array('normalPx' => $F7un5, 'points' => $NuMpZ, 'option' => $mH3Yd); goto PiPvb; CKAsq: $NuMpZ = array(); goto gO1F3; PiPvb: } }