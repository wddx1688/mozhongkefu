<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Module; use Illuminate\Support\Facades\Artisan; use Illuminate\Support\Facades\Log; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\SerializeUtil; use ModStart\Core\Util\VersionUtil; class ModuleManager { const MODULE_ENABLE_LIST = 'ModuleList'; const MODULE_SYSTEM_OVERWRITE_CONFIG = 'ModuleSystemOverwriteConfig'; public static function getModuleBasic($HQ4FM) { goto FQkNJ; sezao: if (file_exists($hCl98 = self::path($HQ4FM, 'config.json'))) { goto wmj68; wmj68: $LyfCI = json_decode(file_get_contents($hCl98), true); goto Ft3Dg; Ft3Dg: if (empty($LyfCI)) { BizException::throws('模块配置文件错误 - ' . $HQ4FM); } goto n05Qv; n05Qv: $tKVmk[$HQ4FM] = array_merge(array('name' => 'None', 'title' => 'None', 'version' => '1.0.0', 'env' => array('laravel5'), 'types' => array(), 'tags' => array(), 'require' => array(), 'suggest' => array(), 'conflicts' => array(), 'modstartVersion' => '*', 'author' => 'Author', 'description' => 'Description', 'config' => array(), 'providers' => array()), $LyfCI); goto my1er; my1er: } else { $tKVmk[$HQ4FM] = null; } goto snhbL; FQkNJ: static $tKVmk = array(); goto EICLW; snhbL: return $tKVmk[$HQ4FM]; goto yC08e; EICLW: if (array_key_exists($HQ4FM, $tKVmk)) { return $tKVmk[$HQ4FM]; } goto sezao; yC08e: } private static function callCommand($kzmw4, $kKcR8 = array()) { try { goto KHpWj; zYSTx: return Response::generateSuccessData(array('output' => $XChuh)); goto VfL3S; vhMbB: if (0 !== $hmkXe) { Log::error("MS.ModuleManager.CallCommand.Error - {$kzmw4} - {$XChuh}"); return Response::generate(-1, "ERROR:{$hmkXe}", array('output' => $XChuh)); } goto zYSTx; KHpWj: $hmkXe = Artisan::call($kzmw4, $kKcR8); goto t3OHk; t3OHk: $XChuh = trim(Artisan::output()); goto vhMbB; VfL3S: } catch (BizException $l8i0J) { return Response::generateError($l8i0J->getMessage()); } catch (\Exception $l8i0J) { $VBX5k = $l8i0J->getMessage(); return Response::generateError(L('Server Error') . ': ' . $VBX5k); } } public static function clean($C1S_N) { $hCl98 = self::path($C1S_N); if (file_exists($hCl98)) { FileUtil::rm($hCl98, true); } } public static function install($C1S_N, $PFyFc = false, $mH3Yd = array()) { goto GqZd7; ihpOz: if ($PFyFc) { $kKcR8['--force'] = true; } goto z84ep; GqZd7: $kKcR8 = array('module' => $C1S_N); goto ihpOz; z84ep: if (!empty($mH3Yd['linkAsset'])) { $kKcR8['--link-asset'] = true; } goto iCzvT; iCzvT: return self::callCommand('modstart:module-install', $kKcR8); goto y6x_M; y6x_M: } public static function uninstall($C1S_N) { return self::callCommand('modstart:module-uninstall', array('module' => $C1S_N)); } public static function enable($C1S_N) { return self::callCommand('modstart:module-enable', array('module' => $C1S_N)); } public static function disable($C1S_N) { return self::callCommand('modstart:module-disable', array('module' => $C1S_N)); } public static function isExists($HQ4FM) { return file_exists(self::path($HQ4FM, 'config.json')); } public static function path($C1S_N, $hCl98 = '') { return base_path(self::relativePath($C1S_N, $hCl98)); } public static function relativePath($C1S_N, $hCl98 = '') { return "module/{$C1S_N}" . ($hCl98 ? '/' . trim($hCl98, '/') : ''); } public static function isSystemModule($C1S_N) { $RwIYu = config('module.system', array()); return isset($RwIYu[$C1S_N]); } public static function isModuleInstalled($HQ4FM) { goto nkU9S; nkU9S: if (!self::isExists($HQ4FM)) { return false; } goto TR93e; zrMxU: return isset($RwIYu[$HQ4FM]); goto gJKas; TR93e: $RwIYu = self::listAllInstalledModules(); goto zrMxU; gJKas: } public static function isModuleEnabled($HQ4FM) { $RwIYu = self::listAllInstalledModules(); return !empty($RwIYu[$HQ4FM]['enable']); } public static function isModuleEnableMatch($HQ4FM, $vRbzB) { goto tJQxK; hnI23: $tKVmk = self::getModuleBasic($HQ4FM); goto bs88K; tJQxK: if (!self::isModuleEnabled($HQ4FM)) { return false; } goto hnI23; bs88K: if (!$tKVmk) { return false; } goto xst5w; xst5w: return VersionUtil::match($tKVmk['version'], $vRbzB); goto z3BPL; z3BPL: } public static function listModules() { goto IDJgK; tSf1P: return $RwIYu; goto ZROAM; M1mMV: foreach ($a3n3M as $yFWLi) { goto QliHu; QliHu: if (!$yFWLi['isDir'] || !preg_match('/^[a-zA-Z0-9_]+$/', $yFWLi['filename'])) { continue; } goto nprpL; AJMGP: $RwIYu[$yFWLi['filename']] = array('enable' => false, 'isSystem' => false, 'isInstalled' => false, 'config' => array()); goto uqBZx; nprpL: if (starts_with($yFWLi['filename'], '_delete_.') || starts_with($yFWLi['filename'], '_') || !file_exists($yFWLi['pathname'] . '/config.json')) { continue; } goto AJMGP; uqBZx: } goto v_2pr; v_2pr: foreach (self::listSystemInstalledModules() as $AkyhD => $LyfCI) { if (isset($RwIYu[$AkyhD])) { goto YOXhx; YOXhx: $RwIYu[$AkyhD]['isInstalled'] = true; goto OHyiw; cgC9A: $RwIYu[$AkyhD]['enable'] = !empty($LyfCI['enable']); goto Uh1Or; OHyiw: $RwIYu[$AkyhD]['isSystem'] = true; goto cgC9A; Uh1Or: } } goto inQAZ; BvKTH: $RwIYu = array(); goto M1mMV; inQAZ: foreach (self::listUserInstalledModules() as $AkyhD => $LyfCI) { if (isset($RwIYu[$AkyhD])) { $RwIYu[$AkyhD]['isInstalled'] = true; $RwIYu[$AkyhD]['enable'] = !empty($LyfCI['enable']); } } goto tSf1P; IDJgK: $a3n3M = FileUtil::listFiles(base_path('module')); goto BvKTH; ZROAM: } public static function listSystemInstalledModules() { goto nmu7E; kZa9A: return $RwIYu; goto xi8hq; Y6jhu: if (config('env.MS_MODULES')) { foreach (explode(',', config('env.MS_MODULES')) as $AkyhD) { if (!empty($AkyhD)) { $RwIYu[$AkyhD] = array('isSystem' => true, 'enable' => true); } } } goto cGfGn; nmu7E: $RwIYu = array_build(config('module.system', array()), function ($dKmL2, $yFWLi) { $yFWLi['isSystem'] = true; if (!isset($yFWLi['enable'])) { $yFWLi['enable'] = false; } return array($dKmL2, $yFWLi); }); goto Y6jhu; cGfGn: try { $UouF8 = modstart_config()->getArray(self::MODULE_SYSTEM_OVERWRITE_CONFIG, array()); if (!empty($UouF8)) { foreach ($UouF8 as $AkyhD => $LyfCI) { goto pfJJW; Bu14u: $RwIYu[$AkyhD]['config'] = array_merge($RwIYu[$AkyhD]['config'], $LyfCI); goto HjC31; zUYxP: if (!isset($RwIYu[$AkyhD]['config'])) { $RwIYu[$AkyhD]['config'] = array(); } goto Bu14u; pfJJW: if (empty($RwIYu[$AkyhD]) || !is_array($LyfCI)) { continue; } goto zUYxP; HjC31: } } } catch (\Exception $l8i0J) { } goto kZa9A; xi8hq: } public static function listUserInstalledModules() { try { return array_build(modstart_config()->getArray(self::MODULE_ENABLE_LIST), function ($dKmL2, $yFWLi) { $yFWLi['isSystem'] = false; if (!isset($yFWLi['enable'])) { $yFWLi['enable'] = false; } return array($dKmL2, $yFWLi); }); } catch (\Exception $l8i0J) { return array(); } } public static function listAllEnableModuleNames() { return array_keys(self::listAllEnabledModules()); } public static function listAllEnabledModules() { return array_filter(self::listAllInstalledModules(), function ($DUr2V) { return $DUr2V['enable']; }); } public static function listAllInstalledModules($su0_O = false) { goto U30rM; vGMw5: if ($su0_O) { $RwIYu = null; } goto lwZdG; U30rM: static $RwIYu = null; goto vGMw5; AdJ4z: $RwIYu = array_merge(self::listUserInstalledModules(), self::listSystemInstalledModules()); goto Rez4W; lwZdG: if (null !== $RwIYu) { return $RwIYu; } goto AdJ4z; Rez4W: return $RwIYu; goto l0dMO; l0dMO: } public static function saveUserInstalledModules($RwIYu) { $RwIYu = array_map(function ($DUr2V) { return ArrayUtil::keepKeys($DUr2V, array('config', 'enable')); }, array_filter($RwIYu, function ($AkyhD) { return empty($AkyhD['isSystem']); })); modstart_config()->setArray(self::MODULE_ENABLE_LIST, $RwIYu); } public static function listAllInstalledModulesInRequiredOrder($PJcR2 = false) { goto q1G3g; YVDfQ: $RwIYu = array_keys($RwIYu); goto zyHAe; YXfq_: for ($qsK6T = 0; $qsK6T < 100; $qsK6T++) { foreach ($RwIYu as $C1S_N) { goto yhCpP; yhCpP: if (in_array($C1S_N, $BUEgU)) { continue; } goto KhN4d; KhN4d: $G6qin = true; goto Qf3BX; Qf3BX: if (!empty($dYaOd[$C1S_N])) { foreach ($dYaOd[$C1S_N] as $ejXOf) { list($AkyhD, $yFWLi) = VersionUtil::parse($ejXOf); if (!in_array($AkyhD, $BUEgU)) { $G6qin = false; } } } goto bhgG6; bhgG6: if ($G6qin) { $BUEgU[] = $C1S_N; } goto viQ3P; viQ3P: } if (count($BUEgU) == count($RwIYu)) { break; } } goto XkWtU; XkWtU: if (!$PJcR2) { if (count($RwIYu) !== count($BUEgU)) { goto gluJO; DnnD8: $ffvFW = array(); goto ZkQSj; ZkQSj: foreach ($pxMM_ as $KJMw4) { $p0wCm = $dYaOd[$KJMw4]; foreach ($p0wCm as $oyMBi) { if (!in_array($oyMBi, $BUEgU)) { $ffvFW[] = L('Module %s Depends On %s', $KJMw4, $oyMBi); } } } goto HvdbB; HvdbB: if (!empty($ffvFW)) { BizException::throws(L('Module Not Fully Installed') . ' ' . join('; ', $ffvFW)); } else { BizException::throws(L('Module Not Fully Installed') . ' ' . L('Requires') . '  ' . SerializeUtil::jsonEncode($RwIYu)); } goto NeSzW; gluJO: list($pxMM_, $De765) = ArrayUtil::diff($BUEgU, $RwIYu); goto DnnD8; NeSzW: } } goto xEjcj; q1G3g: $RwIYu = self::listAllInstalledModules(); goto YVDfQ; xEjcj: return $BUEgU; goto dpXne; m2QR8: $BUEgU = array(); goto YXfq_; JsyS_: foreach ($RwIYu as $C1S_N) { goto Tsgp2; xYtf7: $dYaOd[$C1S_N] = $tKVmk['require']; goto Zjqq7; zuPcI: if (empty($tKVmk)) { continue; } goto xYtf7; Tsgp2: $tKVmk = self::getModuleBasic($C1S_N); goto zuPcI; Zjqq7: } goto m2QR8; zyHAe: $dYaOd = array(); goto JsyS_; dpXne: } public static function getInstalledModuleInfo($C1S_N) { $RwIYu = self::listAllInstalledModules(); return isset($RwIYu[$C1S_N]) ? $RwIYu[$C1S_N] : null; } public static function saveUserInstalledModuleConfig($C1S_N, $LyfCI) { goto K783V; CPFYa: if (!empty($RwIYu[$C1S_N])) { if (empty($RwIYu[$C1S_N]['config'])) { $RwIYu[$C1S_N]['config'] = array(); } $RwIYu[$C1S_N]['config'] = array_merge($RwIYu[$C1S_N]['config'], $LyfCI); } goto yqwkR; K783V: $RwIYu = self::listUserInstalledModules(); goto CPFYa; yqwkR: self::saveUserInstalledModules($RwIYu); goto ula68; ula68: } public static function saveSystemOverwriteModuleConfig($C1S_N, $LyfCI) { goto Zdh1K; Zdh1K: $S0wnp = modstart_config()->getArray(self::MODULE_SYSTEM_OVERWRITE_CONFIG); goto Rdx_b; MVj1L: modstart_config()->setArray(self::MODULE_SYSTEM_OVERWRITE_CONFIG, $S0wnp); goto iuV8b; Rdx_b: $S0wnp[$C1S_N] = $LyfCI; goto MVj1L; iuV8b: } public static function getModuleConfig($C1S_N, $cANPj, $RsCDD = null) { goto whNzM; whNzM: $B4TX8 = self::getInstalledModuleInfo($C1S_N); goto K5FDe; YmvhO: return $RsCDD; goto D6iDF; K5FDe: if (isset($B4TX8['config'][$cANPj])) { goto po0Tk; po0Tk: $yFWLi = $B4TX8['config'][$cANPj]; goto sh_Mo; zr0Pu: if (is_int($RsCDD)) { return intval($yFWLi); } goto icwq3; icwq3: if (is_array($RsCDD)) { goto eULWX; MQIJ1: return $yFWLi; goto l8Wyk; QFRy4: if (null === $yFWLi) { return $RsCDD; } goto MQIJ1; eULWX: if (is_string($yFWLi)) { $yFWLi = @json_decode($yFWLi, true); } goto QFRy4; l8Wyk: } goto r5iEs; r5iEs: return $B4TX8['config'][$cANPj]; goto pwCBW; sh_Mo: if (true === $RsCDD || false === $RsCDD) { return boolval($yFWLi); } goto zr0Pu; pwCBW: } goto YmvhO; D6iDF: } public static function getModuleConfigArray($C1S_N, $cANPj, $RsCDD = array()) { goto tigTK; vyjaT: if (empty($VuXfH)) { $VuXfH = $RsCDD; } goto sf9B6; QW4SI: $VuXfH = @json_decode($VuXfH, true); goto vyjaT; sf9B6: return $VuXfH; goto RoQfT; QWvGh: if (is_array($VuXfH)) { return $VuXfH; } goto QW4SI; tigTK: $VuXfH = self::getModuleConfig($C1S_N, $cANPj); goto QWvGh; RoQfT: } public static function getModuleConfigBoolean($C1S_N, $cANPj, $RsCDD = false) { return !!self::getModuleConfig($C1S_N, $cANPj, $RsCDD); } public static function getModuleConfigKeyValueItems($C1S_N, $cANPj, $RsCDD = array()) { goto KCHxG; oVYsR: return $jq2n1; goto Eh82h; HweCQ: if (!empty($VuXfH) && is_array($VuXfH)) { foreach ($VuXfH as $DUr2V) { if (isset($DUr2V['k']) && isset($DUr2V['v'])) { $jq2n1[$DUr2V['k']] = $DUr2V['v']; } } } goto oVYsR; KCHxG: $VuXfH = self::getModuleConfigArray($C1S_N, $cANPj, $RsCDD); goto IgxyM; IgxyM: $jq2n1 = array(); goto HweCQ; Eh82h: } public static function getModuleConfigKeyValueItem($C1S_N, $cANPj, $Jji3z, $RsCDD = null) { goto sMsNb; sMsNb: $c0PBf = self::getModuleConfigKeyValueItems($C1S_N, $cANPj); goto eu1jY; sFP4P: return $RsCDD; goto Oz3TA; eu1jY: if (isset($c0PBf[$Jji3z])) { return $c0PBf[$Jji3z]; } goto sFP4P; Oz3TA: } public static function hotReloadSystemConfig() { goto z83yk; rVZKs: self::listAllInstalledModules(true); goto BzVsC; z83yk: $CPFIn = config('module.system', array()); goto Ai6uw; TklL0: if (file_exists($Z3orD)) { goto kHdu6; QUX1W: $CPFIn = array_merge($CPFIn, $lEter['system']); goto d07Pb; kHdu6: if (function_exists('opcache_invalidate')) { opcache_invalidate($Z3orD); } goto A2KmS; A2KmS: $lEter = (include $Z3orD); goto QUX1W; d07Pb: config(array('module.system' => $CPFIn)); goto iZBjD; iZBjD: } goto rVZKs; Ai6uw: $Z3orD = base_path('config/module.php'); goto TklL0; BzVsC: } public static function callHook($C1S_N, $lrQvV, $jrTHd = array()) { $iCXib = '\\Module\\' . $C1S_N . '\\Core\\ModuleHook'; if (class_exists($iCXib)) { $WB3ei = app($iCXib); if (method_exists($WB3ei, $lrQvV)) { call_user_func_array(array($WB3ei, $lrQvV), $jrTHd); } } } public static function getEnv() { if (PHP_VERSION_ID >= 80000) { return 'laravel9'; } return 'laravel5'; } }