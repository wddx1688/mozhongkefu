<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Misc\Html; use Exception; use HTMLPurifier; use HTMLPurifier_Config; use Illuminate\Contracts\Config\Repository; use Illuminate\Filesystem\Filesystem; class Purifier { protected $files; protected $config; protected $purifier; public function __construct(Filesystem $a3n3M, Repository $LyfCI) { goto Kidic; dd8W3: $this->setUp(); goto uyHhA; Kidic: $this->files = $a3n3M; goto UTtR4; UTtR4: $this->config = $LyfCI; goto dd8W3; uyHhA: } public static function cleanHtml($dAsjP, $LyfCI = null) { goto vBZfc; M9XQa: return $E3pBM->clean($dAsjP, $LyfCI); goto awf0x; vBZfc: static $E3pBM = null; goto EFepi; EFepi: if (null === $E3pBM) { goto Ya09r; Ya09r: $FFJb_ = app(); goto nHIZu; XqUDt: $E3pBM = new Purifier($FFJb_['files'], new \Illuminate\Config\Repository($iHbcW)); goto Nrdev; nHIZu: $iHbcW = (include __DIR__ . '/config.php'); goto XqUDt; Nrdev: } goto M9XQa; awf0x: } private function setUp() { goto fJ9Ss; Nxm6T: $LyfCI->loadArray($this->getConfig()); goto yHbVN; yHbVN: if ($SZHO2 = $this->config->get('settings.custom_definition')) { $this->addCustomDefinition($SZHO2, $LyfCI); } goto zF9p1; Z8Y0m: if ($I1N_U = $this->config->get('settings.custom_attributes')) { if ($aAZTP = $LyfCI->maybeGetRawHTMLDefinition()) { $this->addCustomAttributes($I1N_U, $aAZTP); } } goto x0F3_; tp_Ao: if (!$this->config->get('finalize')) { $LyfCI->autoFinalize = false; } goto Nxm6T; x0F3_: $this->purifier = new HTMLPurifier($this->configure($LyfCI)); goto UIYaQ; zF9p1: if ($sZDGg = $this->config->get('settings.custom_elements')) { if ($aAZTP = $LyfCI->maybeGetRawHTMLDefinition()) { $this->addCustomElements($sZDGg, $aAZTP); } } goto Z8Y0m; RBgP3: $LyfCI = HTMLPurifier_Config::createDefault(); goto tp_Ao; fJ9Ss: $this->checkCacheDirectory(); goto RBgP3; UIYaQ: } private function addCustomDefinition(array $SZHO2, $s5B7j = null) { goto olCYj; oy7pw: $s5B7j->set('HTML.DefinitionID', $SZHO2['id']); goto Z02qS; olCYj: if (!$s5B7j) { $s5B7j = HTMLPurifier_Config::createDefault(); $s5B7j->loadArray($this->getConfig()); } goto oy7pw; Z02qS: $s5B7j->set('HTML.DefinitionRev', $SZHO2['rev']); goto nBbdy; p3Qxk: return $s5B7j; goto QJpIp; Za1FX: if ($aAZTP = $s5B7j->maybeGetRawHTMLDefinition()) { if (!empty($SZHO2['attributes'])) { $this->addCustomAttributes($SZHO2['attributes'], $aAZTP); } if (!empty($SZHO2['elements'])) { $this->addCustomElements($SZHO2['elements'], $aAZTP); } } goto p3Qxk; nBbdy: if (!isset($SZHO2['debug']) || $SZHO2['debug']) { $s5B7j->set('Cache.DefinitionImpl', null); } goto Za1FX; QJpIp: } private function addCustomAttributes(array $I1N_U, $Z8_JV) { foreach ($I1N_U as $N_IE2) { goto dx1k8; qCZJr: $Z8_JV->addAttribute($btnzQ, $P959_, $HAA0j); goto H9uDx; BB9qp: $btnzQ = $N_IE2[0]; goto nA1ht; Ut55P: $HAA0j = $N_IE2[2]; goto qCZJr; nA1ht: $P959_ = $gBLxh ? $N_IE2[1] . '*' : $N_IE2[1]; goto Ut55P; dx1k8: $gBLxh = !empty($N_IE2[3]) ? true : false; goto BB9qp; H9uDx: } return $Z8_JV; } private function addCustomElements(array $sZDGg, $Z8_JV) { foreach ($sZDGg as $MwNmy) { goto phah2; wUA0v: if (!empty($I1N_U)) { $Z8_JV->addElement($HQ4FM, $pg12F, $heYAr, $nZF_F, $I1N_U); } else { $Z8_JV->addElement($HQ4FM, $pg12F, $heYAr, $nZF_F); } goto vPiB8; phah2: $HQ4FM = $MwNmy[0]; goto gr1eO; OHrtv: $I1N_U = isset($MwNmy[4]) ? $MwNmy[4] : null; goto wUA0v; FPf4d: $nZF_F = $MwNmy[3]; goto OHrtv; gr1eO: $pg12F = $MwNmy[1]; goto g2E8n; g2E8n: $heYAr = $MwNmy[2]; goto FPf4d; vPiB8: } } private function checkCacheDirectory() { $H1Rzh = $this->config->get('cachePath'); if ($H1Rzh) { if (!$this->files->isDirectory($H1Rzh)) { $this->files->makeDirectory($H1Rzh, $this->config->get('cacheFileMode', 493)); } } } protected function configure(HTMLPurifier_Config $LyfCI) { return HTMLPurifier_Config::inherit($LyfCI); } protected function getConfig($LyfCI = null) { goto D2GVp; zwOaw: return $LyfCI; goto V5yLN; pgb_2: $Lonj7['Cache.SerializerPermissions'] = $this->config->get('cacheFileMode', 493); goto qXuLW; ryBMe: if (!is_array($LyfCI)) { $LyfCI = array(); } goto u3i6i; jwCAQ: $Lonj7['Cache.SerializerPath'] = $this->config->get('cachePath'); goto pgb_2; D2GVp: $Lonj7 = array(); goto S0rq4; S0rq4: $Lonj7['Core.Encoding'] = $this->config->get('encoding'); goto jwCAQ; qXuLW: if (!$LyfCI) { $LyfCI = $this->config->get('settings.default'); } elseif (is_string($LyfCI)) { $LyfCI = $this->config->get('settings.' . $LyfCI); } goto ryBMe; u3i6i: $LyfCI = $Lonj7 + $LyfCI; goto zwOaw; V5yLN: } public function clean($dAsjP, $LyfCI = null) { if (is_array($dAsjP)) { return array_map(function ($DUr2V) use($LyfCI) { return $this->clean($DUr2V, $LyfCI); }, $dAsjP); } return $this->purifier->purify($dAsjP, $this->getConfig($LyfCI)); } public function getInstance() { return $this->purifier; } }