<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Data; use Illuminate\Support\Facades\Input; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Type\UploadType; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\Data\Event\DataUploadedEvent; use ModStart\Data\Event\DataUploadingEvent; use Symfony\Component\HttpFoundation\File\UploadedFile; class UeditorManager { private static function listCatcherIgnoreDomains() { goto wZnIf; cGLm0: $g00hM = modstart_config()->getArray('Data_RemoteCatchIgnoreDomains', array()); goto ypRjz; cTPn7: return array_unique($T5p2v); goto QRSmw; ypRjz: if (!empty($g00hM)) { $T5p2v = array_merge($T5p2v, $g00hM); } goto cTPn7; NNsR6: if ($JDFqy) { if ($Oe6bC = $JDFqy->domain()) { $T5p2v[] = $Oe6bC; } } goto cGLm0; omTUy: if ($diycn = Request::domain()) { $T5p2v[] = $diycn; } goto oJF98; oJF98: $JDFqy = DataManager::storage(); goto NNsR6; wZnIf: $T5p2v = array(); goto jEmnI; jEmnI: if ($N1V6D = trim(AssetsUtil::cdn(), '/') ? AssetsUtil::cdn() : null) { $T5p2v[] = $N1V6D; } goto omTUy; QRSmw: } private static function basicConfig() { goto iiVGv; QuueZ: return $LyfCI; goto OJs7T; iiVGv: $iE1EM = config('data.upload', array()); goto qA1SG; qA1SG: $LyfCI = array('imageActionName' => 'image', 'imageFieldName' => 'file', 'imageMaxSize' => $iE1EM['image']['maxSize'], 'imageAllowFiles' => array_map(function ($yFWLi) { return '.' . $yFWLi; }, $iE1EM['image']['extensions']), 'imageCompressEnable' => true, 'imageCompressBorder' => 5000, 'imageInsertAlign' => 'none', 'imageUrlPrefix' => '', 'scrawlActionName' => 'crawl', 'scrawlFieldName' => 'file', 'scrawlMaxSize' => $iE1EM['image']['maxSize'], 'scrawlUrlPrefix' => '', 'scrawlInsertAlign' => 'none', 'snapscreenActionName' => 'snap', 'snapscreenUrlPrefix' => '', 'snapscreenInsertAlign' => 'none', 'catcherLocalDomain' => self::listCatcherIgnoreDomains(), 'catcherActionName' => 'catch', 'catcherFieldName' => 'source', 'catcherUrlPrefix' => '', 'catcherMaxSize' => $iE1EM['image']['maxSize'], 'catcherAllowFiles' => array_map(function ($yFWLi) { return '.' . $yFWLi; }, $iE1EM['image']['extensions']), 'videoActionName' => 'video', 'videoFieldName' => 'file', 'videoUrlPrefix' => '', 'videoMaxSize' => $iE1EM['video']['maxSize'], 'videoAllowFiles' => array_map(function ($yFWLi) { return '.' . $yFWLi; }, $iE1EM['video']['extensions']), 'fileActionName' => 'file', 'fileFieldName' => 'file', 'fileUrlPrefix' => '', 'fileMaxSize' => $iE1EM['file']['maxSize'], 'fileAllowFiles' => array_map(function ($yFWLi) { return '.' . $yFWLi; }, $iE1EM['file']['extensions']), 'imageManagerActionName' => 'listImage', 'imageManagerListSize' => 20, 'imageManagerUrlPrefix' => '', 'imageManagerInsertAlign' => 'none', 'imageManagerAllowFiles' => array_map(function ($yFWLi) { return '.' . $yFWLi; }, $iE1EM['image']['extensions']), 'fileManagerActionName' => 'listFile', 'fileManagerUrlPrefix' => '', 'fileManagerListSize' => 20, 'fileManagerAllowFiles' => array_map(function ($yFWLi) { return '.' . $yFWLi; }, $iE1EM['file']['extensions']), 'formulaConfig' => array('imageUrlTemplate' => modstart_config('UEditor_FormulaImageUrlTemplate', 'https://r.latexeasy.com/image.svg?{}'), 'editorMode' => modstart_config('UEditor_FormulaEditorMode', 'live'), 'editorLiveServer' => modstart_config('UEditor_FormulaEditorLiveServer', 'https://latexeasy.com'))); goto QuueZ; OJs7T: } private static function saveToUser($mNNZK, $OLPDZ, $nx179, $EY7Cx = null) { goto D5bnQ; D5bnQ: $KJMw4 = array('category' => $nx179['category'], 'dataId' => $nx179['id'], 'uploadCategoryId' => 0, 'userId' => $OLPDZ); goto HpSHC; waJeJ: ModelUtil::insert($mNNZK, $KJMw4); goto jMp32; HpSHC: if (!is_null($EY7Cx)) { $KJMw4['type'] = $EY7Cx; } goto waJeJ; jMp32: } private static function resultError($jq2n1 = null, $H8Ec_ = 'ERROR') { goto e_Ava; e_Ava: if (null == $jq2n1) { $jq2n1 = array('state' => ''); } goto p4t29; EcbYv: return Response::jsonRaw($jq2n1); goto C9LIT; p4t29: $jq2n1['state'] = $H8Ec_; goto EcbYv; C9LIT: } public static function handle($mNNZK, $gJcm5, $OLPDZ, $mH3Yd = null) { goto x7c0w; hY1s8: $CDUjL = $gY_Ck->getTrimString('action'); goto inin2; tCKCQ: switch ($CDUjL) { case 'config': return Response::jsonRaw($LyfCI); case 'image': goto TFPUm; RoJDv: return Response::jsonRaw($Y4Ap0); goto x8OEX; TFPUm: DataUploadingEvent::fire($mNNZK, $OLPDZ, 'image'); goto xl0JO; pQUAf: if (in_array($mNNZK, array('member_upload'))) { $EY7Cx = UploadType::USER; } goto So0ml; xl0JO: $Y4Ap0 = array('state' => 'SUCCESS', 'url' => null); goto MhV1G; ilcXg: DataUploadedEvent::fire($mNNZK, $OLPDZ, 'image', $nMi2c['data']['data']['id']); goto RoJDv; DprD9: $owyBa = FileUtil::getUploadFileNameWithExt($Z3orD); goto BhMQP; Lt3Hl: $nMi2c = DataManager::upload('image', $owyBa, $N19iJ, $mH3Yd); goto nGWIv; BhMQP: $N19iJ = file_get_contents($Z3orD->getRealPath()); goto Lt3Hl; TSLIs: if (empty($Z3orD)) { return self::resultError($Y4Ap0, 'File Empty'); } goto DprD9; So0ml: self::saveToUser($mNNZK, $OLPDZ, $nMi2c['data']['data'], $EY7Cx); goto uUxpv; uUxpv: $Y4Ap0['url'] = $nMi2c['data']['fullPath']; goto ilcXg; BnMvz: $EY7Cx = null; goto pQUAf; MhV1G: $Z3orD = Input::file('file'); goto TSLIs; nGWIv: if ($nMi2c['code']) { return self::resultError($Y4Ap0, $nMi2c['msg']); } goto BnMvz; x8OEX: case 'catch': goto njE6f; jC6FS: $Y4Ap0['state'] = 'SUCCESS'; goto g1WE3; JfKUz: foreach ($T5p2v as $vhE98) { goto a7wik; M3y5N: if (!$eNBcu && preg_match('/^(http|ftp|https):\\/\\//i', $vhE98)) { $G_V8N = CurlUtil::getRaw($vhE98, array(), array('header' => array('referer' => $vhE98, 'user-agent' => CurlUtil::mockUserAgent()), 'returnRaw' => true)); if ($G_V8N['httpCode'] == 200) { $MbVsF = FileUtil::mimeToExt($G_V8N['contentType']); if ($MbVsF && in_array('.' . $MbVsF, $LyfCI['catcherAllowFiles'])) { $nMi2c = DataManager::upload('image', L('Image') . '.' . $MbVsF, $G_V8N['body'], $mH3Yd); if ($nMi2c['code']) { $nMi2c['state'] = $nMi2c['msg']; } else { goto jABCg; PCK5m: if (in_array($mNNZK, array('member_upload'))) { $EY7Cx = UploadType::USER; } goto Sz0v3; MZrMw: DataUploadedEvent::fire($mNNZK, $OLPDZ, 'image', $nMi2c['data']['data']['id']); goto JYd_4; JYd_4: $cvEyh[] = array('state' => 'SUCCESS', 'url' => $nMi2c['data']['fullPath'], 'size' => strlen($G_V8N['body']), 'title' => '', 'original' => '', 'source' => htmlspecialchars($vhE98)); goto x_yga; jABCg: $EY7Cx = null; goto PCK5m; Sz0v3: self::saveToUser($mNNZK, $OLPDZ, $nMi2c['data']['data'], $EY7Cx); goto MZrMw; x_yga: } } else { $nMi2c['state'] = 'save remote file extension not permit'; } } else { $nMi2c['state'] = 'get remote file error'; } } else { $cvEyh[] = array('state' => 'not remote image', 'url' => '', 'size' => '', 'title' => '', 'original' => '', 'source' => htmlspecialchars($vhE98)); } goto JE8l7; kWR5v: foreach ($WHe6u as $ARzDD) { if (str_contains($vhE98, $ARzDD)) { $eNBcu = true; break; } } goto M3y5N; a7wik: $eNBcu = false; goto kWR5v; JE8l7: } goto k9iBo; Pugec: $cvEyh = array(); goto jHDRr; jHDRr: $T5p2v = $gY_Ck->getArray($LyfCI['catcherFieldName']); goto ZjxWm; g1WE3: $WHe6u = self::listCatcherIgnoreDomains(); goto JfKUz; njE6f: DataUploadingEvent::fire($mNNZK, $OLPDZ, 'image'); goto T0c7I; T2X1y: return Response::jsonRaw($Y4Ap0); goto mmlsp; k9iBo: $Y4Ap0['list'] = $cvEyh; goto T2X1y; T0c7I: $Y4Ap0 = array('state' => '', 'list' => null); goto Pugec; ZjxWm: if (empty($T5p2v)) { return self::resultError($Y4Ap0); } goto jC6FS; mmlsp: } goto bkcns; inin2: if (in_array($CDUjL, array('image', 'catch'))) { set_time_limit(60); if ($mNNZK == 'admin_upload' && AdminPermission::isDemo()) { return self::resultError(); } } goto tCKCQ; IrCcK: $gY_Ck = InputPackage::buildFromInput(); goto hY1s8; x7c0w: $LyfCI = self::basicConfig(); goto IrCcK; bkcns: } }