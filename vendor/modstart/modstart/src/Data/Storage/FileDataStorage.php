<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Data\Storage; use ModStart\Core\Input\Response; use ModStart\Data\AbstractDataStorage; use ModStart\Data\Event\DataFileUploadedEvent; class FileDataStorage extends AbstractDataStorage { public function init() { } public function get($Z3orD) { if ($this->localStorage->has($Z3orD)) { return $this->localStorage->get($Z3orD); } return null; } public function size($Z3orD) { return $this->localStorage->size($Z3orD); } public function put($Z3orD, $N19iJ) { $this->localStorage->put($Z3orD, $N19iJ); } public function has($Z3orD) { return $this->localStorage->has($Z3orD); } public function delete($Z3orD) { $this->localStorage->delete($Z3orD); } public function move($XfNw_, $oTyWU) { $this->localStorage->copy($XfNw_, $oTyWU); $this->localStorage->delete($XfNw_); } public function multiPartInit($kKcR8) { goto Ix79q; Ix79q: $VzL_6 = $this->multiPartInitToken($kKcR8); goto GP0tS; wkiZY: return Response::generate(0, 'ok', $VzL_6); goto LhGQG; GP0tS: $this->uploadChunkTokenAndUpdateToken($VzL_6); goto wkiZY; LhGQG: } public function multiPartUpload($kKcR8) { goto NuUL9; NuUL9: $VzL_6 = $this->multiPartInitToken($kKcR8); goto LqA1T; GOtTa: if (empty($gY_Ck['file'])) { return Response::generateError('MultiPartUpload file empty'); } goto msRLC; aDqsU: return Response::generate(0, 'ok', $nx179); goto wufD1; zUwMs: if (!isset($gY_Ck['chunk'])) { $gY_Ck['chunk'] = 0; } goto GOtTa; LqA1T: $gY_Ck = $kKcR8['input']; goto h1tfX; b9AqF: $nx179['file'] = $gY_Ck['file']; goto OzE4t; JBCT6: if ($nx179['chunk'] < $nx179['chunks']) { goto G37iS; WYvEg: $nx179['finished'] = false; goto zGbW9; ErCY3: $VzL_6['chunkUploaded'] = $nx179['chunk'] + 1; goto V0bqB; uS2uC: if (false === $RfXiF) { $RfXiF = $nx179['file']->getPathname(); } goto iSU8Q; G37iS: $RfXiF = $nx179['file']->getRealPath(); goto uS2uC; V0bqB: $this->uploadChunkTokenAndUpdateToken($VzL_6); goto WYvEg; zGbW9: if ($VzL_6['chunkUploaded'] == $nx179['chunks']) { goto uAw3o; PLty9: $this->move($DX8tH, $VzL_6['fullPath']); goto BUNmX; jVe0R: $nx179['path'] = $VzL_6['fullPath']; goto PMS1Y; K1RkT: $this->uploadChunkTokenAndDeleteToken($VzL_6); goto gPePm; PMS1Y: $nx179['preview'] = $this->getDriverFullPath($VzL_6['fullPath']); goto JHQ9o; BzfpC: if ($BFibK != $VzL_6['size']) { return Response::generate(-1, 'MultiPartUpload combile file failed (' . $BFibK . ',' . $VzL_6['size'] . ') ShouldRetryUpload'); } goto PLty9; uAw3o: $this->combine($DX8tH); goto K1RkT; ndRJ4: $SEkL2 = $this->repository->addTemp($gAXRi, $VzL_6['path'], $VzL_6['name'], $VzL_6['size'], empty($VzL_6['md5']) ? null : $VzL_6['md5']); goto O45x8; gPePm: $BFibK = $this->size($DX8tH); goto BzfpC; JHQ9o: $nx179['finished'] = true; goto DX6_V; BUNmX: DataFileUploadedEvent::fire(null, $gAXRi, $VzL_6['fullPath']); goto ndRJ4; O45x8: $nx179['data'] = $SEkL2; goto jVe0R; DX6_V: } goto TtiU6; y3eyx: $this->localStorage->put($DX8tH . '.' . $nx179['chunk'], $N19iJ); goto ErCY3; iSU8Q: $N19iJ = file_get_contents($RfXiF); goto y3eyx; TtiU6: } goto aDqsU; OzE4t: $DX8tH = self::DATA_CHUNK . '/data/' . $VzL_6['hash']; goto JBCT6; YvLSB: $nx179['chunk'] = $gY_Ck['chunk']; goto b9AqF; GCPXn: $nx179 = array(); goto lyU2e; msRLC: $nx179['chunks'] = $gY_Ck['chunks']; goto YvLSB; lyU2e: if (!isset($gY_Ck['chunks'])) { $gY_Ck['chunks'] = 1; } goto zUwMs; h1tfX: $gAXRi = $kKcR8['category']; goto GCPXn; wufD1: } private function combine($Z3orD) { goto ja90y; ja90y: $oQtao = config('filesystems.disks.data.root'); goto EjEb2; GJr_P: if (flock($rcobI, LOCK_EX)) { for ($qsK6T = 0;; $qsK6T++) { if (!$this->localStorage->has($Z3orD . '.' . $qsK6T)) { break; } $N19iJ = file_get_contents($oQtao . $Z3orD . '.' . $qsK6T); fwrite($rcobI, $N19iJ); @unlink($oQtao . $Z3orD . '.' . $qsK6T); } flock($rcobI, LOCK_UN); } goto KgYLZ; EjEb2: $rcobI = @fopen($oQtao . $Z3orD, 'wb'); goto GJr_P; KgYLZ: fclose($rcobI); goto jOpem; jOpem: } }