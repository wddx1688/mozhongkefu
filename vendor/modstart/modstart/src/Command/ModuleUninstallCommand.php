<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Command; use Illuminate\Console\Command; use Illuminate\Support\Facades\Event; use ModStart\Core\Events\ModuleUninstalledEvent; use ModStart\Core\Exception\BizException; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\VersionUtil; use ModStart\ModStart; use ModStart\Module\ModuleManager; class ModuleUninstallCommand extends Command { protected $signature = 'modstart:module-uninstall {module}'; public function handle() { goto Iqwrm; mEsEw: ModuleManager::saveUserInstalledModules($Fkq2W); goto Sv_2F; m30_W: $bZKZ0->name = $C1S_N; goto x6fbF; Iqwrm: $C1S_N = $this->argument('module'); goto Hw9sW; iGxI9: if ($BGoTW) { goto ws4hX; ws4hX: BizException::throwsIf(L('Module not installed'), !isset($Fkq2W[$C1S_N])); goto Z7agC; ZcJ0l: ModuleManager::callHook($C1S_N, 'hookBeforeUninstall'); goto k2Xiv; Z7agC: foreach ($Fkq2W as $oyMBi => $Wos7B) { goto i0aOm; Y67EQ: if (!empty($tKVmk['require'])) { foreach ($tKVmk['require'] as $uB6cD) { list($AkyhD, $yFWLi) = VersionUtil::parse($uB6cD); BizException::throwsIf(L('Module %s depend on %s, uninstall fail', $oyMBi, $C1S_N), $C1S_N == $AkyhD); } } goto OzIUt; i0aOm: $tKVmk = ModuleManager::getModuleBasic($oyMBi); goto xA1oE; xA1oE: if (empty($tKVmk)) { break; } goto Y67EQ; OzIUt: } goto ZcJ0l; k2Xiv: } goto RABCk; Hw9sW: $BGoTW = ModuleManager::isExists($C1S_N); goto d1ns_; RABCk: unset($Fkq2W[$C1S_N]); goto r4nCS; tG2gy: $this->unPublishRoot($C1S_N); goto mEsEw; x6fbF: if (PHP_VERSION_ID >= 80000) { Event::dispatch($bZKZ0); } else { Event::fire($bZKZ0); } goto MorYv; d1ns_: $Fkq2W = ModuleManager::listAllInstalledModules(); goto iGxI9; ElRhI: $bZKZ0 = new ModuleUninstalledEvent(); goto m30_W; r4nCS: $this->unPublishAsset($C1S_N); goto tG2gy; Sv_2F: ModStart::clearCache(); goto ElRhI; MorYv: } private function unPublishAsset($C1S_N) { goto LpJap; U6iQd: $Mzpvr->deleteDirectory($oTyWU); goto JMTOo; MAvSC: $oTyWU = public_path("vendor/{$C1S_N}/"); goto Q3kn0; JMTOo: $this->info("Module Asset UnPublish : {$oTyWU}"); goto TpqDX; Q3kn0: if (!file_exists($oTyWU)) { return; } goto U6iQd; LpJap: $Mzpvr = $this->laravel['files']; goto PLux8; PLux8: $XfNw_ = ModuleManager::path($C1S_N, 'Asset') . '/'; goto OWDJG; OWDJG: if (!file_exists($XfNw_)) { return; } goto MAvSC; TpqDX: } private function unPublishRoot($C1S_N) { goto qau6z; BcllJ: $a3n3M = FileUtil::listAllFiles($oQtao); goto cUVEm; qau6z: $oQtao = ModuleManager::path($C1S_N, 'ROOT'); goto idkrP; YofdA: foreach ($a3n3M as $Z3orD) { goto sPBMD; wHeI6: $v_BtY = $XuDmz . '._delete_.' . $C1S_N; goto W71LP; sPBMD: $uPgOC = $Z3orD['filename']; goto Kg472; TWVmC: $XuDmz = base_path($uPgOC); goto wHeI6; Kg472: $s3cfo = $uPgOC . '._delete_.' . $C1S_N; goto TWVmC; tSwL7: if (!file_exists($v_BtY) && md5_file($XuDmz) == md5_file($Z3orD['pathname']) || file_exists($v_BtY)) { goto YkGG5; YkGG5: unlink($XuDmz); goto ICK_o; lwzTv: $p3nw5++; goto HyNGW; ICK_o: if (file_exists($v_BtY)) { $N19iJ = trim(file_get_contents($v_BtY)); if ('__MODSTART_EMPTY_FILE__' == $N19iJ) { unlink($v_BtY); $this->info("Module Root Publish : {$uPgOC}"); } else { rename($v_BtY, $XuDmz); $this->info("Module Root Publish : {$uPgOC} <- {$s3cfo}"); } } goto lwzTv; HyNGW: } goto HXiCW; W71LP: if (!file_exists($XuDmz)) { continue; } goto tSwL7; HXiCW: } goto hthVZ; idkrP: if (!file_exists($oQtao)) { return; } goto BcllJ; hthVZ: $this->info("Module Root UnPublish : {$p3nw5} item(s)"); goto rE5ZM; cUVEm: $a3n3M = array_filter($a3n3M, function ($Z3orD) { return $Z3orD['isFile']; }); goto kOOy5; kOOy5: $p3nw5 = 0; goto YofdA; rE5ZM: } }