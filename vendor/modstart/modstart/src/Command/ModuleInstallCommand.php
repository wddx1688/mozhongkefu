<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Command; use Illuminate\Console\Command; use Illuminate\Support\Facades\Event; use ModStart\Core\Events\ModuleInstalledEvent; use ModStart\Core\Exception\BizException; use ModStart\Core\Util\FileUtil; use ModStart\Core\Util\VersionUtil; use ModStart\ModStart; use ModStart\Module\ModuleManager; class ModuleInstallCommand extends Command { protected $signature = 'modstart:module-install {module} {--link-asset} {--force}'; public function handle() { goto DytBr; JnntG: $Fkq2W = ModuleManager::listAllInstalledModules(); goto VuMuJ; j9cZT: $XChuh = null; goto wuiV1; W60Zn: BizException::throwsIf(L('Module Invalid'), !ModuleManager::isExists($C1S_N)); goto JnntG; vvyr0: $bZKZ0 = new ModuleInstalledEvent(); goto piNef; VuMuJ: $tKVmk = ModuleManager::getModuleBasic($C1S_N); goto Mkj9P; vj0oM: $this->info('Module Install Success'); goto bUYrq; wuiV1: $this->migrate($C1S_N); goto f4CAJ; bhunD: if (!empty($tKVmk['conflicts'])) { foreach ($tKVmk['conflicts'] as $uzl5U) { goto W17ZO; Y8tY3: BizException::throwsIf(L('Module %s:%s conflict with %s:%s, install fail', $C1S_N, $tKVmk['version'], $AkyhD, $yFWLi), VersionUtil::match($gpuHr['version'], $yFWLi)); goto rDe0e; W17ZO: list($AkyhD, $yFWLi) = VersionUtil::parse($uzl5U); goto MjQzJ; CtN9d: $gpuHr = ModuleManager::getModuleBasic($AkyhD); goto Y8tY3; MjQzJ: if (!isset($Fkq2W[$AkyhD])) { continue; } goto CtN9d; rDe0e: } } goto j9cZT; lshWa: if (method_exists(ModuleManager::class, 'getEnv')) { $r0nrL = ModuleManager::getEnv(); BizException::throwsIf(L('Module %s:%s compatible with env %s, current is %s', $C1S_N, $tKVmk['version'], join(',', $tKVmk['env']), $r0nrL), !in_array($r0nrL, $tKVmk['env'])); } goto pNwCe; SCwCw: if (!isset($Fkq2W[$C1S_N])) { $Fkq2W[$C1S_N] = array('isSystem' => ModuleManager::isSystemModule($C1S_N), 'enable' => false, 'config' => array()); ModuleManager::saveUserInstalledModules($Fkq2W); } goto Kga_7; Kbe6S: if (PHP_VERSION_ID >= 80000) { Event::dispatch($bZKZ0); } else { Event::fire($bZKZ0); } goto vj0oM; csJ2t: ModuleManager::callHook($C1S_N, 'hookInstalled'); goto vvyr0; WxtDI: $this->publishRoot($C1S_N); goto SCwCw; pNwCe: foreach ($tKVmk['require'] as $uB6cD) { goto Lh3CN; Lh3CN: list($AkyhD, $yFWLi) = VersionUtil::parse($uB6cD); goto nOqIq; g926r: $gpuHr = ModuleManager::getModuleBasic($AkyhD); goto VYqHS; nOqIq: BizException::throwsIf(L('Module %s:%s depend on %s:%s, install fail', $C1S_N, $tKVmk['version'], $AkyhD, $yFWLi), !isset($Fkq2W[$AkyhD])); goto g926r; VYqHS: BizException::throwsIf(L('Module %s:%s depend on %s:%s, install fail', $C1S_N, $tKVmk['version'], $AkyhD, $yFWLi), !VersionUtil::match($gpuHr['version'], $yFWLi)); goto VHCrv; VHCrv: } goto bhunD; piNef: $bZKZ0->name = $C1S_N; goto Kbe6S; Mkj9P: BizException::throwsIf('Module basic empty', !$tKVmk); goto spVHy; f4CAJ: $this->publishAsset($C1S_N); goto WxtDI; Kga_7: ModStart::clearCache(); goto csJ2t; DytBr: $C1S_N = $this->argument('module'); goto W60Zn; spVHy: BizException::throwsIf(L('Module %s:%s depends on ModStart:%s, install fail', $C1S_N, $tKVmk['version'], $tKVmk['modstartVersion']), !VersionUtil::match(ModStart::$version, $tKVmk['modstartVersion'])); goto lshWa; bUYrq: } private function migrate($C1S_N) { goto jtc0Q; yjdhu: $this->call('migrate', array('--path' => ModuleManager::relativePath($C1S_N, 'Migrate'), '--force' => true)); goto Qgs7G; jtc0Q: $hCl98 = ModuleManager::path($C1S_N, 'Migrate'); goto ddLOL; i1Kev: $this->info('Module Migrate Success'); goto yjdhu; ddLOL: if (!file_exists($hCl98)) { return; } goto i1Kev; Qgs7G: } private function publishRoot($C1S_N) { goto bvCBq; iTHSw: $p3nw5 = 0; goto oF4_L; BjXwb: $a3n3M = FileUtil::listAllFiles($oQtao); goto ZhVqK; ZhVqK: $a3n3M = array_filter($a3n3M, function ($Z3orD) { return $Z3orD['isFile']; }); goto iTHSw; oF4_L: foreach ($a3n3M as $Z3orD) { goto YjI4J; XsjFl: if (!file_exists($XuDmz) || md5_file($XuDmz) != file_get_contents($Z3orD['pathname'])) { goto f3iYl; ZHbxy: file_put_contents($XuDmz, file_get_contents($Z3orD['pathname'])); goto W19nV; cqQz6: $p3nw5++; goto Fy32m; f3iYl: FileUtil::ensureFilepathDir($XuDmz); goto ZHbxy; W19nV: if (!file_exists($v_BtY)) { file_put_contents($v_BtY, '__MODSTART_EMPTY_FILE__'); } goto cqQz6; Fy32m: } goto Dq3_B; Jibbk: $XuDmz = base_path($uPgOC); goto FpOs0; HEVTk: if (file_exists($XuDmz) && !file_exists($v_BtY)) { rename($XuDmz, $v_BtY); $this->info("Module Root Publish : {$uPgOC} -> {$s3cfo}"); } goto XsjFl; fuzqd: $s3cfo = $uPgOC . '._delete_.' . $C1S_N; goto Jibbk; FpOs0: $v_BtY = $XuDmz . '._delete_.' . $C1S_N; goto HEVTk; YjI4J: $uPgOC = $Z3orD['filename']; goto fuzqd; Dq3_B: } goto qVG4u; bvCBq: $oQtao = ModuleManager::path($C1S_N, 'ROOT'); goto etmHn; qVG4u: $this->info("Module Root Publish : {$p3nw5} item(s)"); goto qGY_f; etmHn: if (!file_exists($oQtao)) { return; } goto BjXwb; qGY_f: } private function publishAsset($C1S_N) { goto lt0Vz; Az7LG: $u1YEC = $this->option('link-asset'); goto P8_oq; lt0Vz: $PFyFc = $this->option('force'); goto Az7LG; UsSy5: if (!file_exists($XfNw_)) { return; } goto lpV9y; lpV9y: $oTyWU = public_path("vendor/{$C1S_N}/"); goto DHtHj; MTXpl: if ($u1YEC) { goto nHEsP; Cu2SN: FileUtil::link($KCdFQ, $fgJM5); goto egvqu; ejeid: $V6Vx4 = "vendor/{$C1S_N}"; goto Xfdgx; nHEsP: $atg0D = ModuleManager::relativePath($C1S_N, 'Asset'); goto dTqK1; Xfdgx: $fgJM5 = public_path($V6Vx4); goto Cu2SN; dTqK1: $KCdFQ = ModuleManager::path($C1S_N, 'Asset'); goto ejeid; egvqu: } else { goto ldS0l; fyOqB: $this->info("Module Asset Publish : {$XfNw_} -> {$oTyWU}"); goto aiInF; gflmO: $Mzpvr->copyDirectory($XfNw_, $oTyWU); goto fyOqB; ldS0l: $Mzpvr->deleteDirectory($oTyWU); goto gflmO; aiInF: } goto OCkjH; FpyeW: if (!file_exists(public_path('vendor'))) { @mkdir(public_path('vendor'), 493); } goto MTXpl; DHtHj: if (file_exists($oTyWU) && !$PFyFc) { $this->info('Module Asset Publish : Ignore'); return; } goto FpyeW; P8_oq: $Mzpvr = $this->laravel['files']; goto OYBL2; OYBL2: $XfNw_ = ModuleManager::path($C1S_N, 'Asset') . '/'; goto UsSy5; OCkjH: } }