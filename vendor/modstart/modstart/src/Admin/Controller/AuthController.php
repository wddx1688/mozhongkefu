<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Admin\Controller; use Illuminate\Routing\Controller; use Illuminate\Support\Facades\Session; use ModStart\Admin\Auth\Admin; use ModStart\Admin\Event\AdminUserLoginedEvent; use ModStart\Admin\Event\AdminUserLogoutEvent; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\AgentUtil; use ModStart\Core\Util\StrUtil; use ModStart\Misc\Captcha\CaptchaFacade; class AuthController extends Controller { public function loginCaptcha() { return CaptchaFacade::create('default'); } public function login() { goto mWuiT; XaEnz: if (class_exists(\Module\Vendor\Provider\Captcha\CaptchaProvider::class)) { $nm6HY = \Module\Vendor\Provider\Captcha\CaptchaProvider::get($j1_ZF); if ($nm6HY) { $nm6HY->setParam('biz', 'admin'); } } goto HT3QA; kRvLo: if (Admin::id()) { return Response::redirect($vqlrZ); } goto hVYHX; HT3QA: if (Request::isPost()) { goto yYHXD; ruAkq: Session::forget('_adminUserPasswordWeak'); goto azr25; uHSSx: if ($sSH3e) { } else { goto kCKWV; BL0WM: $mDyAE = $gY_Ck->getTrimString('password'); goto mzPQe; cgntG: if (empty($mDyAE)) { return Response::json(-2, L('Password Required')); } goto ph2O1; mzPQe: if (empty($QKAda)) { return Response::json(-1, L('Username Required')); } goto cgntG; kCKWV: $QKAda = $gY_Ck->getTrimString('username'); goto BL0WM; ph2O1: } goto d8ysH; BPBHo: Admin::addInfoLog($OZBy5['id'], L('Login Success'), array('IP' => Request::ip())); goto yiYq_; azr25: if ($sSH3e) { } else { if (strlen($mDyAE) < 6 && StrUtil::passwordStrength($mDyAE) <= 1) { Session::put('_adminUserPasswordWeak', true); } } goto BPBHo; jmAaA: return Response::redirect($vqlrZ); goto Cng81; yYHXD: $gY_Ck = InputPackage::buildFromInput(); goto G0Vox; czSFQ: $vqlrZ = $gY_Ck->getTrimString('redirect', modstart_admin_url()); goto jmAaA; CGbgR: Session::put(Admin::ADMIN_USER_ID_SESSION_KEY, $OZBy5['id']); goto ruAkq; zlO1A: $OZBy5 = $nMi2c['data']; goto CGbgR; WIIWP: if ($sSH3e) { goto dlQvQ; dlQvQ: $ah8e9 = $nm6HY; goto nt34g; rch18: if ($nMi2c['code']) { Admin::addErrorLog(0, L('Login Error'), array('IP' => Request::ip(), L('Phone') => $QfTuE)); return Response::json(-1, L('登录失败'), null, '[js]$(\'[data-captcha]\').click();'); } goto ZX6ab; HAffJ: $nMi2c = Admin::loginByPhone($QfTuE); goto rch18; nt34g: $QfTuE = $ah8e9->getVerifiedPhone(); goto HAffJ; ZX6ab: } else { $nMi2c = Admin::login($QKAda, $mDyAE); if ($nMi2c['code']) { Admin::addErrorLog(0, L('Login Error'), array('IP' => Request::ip(), L('Username') => $QKAda, L('Password') => '******')); return Response::json(-1, L('Username / Password Incorrect'), null, '[js]$(\'[data-captcha]\').click();'); } } goto zlO1A; yiYq_: AdminUserLoginedEvent::fire($OZBy5['id'], Request::ip(), AgentUtil::getUserAgent()); goto czSFQ; G0Vox: $sSH3e = config('modstart.admin.login.captcha', false) && $nm6HY && $nm6HY->name() == 'sms' && modstart_config('AdminManagerEnhance_SmsCaptchaQuick', false); goto uHSSx; d8ysH: if (config('modstart.admin.login.captcha', false)) { if ($nm6HY) { $nMi2c = $nm6HY->validate(); if (Response::isError($nMi2c)) { return Response::jsonFromGenerate($nMi2c); } } else { if (!CaptchaFacade::check($gY_Ck->getTrimString('captcha'))) { return Response::json(-1, L('Captcha Incorrect'), null, '[js]$(\'[data-captcha]\').click();'); } } } goto WIIWP; Cng81: } goto gfzUK; BM95c: $j1_ZF = modstart_config('AdminManagerEnhance_LoginCaptchaProvider', null); goto ywVW_; hVYHX: if (modstart_config('adminSSOClientEnable', false)) { return Response::redirect(modstart_admin_url('sso/client', array('redirect' => $vqlrZ))); } goto BM95c; mWuiT: $gY_Ck = InputPackage::buildFromInput(); goto iAHNi; iAHNi: $vqlrZ = $gY_Ck->getTrimString('redirect', modstart_admin_url()); goto kRvLo; gfzUK: return view('modstart::admin.login', array('pageTitle' => L('Admin Login'), 'captchaProviderName' => $j1_ZF, 'captchaProvider' => $nm6HY, 'redirect' => $vqlrZ)); goto bLDQ0; ywVW_: $nm6HY = null; goto XaEnz; bLDQ0: } public function loginQuick() { goto C81gq; C81gq: BizException::throwsIf('快速登录未开启', !config('env.ADMIN_LOGIN_QUICK_ENABLE', false)); goto ehxHn; vZ4p9: Admin::addInfoLog($OZBy5['id'], L('Login Success'), array('IP' => Request::ip())); goto iFQ5o; iFQ5o: $vqlrZ = $gY_Ck->getTrimString('redirect', modstart_admin_url()); goto eNtHc; mJM_2: BizException::throwsIf('请求超时', $KriFX < time() - 1800 || $KriFX > time() + 1800); goto vl3FT; eNtHc: return Response::redirect($vqlrZ); goto KbfcR; X6qmC: Session::put(Admin::ADMIN_USER_ID_SESSION_KEY, $OZBy5['id']); goto vZ4p9; vl3FT: $OZBy5 = Admin::get($CeOJi); goto gotav; uBv9B: $UC0zA = md5($CeOJi . ':' . $KriFX . ':' . $OZBy5['password'] . ':' . $OZBy5['passwordSalt']); goto FbGWQ; FbGWQ: BizException::throwsIf('登录失败', $UC0zA != $gY_Ck->getTrimString('sign')); goto X6qmC; ehxHn: $gY_Ck = InputPackage::buildFromInput(); goto rrRgO; gotav: BizException::throwsIfEmpty('登录失败', $OZBy5); goto uBv9B; iKQbR: $KriFX = $gY_Ck->getInteger('ts'); goto mJM_2; rrRgO: $CeOJi = $gY_Ck->getInteger('id'); goto iKQbR; KbfcR: } public function logout() { goto G974Q; YLviS: if (modstart_config('adminSSOClientEnable', false)) { $gY_Ck = InputPackage::buildFromInput(); if ($gY_Ck->getTrimString('server', '') != 'true') { goto Vifyb; Vifyb: $pwjma = modstart_config('adminSSOServer'); goto qBnfj; sm1jj: $deem_ = $pwjma . '_logout?redirect=' . urlencode($Hs576); goto Wd04u; tmIAm: $rq8Ux = $gY_Ck->getTrimString('redirect', '/'); goto L5GwZ; qBnfj: if (empty($pwjma)) { return Response::send(-1, L('Config adminSSOServer missing')); } goto tmIAm; L5GwZ: $Hs576 = Request::domainUrl() . '/logout?server=true&redirect=' . urlencode($rq8Ux); goto sm1jj; Wd04u: return Response::redirect($deem_); goto phS2U; phS2U: } } goto vFGpC; vFGpC: return Response::redirect(modstart_admin_url()); goto DFFar; n9VIx: Session::forget(Admin::ADMIN_USER_ID_SESSION_KEY); goto Tne2b; Tne2b: AdminUserLogoutEvent::fire($vO92J, Request::ip(), AgentUtil::getUserAgent()); goto YLviS; G974Q: $vO92J = Admin::id(); goto n9VIx; DFFar: } public function ssoClient() { goto o8jlR; KSw0f: $jX2xL = modstart_config('adminSSOClientSecret'); goto JbxBp; JbxBp: if (empty($jX2xL)) { return Response::send(-1, L('Config adminSSOClientSecret missing')); } goto q06sz; Uni90: if ($HCA_O) { goto pbTpm; impUT: if (empty($UC0zA)) { return Response::send(-1, 'Sign required'); } goto zG4Ke; fhghj: if (empty($QKAda)) { return Response::send(-1, '同步登录返回的用户名为空'); } goto W5nDX; pbTpm: $QKAda = @base64_decode($gY_Ck->getTrimString('username')); goto lVTeo; W5nDX: if (empty($UomWP)) { return Response::send(-1, 'Sign required'); } goto impUT; PpnCa: if ($UC0zA != $PORiU) { return Response::send(-1, 'Sign error'); } goto tDD0_; xM5li: Session::put('_adminUserId', $OZBy5['id']); goto Kvg4B; teW8h: if ($HCA_O != $pwjma) { return Response::send(-1, 'Server not match ' . $pwjma); } goto zZxVB; zZxVB: $OZBy5 = Admin::getByUsername($QKAda); goto LUhYO; lVTeo: $UomWP = $gY_Ck->getTrimString('timestamp'); goto Ph61d; Ph61d: $UC0zA = $gY_Ck->getTrimString('sign'); goto fhghj; LUhYO: if (empty($OZBy5)) { $OZBy5 = Admin::add($QKAda, null, true); $OZBy5 = Admin::get($OZBy5['id']); } goto xM5li; Kvg4B: $ZExTH = Session::get('adminSSORedirect', null); goto Xy6A4; zG4Ke: $PORiU = md5(md5($jX2xL) . md5($UomWP . '') . md5($HCA_O) . md5($QKAda)); goto PpnCa; N0IIM: return Response::redirect($ZExTH); goto Lb40K; Xy6A4: if (empty($ZExTH)) { return Response::send(0, 'Login success, adminSSORedirect missing'); } goto N0IIM; tDD0_: if (abs(time() - $UomWP) > 2400 * 2600) { return Response::send(-1, 'Timestamp error'); } goto teW8h; Lb40K: } else { goto p2jcT; WfM4z: $UC0zA = md5(md5($jX2xL) . md5($UomWP . '') . md5($kJtgn)); goto M6h2J; ghu3r: Session::put('adminSSORedirect', $vqlrZ); goto hMtC0; M6h2J: $vqlrZ = $pwjma . '?client=' . urlencode($kJtgn) . '&timestamp=' . $UomWP . '&sign=' . $UC0zA; goto Wjejn; Wjejn: return Response::redirect($vqlrZ); goto IFcTg; u9vUA: $UomWP = time(); goto WfM4z; hMtC0: $kJtgn = Request::domainUrl() . modstart_admin_url('sso/client'); goto u9vUA; p2jcT: $vqlrZ = trim($gY_Ck->getTrimString('redirect')); goto ghu3r; IFcTg: } goto HBiTk; DzxyQ: $HCA_O = $gY_Ck->getTrimString('server'); goto Uni90; o8jlR: if (!modstart_config('adminSSOClientEnable', false)) { return Response::send(-1, L('Config adminSSOClientEnable disabled')); } goto rLxEA; s4_8F: if (empty($pwjma)) { return Response::send(-1, L('Config adminSSOServer missing')); } goto KSw0f; q06sz: $gY_Ck = InputPackage::buildFromInput(); goto DzxyQ; rLxEA: $pwjma = modstart_config('adminSSOServer', ''); goto s4_8F; HBiTk: } public function ssoServer() { goto Oo2wu; vOJXF: if (Session::get('_adminUserId', 0)) { return Response::redirect(modstart_admin_url('sso/server_success')); } goto sGA4S; N5lBZ: if (!$Kbf3b) { return Response::send(-1, 'server client missing : ' . $kJtgn); } goto DSRzm; drTmo: $Dums2 = explode('
', modstart_config('adminSSOClientList', '')); goto YFfcY; l2EDb: $kJtgn = trim($gY_Ck->getTrimString('client')); goto yAtg9; XTh4f: if (!modstart_config('adminSSOServerEnable', false)) { return Response::send(-1, 'adminSSOServerEnable disabled'); } goto Pb2kh; hsoxF: $PORiU = md5(md5($jX2xL) . md5($UomWP . '') . md5($kJtgn)); goto hh0ST; jaOYe: foreach ($Dums2 as $DUr2V) { if (trim($DUr2V) == $kJtgn) { $Kbf3b = true; } } goto N5lBZ; IoQtd: if (empty($kJtgn)) { return Response::send(-1, 'client empty'); } goto hX34K; DSRzm: Session::put('adminSSOClient', $kJtgn); goto vOJXF; Pb2kh: $jX2xL = modstart_config('adminSSOServerSecret'); goto P3o3h; hh0ST: if ($UC0zA != $PORiU) { return Response::send(-1, 'sign error'); } goto zRCJ9; yAtg9: $UomWP = intval($gY_Ck->getTrimString('timestamp')); goto UHIQE; nNvC3: if (empty($UC0zA)) { return Response::send(-1, 'sign empty'); } goto XTh4f; P3o3h: if (empty($jX2xL)) { return Response::send(-1, 'adminSSOServerSecret missing'); } goto hsoxF; UHIQE: $UC0zA = trim($gY_Ck->getTrimString('sign')); goto IoQtd; sGA4S: return Response::redirect(modstart_admin_url('login?redirect=' . urlencode(modstart_admin_url('sso/server_success')))); goto PoMrU; zRCJ9: if (abs(time() - $UomWP) > 2400 * 2600) { return Response::send(-1, 'timestamp error'); } goto drTmo; hX34K: if (empty($UomWP)) { return Response::send(-1, 'timestamp empty'); } goto nNvC3; Oo2wu: $gY_Ck = InputPackage::buildFromInput(); goto l2EDb; YFfcY: $Kbf3b = false; goto jaOYe; PoMrU: } public function ssoServerSuccess() { goto hQZIl; F95YW: $UC0zA = md5(md5($jX2xL) . md5($UomWP . '') . md5($HCA_O) . md5($QKAda)); goto QU9XN; hQZIl: if (!Session::get('_adminUserId', 0)) { return Response::redirect(modstart_admin_url('login?redirect=' . urlencode(modstart_admin_url('sso/server_success')))); } goto eo3LA; MEC_2: $vqlrZ = $hotYx . '?server=' . urlencode($HCA_O) . '&timestamp=' . $UomWP . '&username=' . urlencode(base64_encode($QKAda)) . '&sign=' . $UC0zA; goto sK8FA; w7hCW: if (empty($jX2xL)) { return Response::send(-1, 'adminSSOServerSecret missing'); } goto QDHmn; TbMaL: if (empty($hotYx)) { return Response::send(0, 'adminSSOClient missing'); } goto pLa8q; k1Z2m: $QKAda = $OZBy5['username']; goto F95YW; sK8FA: return Response::redirect($vqlrZ); goto S2LRp; eo3LA: $OZBy5 = Admin::get(Session::get('_adminUserId', 0)); goto lkcWM; QU9XN: $hotYx = Session::get('adminSSOClient', ''); goto TbMaL; lkcWM: $jX2xL = modstart_config('adminSSOServerSecret'); goto w7hCW; QDHmn: $HCA_O = Request::domainUrl() . modstart_admin_url('sso/server'); goto wtjd0; pLa8q: Session::forget('adminSSOClient', $hotYx); goto MEC_2; wtjd0: $UomWP = time(); goto k1Z2m; S2LRp: } public function ssoServerLogout() { goto gCGDI; VdmsP: $vqlrZ = $gY_Ck->getTrimString('redirect', modstart_admin_url()); goto fIk1x; fIk1x: return Response::redirect($vqlrZ); goto nAN6P; gCGDI: $gY_Ck = InputPackage::buildFromInput(); goto QfyBY; QfyBY: Session::forget('_adminUserId'); goto VdmsP; nAN6P: } }