<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Admin\Controller; use Illuminate\Routing\Controller; use Illuminate\Support\Facades\Artisan; use Illuminate\Support\Str; use ModStart\Admin\Auth\Admin; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Layout\AdminDialogPage; use ModStart\Core\Dao\DynamicModel; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\RandomUtil; use ModStart\Form\Form; use ModStart\ModStart; class SystemController extends Controller { public function clearCache() { goto B0ZYT; UAke7: $hmkXe = Artisan::call('view:clear'); goto uJlR4; eEuT4: $hmkXe = Artisan::call('cache:clear'); goto mypp7; B0ZYT: AdminPermission::demoCheck(); goto P_Puu; KGi2Y: Admin::addInfoLog(Admin::id(), L('Clear Cache')); goto eEuT4; mypp7: if (0 != $hmkXe) { return Response::send(-1, L('Clear Cache') . ' ' . L('Error') . " cache:clear ExitCode({$hmkXe})"); } goto UAke7; uJlR4: if (0 != $hmkXe) { return Response::send(-1, L('Clear Cache') . ' ' . L('Error') . " view:clear ExitCode({$hmkXe})"); } goto YnrDU; YnrDU: ModStart::clearCache(); goto wfUPD; P_Puu: AdminPermission::permitCheck('SystemManage'); goto KGi2Y; wfUPD: return Response::jsonSuccess(L('Operate Success')); goto JO6ih; JO6ih: } public function securityFix(AdminDialogPage $mZ5xK) { goto OJztQ; zIP4q: return Response::sendError('Unknown Type'); goto EJDf1; GO3HM: $gY_Ck = InputPackage::buildFromInput(); goto PZirp; kwx6s: switch ($EY7Cx) { case 'installLock': goto eoaGH; EJ8mh: if (!file_exists(storage_path('install.lock'))) { return Response::json(-1, L('Operate Failed')); } goto tv3Tw; zReWG: if (!file_exists(storage_path('install.lock'))) { file_put_contents(storage_path('install.lock'), 'ok'); } goto EJ8mh; tv3Tw: return Response::json(0, L('Operate Success'), null, '[reload]'); goto tPmaN; eoaGH: AdminPermission::demoCheck(); goto zReWG; tPmaN: case 'installScript': goto irblk; irblk: AdminPermission::demoCheck(); goto If2O6; NiFQA: return Response::json(0, L('Operate Success'), null, '[reload]'); goto MxTmy; If2O6: if (file_exists(public_path('install.php'))) { @unlink(public_path('install.php')); } goto REek2; REek2: if (file_exists(public_path('install.php'))) { return Response::json(-1, L('Operate Failed')); } goto NiFQA; MxTmy: case 'appDebug': goto aB3nb; FyBOu: $N19iJ = preg_replace('/APP_DEBUG\\s*=\\s*true/', 'APP_DEBUG=false', $N19iJ); goto wkVbS; bCrdg: return Response::json(0, L('Operate Success'), null, '[reload]'); goto phUYi; o8lAL: $N19iJ = file_get_contents(base_path('.env')); goto FyBOu; aB3nb: AdminPermission::demoCheck(); goto o8lAL; wkVbS: file_put_contents(base_path('.env'), $N19iJ); goto bCrdg; phUYi: case 'adminPath': goto EYnuP; GULj4: $c9K5c->showSubmit(false)->showReset(false); goto hfuQd; T0kGr: return $mZ5xK->pageTitle(L('Change Admin Url'))->body($c9K5c); goto gp6qW; qgQ1G: $c9K5c->text('newPath', L('New Path'))->rules('required')->value('/admin_' . RandomUtil::lowerReadableString(6) . '/'); goto GULj4; hfuQd: if (Request::isPost()) { return $c9K5c->formRequest(function (Form $c9K5c) { AdminPermission::demoCheck(); $nx179 = $c9K5c->dataForming(); $aL4Ms = $nx179['newPath']; if (!Str::startsWith($aL4Ms, '/') || !Str::endsWith($aL4Ms, '/')) { return Response::generateError(L('Url must start with / and end with /')); } if (!preg_match('/^\\/[a-zA-Z0-9_]+\\/$/', $aL4Ms)) { return Response::generateError(L('Admin url only contains a-zA-Z0-9_')); } $N19iJ = file_get_contents(base_path('.env')); $N19iJ = preg_replace('/ADMIN_PATH\\s*=\\s*.*?\\n/', "ADMIN_PATH={$aL4Ms}\n", $N19iJ); try { file_put_contents(base_path('.env'), $N19iJ); return Response::json(0, L('Operate Success'), null, '[js]parent.location.href="' . $aL4Ms . '"'); } catch (\Exception $l8i0J) { return Response::jsonError(L('No Permission')); } }); } goto T0kGr; br3TN: $c9K5c->text('oldPath', L('Current Path'))->rules('required')->value(config('env.ADMIN_PATH', '/admin/'))->readonly(true); goto qgQ1G; EYnuP: $c9K5c = new Form(DynamicModel::class); goto br3TN; gp6qW: } goto zIP4q; PZirp: $EY7Cx = $gY_Ck->getTrimString('type'); goto kwx6s; OJztQ: AdminPermission::permitCheck('SystemManage'); goto GO3HM; EJDf1: } }