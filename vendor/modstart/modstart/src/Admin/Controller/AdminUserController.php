<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Admin\Controller; use Illuminate\Routing\Controller; use Illuminate\Support\Str; use ModStart\Admin\Auth\Admin; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Concern\HasAdminCRUD; use ModStart\Admin\Model\AdminUser; use ModStart\Admin\Provider\AdminUserConfigProvider; use ModStart\Core\Exception\BizException; use ModStart\Core\Util\ConvertUtil; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Core\Util\RenderUtil; use ModStart\Detail\Detail; use ModStart\Field\AbstractField; use ModStart\Form\Form; use ModStart\Grid\Displayer\ItemOperate; use ModStart\Grid\Grid; use ModStart\Grid\GridFilter; class AdminUserController extends Controller { use HasAdminCRUD; protected function grid() { goto aHIXZ; Rl_sm: return $h7Rk_; goto Naje1; WWHDd: $h7Rk_->title(L('Admin User')); goto Rl_sm; tbBRT: if (AdminPermission::isNotPermit('AdminUserManage')) { $h7Rk_->canAdd(false)->canEdit(false)->canDelete(false); } goto WWHDd; aHIXZ: $h7Rk_ = new Grid(AdminUser::class, function (Grid $h7Rk_) { $h7Rk_->display('id', L('ID'))->sortable(true)->width(80); $h7Rk_->text('username', L('Username')); if (modstart_config('AdminManagerEnhance_EnablePhone', false)) { $h7Rk_->text('phone', L('Phone')); } if (modstart_config('AdminManagerEnhance_EnableEmail', false)) { $h7Rk_->text('email', L('Email')); } $h7Rk_->tags('roles', L('Roles'))->hookFormatValue(function ($VuXfH, AbstractField $dBa7F) { $DUr2V = $dBa7F->item(); if (AdminPermission::isFounder($DUr2V->id)) { return array(L('Admin Founder')); } return collect($VuXfH)->pluck('name')->toArray(); }); if (!AdminUserConfigProvider::isEmpty()) { $h7Rk_->display('config', '配置')->hookRendering(function (AbstractField $dBa7F, $DUr2V, $kOFY1) { return RenderUtil::view('modstart::admin.user.configGrid', array('item' => $DUr2V)); }); } $h7Rk_->text('lastLoginTime', L('Last Login Time')); $h7Rk_->text('lastLoginIp', L('Last Login Ip')); $h7Rk_->gridFilter(function (GridFilter $AKg7l) { $AKg7l->eq('id', L('ID')); $AKg7l->like('username', L('Username')); }); $h7Rk_->hookItemOperateRendering(function (ItemOperate $g5pbU) { if (AdminPermission::isFounder($g5pbU->item()->id)) { $g5pbU->canDelete(false); } }); }); goto tbBRT; Naje1: } protected function form() { goto ND8A2; aPcLg: return $c9K5c; goto Af9pS; XjZbM: $c9K5c->title(L('Admin User')); goto aPcLg; ND8A2: $c9K5c = new Form(AdminUser::class, function (Form $c9K5c) { $c9K5c->text('username', L('Username'))->required()->rules('unique:admin_user,username,' . CRUDUtil::id()); $c9K5c->text('password', L('Password'))->rules($c9K5c->isModeAdd() ? 'required' : '')->placeholder($c9K5c->isModeAdd() ? '' : L('Keep Old Password If Empty'))->value($c9K5c->isModeAdd() ? RandomUtil::string(6) : '')->hookFormatValue(function ($VuXfH, AbstractField $dBa7F) { return ''; }); if (modstart_config('AdminManagerEnhance_EnablePhone', false)) { $c9K5c->text('phone', L('Phone'))->ruleUnique('admin_user'); } if (modstart_config('AdminManagerEnhance_EnableEmail', false)) { $c9K5c->text('email', L('Email'))->ruleUnique('admin_user'); } $DUr2V = $c9K5c->item(); $M883m = $c9K5c->checkbox('roles', L('Roles'))->optionModel('admin_role')->hookValueUnserialize(function ($VuXfH, AbstractField $dBa7F) { return $VuXfH->map(function ($d6C3Y) { return $d6C3Y['id']; }); })->hookValueSerialize(function ($VuXfH, AbstractField $dBa7F) { return ConvertUtil::toArray($VuXfH); }); if ($c9K5c->isModeEdit() && AdminPermission::isFounder($DUr2V->id)) { $M883m->editable(false); } if (!AdminUserConfigProvider::isEmpty()) { $c9K5c->display('config', '配置')->hookRendering(function (AbstractField $dBa7F, $DUr2V, $kOFY1) { return RenderUtil::view('modstart::admin.user.configForm', array('item' => $DUr2V)); })->formShowOnly(true); } $c9K5c->display('created_at', L('Created At'))->editable(true); $c9K5c->hookSaving(function (Form $c9K5c) { if ($c9K5c->isModeAdd()) { goto FIWRA; Q_gTV: $nx179['password'] = Admin::passwordEncrypt($nx179['password'], $nx179['passwordSalt']); goto IvaIE; vPzsc: $nx179['passwordSalt'] = Str::random(16); goto Q_gTV; IvaIE: $c9K5c->dataAdding($nx179); goto qw_6_; FIWRA: $nx179 = $c9K5c->dataAdding(); goto vPzsc; qw_6_: } else { if ($c9K5c->isModeEdit()) { goto WHwgg; WHwgg: $nx179 = $c9K5c->dataEditing(); goto b4t6S; b4t6S: if ($nx179['password']) { $nx179['passwordSalt'] = Str::random(16); $nx179['password'] = Admin::passwordEncrypt($nx179['password'], $nx179['passwordSalt']); } else { unset($nx179['password']); } goto I8V6S; I8V6S: $c9K5c->dataEditing($nx179); goto Xc1kC; Xc1kC: } } }); $c9K5c->hookDeleting(function (Form $c9K5c) { $c9K5c->item()->each(function ($DUr2V) { if (AdminPermission::isFounder($DUr2V->id)) { BizException::throws(L('Admin Founder Delete Forbidden')); } }); }); $c9K5c->hookSaved(function (Form $c9K5c) { $DUr2V = $c9K5c->item(); foreach (AdminUserConfigProvider::listAll() as $xqqfG) { $xqqfG->saved($DUr2V); } }); $c9K5c->hookDeleted(function (Form $c9K5c) { $c9K5c->item()->each(function ($DUr2V) { foreach (AdminUserConfigProvider::listAll() as $xqqfG) { $xqqfG->deleted($DUr2V); } }); }); }); goto E0XS4; E0XS4: if (AdminPermission::isNotPermit('AdminUserManage')) { $c9K5c->canAdd(false)->canEdit(false)->canDelete(false); } goto XjZbM; Af9pS: } protected function detail() { goto J3DD1; UlxCO: return $LT01t; goto CEoRZ; J3DD1: $LT01t = new Detail(AdminUser::class, function (Detail $LT01t) { $LT01t->display('id', L('ID')); $LT01t->text('username', L('Username')); if (modstart_config('AdminManagerEnhance_EnablePhone', false)) { $LT01t->text('phone', L('Phone')); } if (modstart_config('AdminManagerEnhance_EnableEmail', false)) { $LT01t->text('email', L('Email')); } $LT01t->tags('roles', L('Roles'))->hookFormatValue(function ($VuXfH, AbstractField $dBa7F) { $DUr2V = $dBa7F->item(); if (AdminPermission::isFounder($DUr2V->id)) { return array(L('Admin Founder')); } return collect($VuXfH)->pluck('name')->toArray(); }); if (!AdminUserConfigProvider::isEmpty()) { $LT01t->display('config', '配置')->hookRendering(function (AbstractField $dBa7F, $DUr2V, $kOFY1) { return RenderUtil::view('modstart::admin.user.configDetail', array('item' => $DUr2V)); }); } $LT01t->display('created_at', L('Created At')); $LT01t->display('updated_at', L('Updated At')); }); goto twqKj; twqKj: $LT01t->title(L('Admin User')); goto UlxCO; CEoRZ: } }