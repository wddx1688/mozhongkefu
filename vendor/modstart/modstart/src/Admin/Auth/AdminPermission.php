<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace ModStart\Admin\Auth; use Illuminate\Support\Facades\Session; use Illuminate\Support\Str; use ModStart\Admin\Config\AdminConfig; use ModStart\Admin\Config\AdminMenu; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; class AdminPermission { public static function demoPostCheck() { if (self::isDemo() && Request::isPost()) { Response::quit(-1, L('Operate Forbidden For Demo Account')); } } public static function demoCheck() { if (self::isDemo()) { Response::quit(-1, L('Operate Forbidden For Demo Account')); } } public static function demoResponse() { return Response::send(-1, L('Operate Forbidden For Demo Account')); } public static function permitCheck($nmYJC) { if (!self::permit($nmYJC)) { Response::quit(-1, L('No Permission')); } } public static function isDemo() { return Admin::id() === self::demoId(); } public static function demoId() { return intval(AdminConfig::get('demoId', 0)); } public static function isFounder($vO92J) { return self::founderId() === $vO92J; } public static function founderId() { return intval(AdminConfig::get('founderId', 1)); } public static function isUrlAction($ikc2A) { if (empty($ikc2A)) { return false; } return preg_match('/^[\\w\\\\]+@[\\w]+$/', $ikc2A); } public static function urlToLink($ikc2A) { goto veHiL; fa7t1: return $ikc2A; goto YenE0; veHiL: if (empty($ikc2A)) { return 'javascript:;'; } goto aMDz3; aMDz3: if (self::isUrlAction($ikc2A)) { return action($ikc2A); } goto fa7t1; YenE0: } private static function mergeMenuTree($Kv8qO, $OFAbu = '', $tale9 = false) { goto O8thJ; FZ3qu: return $owLu9; goto ZaLCK; ni8X1: foreach ($Kv8qO as $dKmL2 => $yFWLi) { goto yYe7F; ntea1: if (empty($DUr2V['children'])) { unset($DUr2V['children']); } goto tPOSa; HeOjH: $DUr2V['children'] = self::mergeMenuTree($Kv8qO, $dKmL2 . '^^', $tale9); goto ntea1; vvmlo: if ($OFAbu) { if (!Str::startsWith($dKmL2, $OFAbu)) { continue; } if (count(explode('^^', $OFAbu)) !== count(explode('^^', $dKmL2))) { continue; } } else { if (1 != count($cZS6f)) { continue; } } goto wPVxF; tPOSa: if (!$tale9) { if (empty($DUr2V['children']) && empty($DUr2V['url'])) { continue; } } else { if (empty($DUr2V['children']) && empty($DUr2V['rule'])) { continue; } } goto TamEL; wPVxF: $DUr2V = $yFWLi; goto HeOjH; qLVki: $cZS6f = explode('^^', $dKmL2); goto vvmlo; yYe7F: if ($dKmL2 === $OFAbu) { continue; } goto qLVki; TamEL: $owLu9[] = $DUr2V; goto m9rPM; m9rPM: } goto FZ3qu; O8thJ: $owLu9 = array(); goto ni8X1; ZaLCK: } private static function sort() { static $YbS73 = 10000; return $YbS73++; } private static function mergeMenu($nkyXz, $OFAbu = '', $mzw8d = 1, $AKg7l = null, $tale9 = false) { goto xTH91; r5rF8: foreach ($nkyXz as $DUr2V) { goto PdFf3; PdFf3: if (empty($DUr2V)) { continue; } goto Co0_f; Co0_f: if ($AKg7l) { if (!call_user_func($AKg7l, $DUr2V)) { continue; } } goto BBQF3; iYzsN: if (!isset($Kv8qO[$dKmL2])) { $Kv8qO[$dKmL2] = $DUr2V; } goto HMHHa; nPGzg: if (1 == $mzw8d) { $dKmL2 = $OFAbu . $DUr2V['title'] . '^' . $DUr2V['icon'] . '^' . $DUr2V['sort']; } else { $dKmL2 = $OFAbu . $DUr2V['title']; } goto h6AxP; agp0r: if (!isset($DUr2V['hide'])) { $DUr2V['hide'] = false; } goto Jyc7l; BBQF3: if (!isset($DUr2V['sort'])) { $DUr2V['sort'] = self::sort(); } goto nPGzg; h6AxP: if (!isset($DUr2V['rule'])) { if (isset($DUr2V['url'])) { $DUr2V['rule'] = $DUr2V['url']; } else { $DUr2V['rule'] = ''; } } goto agp0r; Jyc7l: if (isset($DUr2V['icon'])) { if (preg_match('/^[a-zA-Z0-9\\-]+$/', $DUr2V['icon'])) { $DUr2V['icon'] = "<i class='icon iconfont icon-{$DUr2V['icon']}'></i>"; } } goto iYzsN; HMHHa: unset($Kv8qO[$dKmL2]['children']); goto afnuU; afnuU: if (!empty($DUr2V['children'])) { $Kv8qO = array_merge($Kv8qO, self::mergeMenu($DUr2V['children'], $dKmL2 . '^^', $mzw8d + 1, $AKg7l, $tale9)); } goto WjlBb; WjlBb: } goto jsIPm; SvCWQ: return $Kv8qO; goto vM26b; hJAfF: $Kv8qO = array(); goto r5rF8; jsIPm: if ($mzw8d == 1) { uasort($Kv8qO, function ($Z8OEc, $hc1S8) { return $Z8OEc['sort'] - $hc1S8['sort']; }); return self::mergeMenuTree($Kv8qO, '', $tale9); } goto SvCWQ; xTH91: if (empty($nkyXz)) { return array(); } goto hJAfF; vM26b: } private static function menuClean($nkyXz, $ZjsO5) { goto yqTDL; h346H: return $VseYi; goto hyNtL; yqTDL: $VseYi = array(); goto Ul8YI; Ul8YI: foreach ($nkyXz as $DUr2V) { goto fDFjf; e0Aio: if (!empty($DUr2V['children'])) { $DUr2V['children'] = self::menuClean($DUr2V['children'], $ZjsO5); } goto piS0z; fDFjf: if (!empty($DUr2V['url'])) { if (in_array($DUr2V['url'], $ZjsO5)) { continue; } } goto e0Aio; piS0z: $VseYi[] = $DUr2V; goto cETQB; cETQB: } goto h346H; hyNtL: } private static function flatMenuUrl($nkyXz) { goto D0lNJ; D0lNJ: $gohhz = array(); goto BWN6f; BWN6f: foreach ($nkyXz as $DUr2V) { if (!empty($DUr2V['url'])) { $gohhz[] = $DUr2V['url']; } if (!empty($DUr2V['children'])) { $gohhz = array_merge($gohhz, self::flatMenuUrl($DUr2V['children'])); } } goto fMjUH; fMjUH: return $gohhz; goto rq1aU; rq1aU: } public static function menuAll(\Closure $AKg7l = null, $tale9 = false) { goto FsGRE; UeE1A: $ed0LA = modstart_config()->getArray('adminMenuCustom', array()); goto ZwBz6; I59bE: $ZQzxD = array_merge($ed0LA, $x2YWA); goto uK1dK; N8O8X: $NABjp = AdminMenu::get(); goto vbUyG; ZwBz6: $wiBXy = self::flatMenuUrl($ed0LA); goto H1sdq; LznsI: return $nkyXz; goto CUROB; vbUyG: $ZQzxD = array_merge($nkyXz, $NABjp); goto UeE1A; H1sdq: $x2YWA = self::menuClean($ZQzxD, $wiBXy); goto I59bE; uK1dK: $nkyXz = self::mergeMenu($ZQzxD, '', 1, $AKg7l, $tale9); goto LznsI; FsGRE: $nkyXz = AdminConfig::get('menu', array()); goto N8O8X; CUROB: } public static function menu($olB1g, $nkyXz = null) { goto QaI1I; vo8jI: if (null === $nkyXz) { $nkyXz = self::menuAll(); } goto hxOyo; Vkmyk: if (null === $XL92Z) { $XL92Z = Request::currentPageUrl(); } goto vo8jI; Ezn2G: return $JI7d9; goto DXsj_; hxOyo: if (empty($nkyXz)) { return array(); } goto yPzJx; v9UHZ: foreach ($nkyXz as $dKmL2 => $yFWLi) { if (!empty($yFWLi['hide'])) { continue; } if (empty($yFWLi['children'])) { if ($olB1g === $yFWLi['url'] || $XL92Z === $yFWLi['url'] || ends_with($XL92Z, $yFWLi['url']) || !empty($yFWLi['active']) && in_array($olB1g, $yFWLi['active'])) { $yFWLi['_active'] = true; } if (self::permit($yFWLi['rule'])) { $JI7d9[] = $yFWLi; } } else { goto KfOTe; KfOTe: $yFWLi['children'] = self::menu($olB1g, $yFWLi['children']); goto XLMri; zgImz: if (!empty($yFWLi['children']) || $yFWLi['rule'] && self::permit($yFWLi['rule'])) { $JI7d9[] = $yFWLi; } goto Ejo9d; XLMri: foreach ($yFWLi['children'] as $S_rOV) { if (!empty($S_rOV['_active'])) { $yFWLi['_active'] = true; break; } } goto zgImz; Ejo9d: } } goto Ezn2G; yPzJx: $JI7d9 = array(); goto v9UHZ; QaI1I: static $XL92Z = null; goto Vkmyk; DXsj_: } public static function isNotPermit($nmYJC) { return !self::permit($nmYJC); } public static function permit($nmYJC) { goto rxODX; AiDtp: static $OZBy5 = null; goto qpC30; rxODX: static $XXPOj = null; goto AiDtp; iXzWQ: if (!isset($XXPOj[$nmYJC])) { return false; } goto PU160; qpC30: if (null === $XXPOj) { $XXPOj = Session::get('_adminRules'); $OZBy5 = Session::get('_adminUser'); } goto iXzWQ; PU160: return $XXPOj[$nmYJC]['auth'] ? true : false; goto No419; No419: } public static function rules($nkyXz = null) { goto G0rIE; xPSNB: foreach ($nkyXz as $dQenb) { if (!empty($dQenb['rule'])) { $UgWZQ[$dQenb['rule']] = array('url' => isset($dQenb['url']) ? $dQenb['url'] : '', 'rule' => $dQenb['rule']); } if (!empty($dQenb['children'])) { $UgWZQ = array_merge($UgWZQ, self::rules($dQenb['children'])); } } goto GQEGM; F3akm: $UgWZQ = array(); goto xPSNB; eKq02: if (empty($nkyXz)) { return array(); } goto F3akm; G0rIE: if (null === $nkyXz) { goto wNBpr; D3Vfh: $NABjp = AdminMenu::get(); goto ANfCc; wNBpr: $nkyXz = AdminConfig::get('menu', array()); goto D3Vfh; ANfCc: $nkyXz = self::mergeMenu(array_merge($nkyXz, $NABjp), '', 1, null, true); goto iEu6g; iEu6g: } goto eKq02; GQEGM: return $UgWZQ; goto krPLR; krPLR: } }